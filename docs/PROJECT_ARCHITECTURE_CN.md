# é¡¹ç›®æŠ€æœ¯æ¶æ„è¯¦è§£

# Notes Application é¡¹ç›®æ¶æ„æ–‡æ¡£

> **ç‰ˆæœ¬**: v0.2  
> **æ›´æ–°æ—¶é—´**: 2025å¹´6æœˆ3æ—¥
> **æ–‡æ¡£ç±»å‹**: æŠ€æœ¯æ¶æ„æŒ‡å— 

## ğŸ“‹ ç›®å½•å¯¼èˆª

### ğŸ—ï¸ æ¶æ„åŸºç¡€
- [1. æ•´ä½“æ¶æ„æ¦‚è§ˆ](#1-æ•´ä½“æ¶æ„æ¦‚è§ˆ)
  - [1.1 æ¶æ„è®¾è®¡åŸåˆ™](#11-æ¶æ„è®¾è®¡åŸåˆ™)
  - [1.2 æŠ€æœ¯æ ˆé€‰æ‹©](#12-æŠ€æœ¯æ ˆé€‰æ‹©)
  - [1.3 é¡¹ç›®ç›®å½•ç»“æ„](#13-é¡¹ç›®ç›®å½•ç»“æ„)

### ğŸ–¥ï¸ å‰ç«¯æ¶æ„
- [2. å‰ç«¯æ¶æ„è®¾è®¡](#2-å‰ç«¯æ¶æ„è®¾è®¡)
  - [2.1 æŠ€æœ¯æ ˆä¸å·¥å…·é“¾](#21-æŠ€æœ¯æ ˆä¸å·¥å…·é“¾)
  - [2.2 ç»„ä»¶æ¶æ„è®¾è®¡](#22-ç»„ä»¶æ¶æ„è®¾è®¡)
  - [2.3 çŠ¶æ€ç®¡ç†ç­–ç•¥](#23-çŠ¶æ€ç®¡ç†ç­–ç•¥)
  - [2.4 è·¯ç”±ä¸å¯¼èˆª](#24-è·¯ç”±ä¸å¯¼èˆª)

### âš™ï¸ åç«¯æ¶æ„
- [3. åç«¯æ¶æ„è®¾è®¡](#3-åç«¯æ¶æ„è®¾è®¡)
  - [3.1 æœåŠ¡æ¶æ„è®¾è®¡](#31-æœåŠ¡æ¶æ„è®¾è®¡)
  - [3.2 APIè®¾è®¡è§„èŒƒ](#32-apiè®¾è®¡è§„èŒƒ)
  - [3.3 æ•°æ®æ¨¡å‹è®¾è®¡](#33-æ•°æ®æ¨¡å‹è®¾è®¡)
  - [3.4 ä¸­é—´ä»¶ä¸æ‹¦æˆªå™¨](#34-ä¸­é—´ä»¶ä¸æ‹¦æˆªå™¨)

### ğŸ”„ äº¤äº’æœºåˆ¶
- [4. å‰åç«¯äº¤äº’æœºåˆ¶](#4-å‰åç«¯äº¤äº’æœºåˆ¶)
  - [4.1 HTTPé€šä¿¡åè®®](#41-httpé€šä¿¡åè®®)
  - [4.2 RESTful APIè®¾è®¡](#42-restful-apiè®¾è®¡)
  - [4.3 æ•°æ®ä¼ è¾“æ ¼å¼](#43-æ•°æ®ä¼ è¾“æ ¼å¼)
  - [4.4 é”™è¯¯å¤„ç†æœºåˆ¶](#44-é”™è¯¯å¤„ç†æœºåˆ¶)

### ğŸ’¾ æ•°æ®ç®¡ç†
- [5. æ•°æ®åº“è®¾è®¡ä¸æ“ä½œ](#5-æ•°æ®åº“è®¾è®¡ä¸æ“ä½œ)
  - [5.1 æ•°æ®åº“é€‰æ‹©ä¸é…ç½®](#51-æ•°æ®åº“é€‰æ‹©ä¸é…ç½®)
  - [5.2 æ•°æ®è¡¨ç»“æ„è®¾è®¡](#52-æ•°æ®è¡¨ç»“æ„è®¾è®¡)
  - [5.3 æ•°æ®æ¨¡å‹å…³ç³»](#53-æ•°æ®æ¨¡å‹å…³ç³»)
  - [5.4 æ•°æ®åº“è¿æ¥ç®¡ç†](#54-æ•°æ®åº“è¿æ¥ç®¡ç†)
  - [5.5 æ•°æ®æŒä¹…åŒ–æ“ä½œ](#55-æ•°æ®æŒä¹…åŒ–æ“ä½œ)

### ğŸ“Š æ•°æ®æµè½¬
- [6. æ•°æ®æµæœºåˆ¶](#6-æ•°æ®æµæœºåˆ¶)
  - [6.1 ç”¨æˆ·æ“ä½œæµç¨‹](#61-ç”¨æˆ·æ“ä½œæµç¨‹)
  - [6.2 å®æ—¶æ•°æ®åŒæ­¥](#62-å®æ—¶æ•°æ®åŒæ­¥)
  - [6.3 ç¼“å­˜ç­–ç•¥](#63-ç¼“å­˜ç­–ç•¥)
  - [6.4 æ•°æ®ä¸€è‡´æ€§ä¿è¯](#64-æ•°æ®ä¸€è‡´æ€§ä¿è¯)

### ğŸš€ æ ¸å¿ƒåŠŸèƒ½
- [7. æ ¸å¿ƒåŠŸèƒ½å®ç°](#7-æ ¸å¿ƒåŠŸèƒ½å®ç°)
  - [7.1 ç¬”è®°CRUDæ“ä½œ](#71-ç¬”è®°crudæ“ä½œ)
  - [7.2 æ–‡ä»¶å¤¹ç®¡ç†åŠŸèƒ½](#72-æ–‡ä»¶å¤¹ç®¡ç†åŠŸèƒ½)
  - [7.3 æ‹–æ‹½æ’åºå®ç°](#73-æ‹–æ‹½æ’åºå®ç°)
  - [7.4 å¯Œæ–‡æœ¬ç¼–è¾‘å™¨é›†æˆ](#74-å¯Œæ–‡æœ¬ç¼–è¾‘å™¨é›†æˆ)
  - [7.5 è‡ªåŠ¨ä¿å­˜æœºåˆ¶](#75-è‡ªåŠ¨ä¿å­˜æœºåˆ¶)

### âš¡ æ€§èƒ½ä¼˜åŒ–
- [8. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#8-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)
  - [8.1 å‰ç«¯æ€§èƒ½ä¼˜åŒ–](#81-å‰ç«¯æ€§èƒ½ä¼˜åŒ–)
  - [8.2 åç«¯æ€§èƒ½ä¼˜åŒ–](#82-åç«¯æ€§èƒ½ä¼˜åŒ–)
  - [8.3 æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–](#83-æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–)
  - [8.4 ç½‘ç»œè¯·æ±‚ä¼˜åŒ–](#84-ç½‘ç»œè¯·æ±‚ä¼˜åŒ–)

### ğŸ”’ å®‰å…¨é˜²æŠ¤
- [9. å®‰å…¨æ€§è€ƒè™‘](#9-å®‰å…¨æ€§è€ƒè™‘)
  - [9.1 è¾“å…¥éªŒè¯ä¸è¿‡æ»¤](#91-è¾“å…¥éªŒè¯ä¸è¿‡æ»¤)
  - [9.2 SQLæ³¨å…¥é˜²æŠ¤](#92-sqlæ³¨å…¥é˜²æŠ¤)
  - [9.3 XSSæ”»å‡»é˜²æŠ¤](#93-xssæ”»å‡»é˜²æŠ¤)
  - [9.4 CSRFé˜²æŠ¤æœºåˆ¶](#94-csrfé˜²æŠ¤æœºåˆ¶)

### ğŸš€ éƒ¨ç½²è¿ç»´
- [10. éƒ¨ç½²ä¸è¿ç»´](#10-éƒ¨ç½²ä¸è¿ç»´)
  - [10.1 å¼€å‘ç¯å¢ƒé…ç½®](#101-å¼€å‘ç¯å¢ƒé…ç½®)
  - [10.2 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²](#102-ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²)
  - [10.3 Dockerå®¹å™¨åŒ–éƒ¨ç½²](#103-dockerå®¹å™¨åŒ–éƒ¨ç½²)
  - [10.4 ç›‘æ§ä¸æ—¥å¿—ç®¡ç†](#104-ç›‘æ§ä¸æ—¥å¿—ç®¡ç†)

### ğŸ“ˆ é¡¹ç›®æ€»ç»“
- [11. é¡¹ç›®æ€»ç»“ä¸æŠ€æœ¯æŒ‡æ ‡](#11-é¡¹ç›®æ€»ç»“ä¸æŠ€æœ¯æŒ‡æ ‡)
  - [11.1 æ¶æ„ç‰¹ç‚¹æ€»ç»“](#111-æ¶æ„ç‰¹ç‚¹æ€»ç»“)
  - [11.2 æ ¸å¿ƒåŠŸèƒ½å®ç°](#112-æ ¸å¿ƒåŠŸèƒ½å®ç°)
  - [11.3 æŠ€æœ¯æŒ‡æ ‡ä¸åŸºå‡†](#113-æŠ€æœ¯æŒ‡æ ‡ä¸åŸºå‡†)
  - [11.4 å¼€å‘æ•ˆç‡ä¸ç»´æŠ¤æ€§](#114-å¼€å‘æ•ˆç‡ä¸ç»´æŠ¤æ€§)
  - [11.5 å¯æ‰©å±•æ€§è®¾è®¡](#115-å¯æ‰©å±•æ€§è®¾è®¡)
  - [11.6 æŠ€æœ¯æ ˆæ¼”è¿›è§„åˆ’](#116-æŠ€æœ¯æ ˆæ¼”è¿›è§„åˆ’)
  - [11.7 ç»éªŒæ€»ç»“](#117-ç»éªŒæ€»ç»“)
  - [11.8 èµ„æºå‚è€ƒ](#118-èµ„æºå‚è€ƒ)

---

## ğŸ“– æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†Notesç¬”è®°åº”ç”¨çš„æŠ€æœ¯æ¶æ„ï¼Œè¯¥åº”ç”¨æ˜¯ä¸€ä¸ªåŸºäºå‰åç«¯åˆ†ç¦»æ¶æ„çš„ç°ä»£åŒ–ç¬”è®°ç®¡ç†ç³»ç»Ÿã€‚é¡¹ç›®é‡‡ç”¨FastAPIä½œä¸ºåç«¯APIæœåŠ¡å™¨ï¼ŒReactä½œä¸ºå‰ç«¯ç”¨æˆ·ç•Œé¢ï¼ŒSQLiteä½œä¸ºæ•°æ®å­˜å‚¨è§£å†³æ–¹æ¡ˆï¼Œå®ç°äº†å®Œæ•´çš„ç¬”è®°åˆ›å»ºã€ç¼–è¾‘ã€ç®¡ç†å’Œç»„ç»‡åŠŸèƒ½ã€‚

## é¡¹ç›®æ¦‚è¿°

Notesç¬”è®°åº”ç”¨æ˜¯ä¸€ä¸ªåŠŸèƒ½ä¸°å¯Œçš„åœ¨çº¿ç¬”è®°ç®¡ç†å¹³å°ï¼Œæ”¯æŒå¯Œæ–‡æœ¬ç¼–è¾‘ã€Markdownè¯­æ³•ã€å®æ—¶é¢„è§ˆã€ç¬”è®°æ‹–æ‹½æ’åºç­‰ç‰¹æ€§ã€‚è¯¥åº”ç”¨é‡‡ç”¨ç°ä»£åŒ–çš„Webå¼€å‘æŠ€æœ¯æ ˆï¼Œéµå¾ªRESTful APIè®¾è®¡è§„èŒƒï¼Œç¡®ä¿äº†è‰¯å¥½çš„å¯æ‰©å±•æ€§å’Œç»´æŠ¤æ€§ã€‚

### æ ¸å¿ƒç‰¹æ€§
- **å¯Œæ–‡æœ¬ç¼–è¾‘**: é›†æˆTipTapç¼–è¾‘å™¨ï¼Œæ”¯æŒå¤šç§æ–‡æœ¬æ ¼å¼å’ŒMarkdownè¯­æ³•
- **æ‹–æ‹½æ’åº**: åŸºäº@dnd-kitå®ç°çš„ç›´è§‚æ‹–æ‹½æ’åºåŠŸèƒ½
- **æ–‡ä»¶å¤¹ç®¡ç†**: æ”¯æŒåˆ›å»ºæ–‡ä»¶å¤¹å¯¹ç¬”è®°è¿›è¡Œåˆ†ç±»ç»„ç»‡
- **å®æ—¶ä¿å­˜**: è‡ªåŠ¨ä¿å­˜æœºåˆ¶ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±
- **å“åº”å¼è®¾è®¡**: åŸºäºMaterial-UIçš„ç°ä»£åŒ–ç•Œé¢è®¾è®¡
- **Dockeræ”¯æŒ**: å®Œæ•´çš„å®¹å™¨åŒ–éƒ¨ç½²æ–¹æ¡ˆ

### æŠ€æœ¯äº®ç‚¹
- **å‰åç«¯åˆ†ç¦»**: æ¸…æ™°çš„æ¶æ„è¾¹ç•Œï¼Œä¾¿äºç‹¬ç«‹å¼€å‘å’Œéƒ¨ç½²
- **ç»„ä»¶åŒ–å¼€å‘**: Reactå‡½æ•°ç»„ä»¶é…åˆè‡ªå®šä¹‰Hooksçš„ç°ä»£åŒ–å¼€å‘æ¨¡å¼
- **RESTful API**: æ ‡å‡†åŒ–çš„APIè®¾è®¡ï¼Œæ”¯æŒè‰¯å¥½çš„æ‰©å±•æ€§
- **ORMæ˜ å°„**: SQLAlchemyæä¾›çš„å¯¹è±¡å…³ç³»æ˜ å°„ï¼Œç®€åŒ–æ•°æ®åº“æ“ä½œ
- **æ¨¡å—åŒ–è®¾è®¡**: æ¸…æ™°çš„ä»£ç ç»„ç»‡ç»“æ„ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•

## 1. æ•´ä½“æ¶æ„æ¦‚è§ˆ

### 1.1 æ¶æ„è®¾è®¡åŸåˆ™

é¡¹ç›®éµå¾ªä»¥ä¸‹æ ¸å¿ƒè®¾è®¡åŸåˆ™ï¼š

#### 1.1.1 å…³æ³¨ç‚¹åˆ†ç¦»
- **å‰ç«¯ä¸“æ³¨äºç”¨æˆ·ä½“éªŒ**: Reactè´Ÿè´£ç”¨æˆ·ç•Œé¢å±•ç¤ºå’Œäº¤äº’é€»è¾‘
- **åç«¯ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘**: Flaskè´Ÿè´£APIæœåŠ¡ã€æ•°æ®å¤„ç†å’Œä¸šåŠ¡è§„åˆ™
- **æ•°æ®åº“ä¸“æ³¨äºæ•°æ®å­˜å‚¨**: SQLiteè´Ÿè´£æ•°æ®æŒä¹…åŒ–å’ŒæŸ¥è¯¢ä¼˜åŒ–

#### 1.1.2 å•ä¸€èŒè´£åŸåˆ™
- **ç»„ä»¶å•ä¸€èŒè´£**: æ¯ä¸ªReactç»„ä»¶åªè´Ÿè´£ç‰¹å®šçš„UIåŠŸèƒ½
- **APIç«¯ç‚¹å•ä¸€èŒè´£**: æ¯ä¸ªAPIç«¯ç‚¹åªå¤„ç†ç‰¹å®šçš„ä¸šåŠ¡æ“ä½œ
- **æ¨¡å‹å•ä¸€èŒè´£**: æ¯ä¸ªæ•°æ®æ¨¡å‹åªè¡¨ç¤ºç‰¹å®šçš„ä¸šåŠ¡å®ä½“

#### 1.1.3 å¼€æ”¾å°é—­åŸåˆ™
- **å¯æ‰©å±•æ€§**: é€šè¿‡æ¨¡å—åŒ–è®¾è®¡æ”¯æŒåŠŸèƒ½æ‰©å±•
- **ç¨³å®šæ€§**: æ ¸å¿ƒAPIæ¥å£ä¿æŒç¨³å®šï¼Œå‘ä¸‹å…¼å®¹

#### 1.1.4 ä¾èµ–å€’ç½®åŸåˆ™
- **æ¥å£ä¼˜å…ˆ**: å‰åç«¯é€šè¿‡æ ‡å‡†åŒ–APIæ¥å£é€šä¿¡
- **é…ç½®åˆ†ç¦»**: ç¯å¢ƒé…ç½®ä¸ä¸šåŠ¡ä»£ç åˆ†ç¦»

### 1.2 æŠ€æœ¯æ ˆé€‰æ‹©

#### 1.2.1 åç«¯æŠ€æœ¯æ ˆ
- **æ ¸å¿ƒæ¡†æ¶**: Flask 2.0.1 - è½»é‡çº§Python Webæ¡†æ¶
- **æ•°æ®åº“ORM**: SQLAlchemy 1.4.23 - Python SQLå·¥å…·åŒ…å’ŒORM
- **æ•°æ®åº“**: SQLite - è½»é‡çº§åµŒå…¥å¼æ•°æ®åº“
- **è·¨åŸŸå¤„ç†**: Flask-CORS 3.0.10 - å¤„ç†è·¨åŸŸèµ„æºå…±äº«
- **é…ç½®ç®¡ç†**: python-dotenv 0.19.0 - ç¯å¢ƒå˜é‡ç®¡ç†
- **æ—¶åŒºå¤„ç†**: pytz 2021.1 - æ—¶åŒºå¤„ç†åº“

**é€‰æ‹©ç†ç”±**:
- **Flask**: è½»é‡çº§æ¡†æ¶ï¼Œæ˜“äºå­¦ä¹ å’Œæ‰©å±•ï¼Œé€‚åˆä¸­å°å‹é¡¹ç›®
- **SQLAlchemy**: åŠŸèƒ½å¼ºå¤§çš„ORMï¼Œæä¾›çµæ´»çš„æ•°æ®åº“æ“ä½œæ–¹å¼
- **SQLite**: é›¶é…ç½®æ•°æ®åº“ï¼Œé€‚åˆå¼€å‘å’Œè½»é‡çº§éƒ¨ç½²

#### 1.2.2 å‰ç«¯æŠ€æœ¯æ ˆ
- **æ ¸å¿ƒæ¡†æ¶**: React 18.2.0 - ç°ä»£åŒ–å‰ç«¯æ¡†æ¶
- **æ„å»ºå·¥å…·**: Vite 4.3.5 - å¿«é€Ÿçš„å‰ç«¯æ„å»ºå·¥å…·
- **UIç»„ä»¶åº“**: Material-UI 5.13.0 - Google Material Designç»„ä»¶åº“
- **å¯Œæ–‡æœ¬ç¼–è¾‘å™¨**: TipTap 2.4.0 - åŸºäºProseMirrorçš„å¯Œæ–‡æœ¬ç¼–è¾‘å™¨
- **æ‹–æ‹½åŠŸèƒ½**: @dnd-kit 6.3.1 - ç°ä»£åŒ–æ‹–æ‹½åº“
- **HTTPå®¢æˆ·ç«¯**: Axios 1.4.0 - Promise based HTTPå®¢æˆ·ç«¯
- **ä»£ç é«˜äº®**: lowlight 3.3.0 - ä»£ç è¯­æ³•é«˜äº®åº“

**é€‰æ‹©ç†ç”±**:
- **React**: æˆç†Ÿçš„ç»„ä»¶åŒ–æ¡†æ¶ï¼Œä¸°å¯Œçš„ç”Ÿæ€ç³»ç»Ÿ
- **Vite**: æå¿«çš„å¼€å‘æœåŠ¡å™¨å’Œæ„å»ºå·¥å…·
- **Material-UI**: æˆç†Ÿçš„UIç»„ä»¶åº“ï¼Œæä¾›ä¸€è‡´çš„è®¾è®¡è¯­è¨€
- **TipTap**: ç°ä»£åŒ–çš„å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ï¼Œæ”¯æŒæ‰©å±•å’Œè‡ªå®šä¹‰

#### 1.2.3 å¼€å‘å’Œéƒ¨ç½²å·¥å…·
- **å®¹å™¨åŒ–**: Docker - åº”ç”¨å®¹å™¨åŒ–éƒ¨ç½²
- **å®¹å™¨ç¼–æ’**: Docker Compose - å¤šå®¹å™¨åº”ç”¨ç®¡ç†
- **WebæœåŠ¡å™¨**: Nginx - å‰ç«¯é™æ€æ–‡ä»¶æœåŠ¡
- **ç‰ˆæœ¬æ§åˆ¶**: Git - ä»£ç ç‰ˆæœ¬ç®¡ç†

### 1.3 é¡¹ç›®ç›®å½•ç»“æ„

é¡¹ç›®é‡‡ç”¨æ¸…æ™°çš„æ¨¡å—åŒ–ç›®å½•ç»“æ„ï¼Œä¾¿äºå¼€å‘å’Œç»´æŠ¤ï¼š

#### 1.3.1 æ ¹ç›®å½•ç»“æ„
```
NotesApplication/
â”œâ”€â”€ app.py                 # Flaskåº”ç”¨å¯åŠ¨å…¥å£
â”œâ”€â”€ requirements.txt       # Pythonä¾èµ–ç®¡ç†
â”œâ”€â”€ docker-compose.yml     # å®¹å™¨ç¼–æ’é…ç½®
â”œâ”€â”€ Dockerfile            # åç«¯å®¹å™¨åŒ–é…ç½®
â”œâ”€â”€ notes.db              # SQLiteæ•°æ®åº“æ–‡ä»¶
â”œâ”€â”€ app/                  # åç«¯åº”ç”¨ä¸»ç›®å½•
â”œâ”€â”€ frontend/             # å‰ç«¯åº”ç”¨ç›®å½•
â”œâ”€â”€ docs/                 # é¡¹ç›®æ–‡æ¡£ç›®å½•
â”œâ”€â”€ tests/                # æµ‹è¯•æ–‡ä»¶ç›®å½•
â””â”€â”€ tools/                # å·¥å…·è„šæœ¬ç›®å½•
```

#### 1.3.2 åç«¯ç›®å½•ç»“æ„ï¼ˆapp/ï¼‰
```
app/
â”œâ”€â”€ __init__.py           # åº”ç”¨å·¥å‚å’Œé…ç½®
â”œâ”€â”€ extensions.py         # Flaskæ‰©å±•åˆå§‹åŒ–
â”œâ”€â”€ api/                  # APIè·¯ç”±æ¨¡å—
â”‚   â”œâ”€â”€ notes.py         # ç¬”è®°ç›¸å…³API
â”‚   â”œâ”€â”€ folders.py       # æ–‡ä»¶å¤¹ç›¸å…³API
â”‚   â”œâ”€â”€ files.py         # æ–‡ä»¶ç›¸å…³API
â”‚   â””â”€â”€ health.py        # å¥åº·æ£€æŸ¥API
â”œâ”€â”€ models/              # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ note.py         # ç¬”è®°æ¨¡å‹
â”‚   â”œâ”€â”€ folder.py       # æ–‡ä»¶å¤¹æ¨¡å‹
â”‚   â””â”€â”€ note_file.py    # ç¬”è®°æ–‡ä»¶æ¨¡å‹
â”œâ”€â”€ config/             # é…ç½®æ¨¡å—
â”‚   â””â”€â”€ config.py       # åº”ç”¨é…ç½®
â”œâ”€â”€ services/           # ä¸šåŠ¡é€»è¾‘æœåŠ¡
â””â”€â”€ utils/              # å·¥å…·å‡½æ•°
```

#### 1.3.3 å‰ç«¯ç›®å½•ç»“æ„ï¼ˆfrontend/ï¼‰
```
frontend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ App.jsx          # ä¸»åº”ç”¨ç»„ä»¶
â”‚   â”œâ”€â”€ main.jsx         # åº”ç”¨å…¥å£æ–‡ä»¶
â”‚   â”œâ”€â”€ components/      # UIç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ NoteEditor.jsx    # ç¬”è®°ç¼–è¾‘å™¨
â”‚   â”‚   â”œâ”€â”€ TipTapEditor.jsx  # TipTapç¼–è¾‘å™¨å°è£…
â”‚   â”‚   â”œâ”€â”€ NoteList.jsx      # ç¬”è®°åˆ—è¡¨
â”‚   â”‚   â”œâ”€â”€ FolderList.jsx    # æ–‡ä»¶å¤¹åˆ—è¡¨
â”‚   â”‚   â””â”€â”€ Sidebar.jsx       # ä¾§è¾¹æ 
â”‚   â”œâ”€â”€ hooks/           # è‡ªå®šä¹‰React Hooks
â”‚   â”‚   â”œâ”€â”€ useNotes.js       # ç¬”è®°ç®¡ç†Hook
â”‚   â”‚   â”œâ”€â”€ useFolders.js     # æ–‡ä»¶å¤¹ç®¡ç†Hook
â”‚   â”‚   â””â”€â”€ useDragAndDrop.js # æ‹–æ‹½åŠŸèƒ½Hook
â”‚   â”œâ”€â”€ services/        # APIæœåŠ¡
â”‚   â”‚   â””â”€â”€ noteService.js    # ç¬”è®°APIæœåŠ¡
â”‚   â””â”€â”€ utils/           # å·¥å…·å‡½æ•°
â”‚       â””â”€â”€ editorUtils.js    # ç¼–è¾‘å™¨å·¥å…·å‡½æ•°
â”œâ”€â”€ package.json         # Node.jsä¾èµ–ç®¡ç†
â”œâ”€â”€ vite.config.js       # Viteæ„å»ºé…ç½®
â””â”€â”€ Dockerfile          # å‰ç«¯å®¹å™¨åŒ–é…ç½®
```

è¿™ç§ç›®å½•ç»“æ„çš„ä¼˜åŠ¿ï¼š
- **æ¸…æ™°çš„æ¨¡å—åˆ’åˆ†**: å‰åç«¯å®Œå…¨åˆ†ç¦»ï¼ŒèŒè´£æ˜ç¡®
- **æ˜“äºç»´æŠ¤**: ç›¸å…³åŠŸèƒ½é›†ä¸­åœ¨åŒä¸€ç›®å½•ä¸‹
- **ä¾¿äºæ‰©å±•**: æ–°åŠŸèƒ½å¯ä»¥æ–¹ä¾¿åœ°æ·»åŠ åˆ°å¯¹åº”æ¨¡å—ä¸­
- **ç¬¦åˆæœ€ä½³å®è·µ**: éµå¾ªå‰åç«¯é¡¹ç›®çš„æ ‡å‡†ç»„ç»‡æ–¹å¼

## 2. åç«¯æ¶æ„è¯¦è§£

### 2.1 Flaskåº”ç”¨ç»“æ„

åç«¯é‡‡ç”¨Flaskæ¡†æ¶æ„å»ºï¼Œéµå¾ªåº”ç”¨å·¥å‚æ¨¡å¼å’Œè“å›¾(Blueprint)æ¨¡å¼ï¼Œå®ç°äº†æ¨¡å—åŒ–å’Œå¯æ‰©å±•çš„æ¶æ„è®¾è®¡ã€‚

#### 2.1.1 åº”ç”¨å·¥å‚æ¨¡å¼

åœ¨`app/__init__.py`ä¸­å®ç°äº†åº”ç”¨å·¥å‚å‡½æ•°ï¼Œæ”¯æŒä¸åŒç¯å¢ƒçš„é…ç½®ï¼š

```python
def create_app(config_name='default'):
    """åˆ›å»ºå¹¶é…ç½®Flaskåº”ç”¨"""
    app = Flask(__name__)
    
    # åŠ è½½é…ç½®
    app.config.from_object(config[config_name])
    
    # åˆå§‹åŒ–æ‰©å±•
    db.init_app(app)
    migrate.init_app(app, db)
    
    # æ³¨å†Œè“å›¾
    app.register_blueprint(notes_bp, url_prefix='/api')
    app.register_blueprint(folders_bp, url_prefix='/api')
    app.register_blueprint(files_bp, url_prefix='/api')
    app.register_blueprint(health_bp, url_prefix='/api')
    
    return app
```

**åº”ç”¨å·¥å‚æ¨¡å¼çš„ä¼˜åŠ¿**ï¼š
- **ç¯å¢ƒé…ç½®çµæ´»**: æ”¯æŒå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒçš„ä¸åŒé…ç½®
- **å»¶è¿Ÿåˆå§‹åŒ–**: æ‰©å±•åœ¨åº”ç”¨åˆ›å»ºæ—¶æ‰åˆå§‹åŒ–ï¼Œé¿å…å¾ªç¯å¯¼å…¥
- **æµ‹è¯•å‹å¥½**: ä¾¿äºåˆ›å»ºæµ‹è¯•ç”¨çš„åº”ç”¨å®ä¾‹

#### 2.1.2 è“å›¾æ¶æ„

é¡¹ç›®é‡‡ç”¨è“å›¾æ¨¡å¼ç»„ç»‡APIè·¯ç”±ï¼Œå®ç°åŠŸèƒ½æ¨¡å—çš„åˆ†ç¦»ï¼š

- **notes_bp**: ç¬”è®°å†…å®¹ç›¸å…³API (`/api/notes/*`)
- **folders_bp**: æ–‡ä»¶å¤¹ç®¡ç†API (`/api/folders/*`)
- **files_bp**: ç¬”è®°æ–‡ä»¶ç®¡ç†API (`/api/files/*`)
- **health_bp**: ç³»ç»Ÿå¥åº·æ£€æŸ¥API (`/api/health/*`)

æ¯ä¸ªè“å›¾è´Ÿè´£ç‰¹å®šçš„ä¸šåŠ¡é¢†åŸŸï¼Œä¾¿äºåŠŸèƒ½æ‰©å±•å’Œç»´æŠ¤ã€‚

#### 2.1.3 æ‰©å±•ç®¡ç†

åœ¨`app/extensions.py`ä¸­ç»Ÿä¸€ç®¡ç†Flaskæ‰©å±•ï¼š

```python
from flask_sqlalchemy import SQLAlchemy
from flask_migrate import Migrate

db = SQLAlchemy()      # æ•°æ®åº“ORM
migrate = Migrate()    # æ•°æ®åº“è¿ç§»
```

è¿™ç§è®¾è®¡é¿å…äº†å¾ªç¯å¯¼å…¥é—®é¢˜ï¼Œä½¿æ‰©å±•å¯ä»¥åœ¨ä¸åŒæ¨¡å—ä¸­å®‰å…¨ä½¿ç”¨ã€‚

#### 2.1.4 é…ç½®ç®¡ç†

é‡‡ç”¨åˆ†å±‚é…ç½®è®¾è®¡ï¼Œåœ¨`app/config/config.py`ä¸­å®šä¹‰ï¼š

- **åŸºç¡€é…ç½®ç±»(Config)**: åŒ…å«é€šç”¨é…ç½®é¡¹
- **å¼€å‘é…ç½®(DevelopmentConfig)**: å¼€å‘ç¯å¢ƒä¸“ç”¨é…ç½®
- **æµ‹è¯•é…ç½®(TestingConfig)**: æµ‹è¯•ç¯å¢ƒé…ç½®ï¼Œä½¿ç”¨å†…å­˜æ•°æ®åº“
- **ç”Ÿäº§é…ç½®(ProductionConfig)**: ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–é…ç½®

### 2.2 æ•°æ®åº“è®¾è®¡ä¸ORMæ˜ å°„

é¡¹ç›®ä½¿ç”¨SQLAlchemyä½œä¸ºORMæ¡†æ¶ï¼ŒSQLiteä½œä¸ºæ•°æ®åº“ï¼Œå®ç°äº†æ¸…æ™°çš„æ•°æ®æ¨¡å‹è®¾è®¡ã€‚

#### 2.2.1 æ•°æ®åº“é€‰æ‹©ç†ç”±

**SQLiteä¼˜åŠ¿**ï¼š
- **é›¶é…ç½®**: æ— éœ€å®‰è£…å’Œé…ç½®æ•°æ®åº“æœåŠ¡å™¨
- **æ–‡ä»¶å‹æ•°æ®åº“**: ä¾¿äºå¼€å‘ã€æµ‹è¯•å’Œå°è§„æ¨¡éƒ¨ç½²
- **å®Œæ•´çš„SQLæ”¯æŒ**: æ”¯æŒäº‹åŠ¡ã€ç´¢å¼•ã€çº¦æŸç­‰ç‰¹æ€§
- **è·¨å¹³å°**: åœ¨Windowsã€Linuxã€macOSä¸Šè¡¨ç°ä¸€è‡´

#### 2.2.2 æ•°æ®æ¨¡å‹è®¾è®¡

é¡¹ç›®åŒ…å«ä¸‰ä¸ªæ ¸å¿ƒæ•°æ®æ¨¡å‹ï¼š

**1. æ–‡ä»¶å¤¹æ¨¡å‹(Folder)**
```python
class Folder(db.Model):
    __tablename__ = 'folders'
    
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100), nullable=False)
    created_at = db.Column(db.DateTime, default=db.func.current_timestamp())
    updated_at = db.Column(db.DateTime, default=db.func.current_timestamp())
    
    # ä¸€å¯¹å¤šå…³ç³»ï¼šä¸€ä¸ªæ–‡ä»¶å¤¹åŒ…å«å¤šä¸ªæ–‡ä»¶
    files = db.relationship('NoteFile', backref='folder', lazy=True)
```

**2. ç¬”è®°æ–‡ä»¶æ¨¡å‹(NoteFile)**
```python
class NoteFile(db.Model):
    __tablename__ = 'note_files'
    
    id = db.Column(db.Integer, primary_key=True)
    title = db.Column(db.String(200), nullable=False)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, onupdate=datetime.utcnow)
    folder_id = db.Column(db.Integer, db.ForeignKey('folders.id'))
    
    # ä¸€å¯¹å¤šå…³ç³»ï¼šä¸€ä¸ªæ–‡ä»¶åŒ…å«å¤šä¸ªç¬”è®°
    notes = db.relationship('Note', backref='file', lazy=True, cascade='all, delete-orphan')
```

**3. ç¬”è®°å†…å®¹æ¨¡å‹(Note)**
```python
class Note(db.Model):
    __tablename__ = 'notes'
    
    id = db.Column(db.Integer, primary_key=True)
    content = db.Column(db.Text)
    format = db.Column(db.String(20), default='text')  # æ”¯æŒå¤šç§æ ¼å¼
    order = db.Column(db.Integer, default=0)           # æ’åºå­—æ®µ
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, onupdate=datetime.utcnow)
    file_id = db.Column(db.Integer, db.ForeignKey('note_files.id', ondelete='CASCADE'))
```

#### 2.2.3 æ•°æ®å…³ç³»è®¾è®¡

```
Folder (1) â”€â”€â†’ (N) NoteFile (1) â”€â”€â†’ (N) Note
```

- **Folder â†’ NoteFile**: ä¸€å¯¹å¤šå…³ç³»ï¼Œä¸€ä¸ªæ–‡ä»¶å¤¹å¯åŒ…å«å¤šä¸ªç¬”è®°æ–‡ä»¶
- **NoteFile â†’ Note**: ä¸€å¯¹å¤šå…³ç³»ï¼Œä¸€ä¸ªæ–‡ä»¶å¯åŒ…å«å¤šä¸ªç¬”è®°æ¡ç›®
- **çº§è”åˆ é™¤**: åˆ é™¤æ–‡ä»¶æ—¶è‡ªåŠ¨åˆ é™¤å…¶ä¸‹æ‰€æœ‰ç¬”è®°

#### 2.2.4 ORMæ˜ å°„ç‰¹æ€§

**1. è‡ªåŠ¨æ—¶é—´æˆ³**
- `created_at`: è®°å½•åˆ›å»ºæ—¶é—´ï¼Œä½¿ç”¨`datetime.utcnow`
- `updated_at`: è®°å½•æ›´æ–°æ—¶é—´ï¼Œä½¿ç”¨`onupdate`è‡ªåŠ¨æ›´æ–°

**2. å¤–é”®çº¦æŸ**
- ä½¿ç”¨`db.ForeignKey`å®šä¹‰è¡¨é—´å…³ç³»
- æ”¯æŒçº§è”åˆ é™¤(`ondelete='CASCADE'`)

**3. å…³ç³»æ˜ å°„**
- ä½¿ç”¨`db.relationship`å®šä¹‰å¯¹è±¡é—´å…³ç³»
- `backref`æä¾›åå‘å¼•ç”¨
- `lazy=True`å®ç°å»¶è¿ŸåŠ è½½

### 2.3 APIæ¥å£è®¾è®¡

é¡¹ç›®éµå¾ªRESTful APIè®¾è®¡è§„èŒƒï¼Œæä¾›æ¸…æ™°ã€ä¸€è‡´çš„APIæ¥å£ã€‚

#### 2.3.1 APIè®¾è®¡åŸåˆ™

**1. èµ„æºå¯¼å‘**
- URLè¡¨ç¤ºèµ„æºï¼ŒHTTPæ–¹æ³•è¡¨ç¤ºæ“ä½œ
- ä½¿ç”¨åè¯è€ŒéåŠ¨è¯æè¿°èµ„æº

**2. ç»Ÿä¸€çš„URLç»“æ„**
```
/api/folders                    # æ–‡ä»¶å¤¹é›†åˆ
/api/folders/{id}              # ç‰¹å®šæ–‡ä»¶å¤¹
/api/files                     # æ–‡ä»¶é›†åˆ
/api/files/{id}                # ç‰¹å®šæ–‡ä»¶
/api/files/{id}/notes          # æ–‡ä»¶ä¸‹çš„ç¬”è®°é›†åˆ
/api/notes/{id}                # ç‰¹å®šç¬”è®°
```

**3. æ ‡å‡†HTTPæ–¹æ³•**
- `GET`: è·å–èµ„æº
- `POST`: åˆ›å»ºèµ„æº
- `PUT`: æ›´æ–°èµ„æº
- `DELETE`: åˆ é™¤èµ„æº

#### 2.3.2 æ ¸å¿ƒAPIç«¯ç‚¹

**1. ç¬”è®°ç®¡ç†API**
```python
# è·å–æ–‡ä»¶ä¸‹çš„æ‰€æœ‰ç¬”è®°
GET /api/files/{file_id}/notes

# åˆ›å»ºæ–°ç¬”è®°
POST /api/files/{file_id}/notes
{
    "content": "ç¬”è®°å†…å®¹",
    "format": "text",
    "after_note_id": 123  # å¯é€‰ï¼šæŒ‡å®šæ’å…¥ä½ç½®
}

# æ›´æ–°ç¬”è®°
PUT /api/notes/{note_id}
{
    "content": "æ›´æ–°çš„å†…å®¹",
    "format": "h1",
    "order": 2
}

# åˆ é™¤ç¬”è®°
DELETE /api/notes/{note_id}
```

**2. æ–‡ä»¶å¤¹ç®¡ç†API**
```python
# è·å–æ‰€æœ‰æ–‡ä»¶å¤¹
GET /api/folders

# åˆ›å»ºæ–‡ä»¶å¤¹
POST /api/folders
{
    "name": "æ–‡ä»¶å¤¹åç§°"
}

# æ›´æ–°æ–‡ä»¶å¤¹
PUT /api/folders/{folder_id}
{
    "name": "æ–°åç§°"
}
```

#### 2.3.3 å“åº”æ ¼å¼æ ‡å‡†

**æˆåŠŸå“åº”**
```json
{
    "id": 1,
    "content": "ç¬”è®°å†…å®¹",
    "format": "text",
    "order": 1,
    "created_at": "2025-06-02T10:00:00",
    "updated_at": "2025-06-02T10:30:00",
    "file_id": 1
}
```

**é”™è¯¯å“åº”**
```json
{
    "error": "validation_error",
    "message": "å…·ä½“é”™è¯¯æè¿°",
    "details": {
        "field": "é”™è¯¯å­—æ®µ",
        "reason": "é”™è¯¯åŸå› "
    }
}
```

### 2.4 è¯·æ±‚å¤„ç†æµç¨‹

#### 2.4.1 å®Œæ•´è¯·æ±‚ç”Ÿå‘½å‘¨æœŸ

```
å®¢æˆ·ç«¯è¯·æ±‚ â†’ Flaskè·¯ç”± â†’ è“å›¾å¤„ç† â†’ æ•°æ®éªŒè¯ â†’ ä¸šåŠ¡é€»è¾‘ â†’ æ•°æ®åº“æ“ä½œ â†’ å“åº”ç”Ÿæˆ
```

**1. è¯·æ±‚æ¥æ”¶ä¸è·¯ç”±**
- Flaskæ¥æ”¶HTTPè¯·æ±‚
- æ ¹æ®URLå’Œæ–¹æ³•åŒ¹é…å¯¹åº”çš„è“å›¾å’Œè§†å›¾å‡½æ•°

**2. è¯·æ±‚é¢„å¤„ç†**
```python
@app.before_request
def log_request_info():
    logger.debug('ã€è¯·æ±‚ã€‘%s %s', request.method, request.path)
    if request.is_json:
        logger.debug('ã€è¯·æ±‚æ•°æ®ã€‘%s', request.get_json())
```

**3. ä¸šåŠ¡é€»è¾‘å¤„ç†**
- æ•°æ®éªŒè¯å’Œå‚æ•°æå–
- æ•°æ®åº“æŸ¥è¯¢å’Œæ“ä½œ
- ä¸šåŠ¡è§„åˆ™åº”ç”¨

**4. å“åº”åå¤„ç†**
```python
@app.after_request
def log_response_info(response):
    logger.debug('ã€å“åº”ã€‘çŠ¶æ€ç : %s', response.status_code)
    return response
```

#### 2.4.2 æ•°æ®åº“ä¼šè¯ç®¡ç†

SQLAlchemyè‡ªåŠ¨ç®¡ç†æ•°æ®åº“ä¼šè¯ï¼š
- **è¯·æ±‚å¼€å§‹**: åˆ›å»ºæ–°çš„æ•°æ®åº“ä¼šè¯
- **è¯·æ±‚å¤„ç†**: åœ¨ä¼šè¯ä¸­æ‰§è¡Œæ•°æ®åº“æ“ä½œ
- **è¯·æ±‚ç»“æŸ**: è‡ªåŠ¨æäº¤æˆ–å›æ»šäº‹åŠ¡ï¼Œå…³é—­ä¼šè¯

#### 2.4.3 äº‹åŠ¡å¤„ç†

```python
def create_note(file_id):
    try:
        # æ•°æ®åº“æ“ä½œ
        new_note = Note(content=content, file_id=file_id)
        db.session.add(new_note)
        db.session.commit()
        return jsonify({'id': new_note.id}), 201
    except Exception as e:
        db.session.rollback()
        return jsonify({'error': str(e)}), 500
```

### 2.5 æ•°æ®éªŒè¯ä¸é”™è¯¯å¤„ç†

#### 2.5.1 è¾“å…¥æ•°æ®éªŒè¯

**1. è¯·æ±‚æ•°æ®éªŒè¯**
```python
def update_note(note_id):
    data = request.get_json()
    
    if not data:
        return jsonify({
            'error': 'Invalid request',
            'message': 'No data provided'
        }), 400
    
    # éªŒè¯å†…å®¹æ ¼å¼
    if 'content' in data:
        note.content = data['content']
    
    # éªŒè¯æ ¼å¼å­—æ®µ
    if 'format' in data and isinstance(data['format'], str):
        note.format = data['format']
```

**2. ç±»å‹æ£€æŸ¥**
- ä½¿ç”¨`isinstance()`è¿›è¡Œç±»å‹éªŒè¯
- æ£€æŸ¥å¿…éœ€å­—æ®µçš„å­˜åœ¨æ€§
- éªŒè¯æ•°æ®æ ¼å¼çš„åˆæ³•æ€§

#### 2.5.2 é”™è¯¯å¤„ç†æœºåˆ¶

**1. ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼**
```python
{
    "error": "error_type",
    "message": "ç”¨æˆ·å‹å¥½çš„é”™è¯¯æè¿°",
    "details": "æŠ€æœ¯ç»†èŠ‚ï¼ˆå¯é€‰ï¼‰"
}
```

**2. å¸¸è§é”™è¯¯ç±»å‹**
- `400 Bad Request`: è¯·æ±‚æ•°æ®æ ¼å¼é”™è¯¯
- `404 Not Found`: èµ„æºä¸å­˜åœ¨
- `500 Internal Server Error`: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯

**3. å¼‚å¸¸æ•è·å’Œæ—¥å¿—è®°å½•**
```python
try:
    # ä¸šåŠ¡é€»è¾‘
    pass
except Exception as e:
    logger.error(f'æ“ä½œå¤±è´¥: {str(e)}')
    db.session.rollback()
    return jsonify({'error': 'operation_failed'}), 500
```

#### 2.5.3 è·¨åŸŸèµ„æºå…±äº«(CORS)é…ç½®

```python
CORS(app, resources={
    r"/*": {
        "origins": ["http://localhost:5173", "http://127.0.0.1:5173"],
        "methods": ["GET", "POST", "PUT", "DELETE", "OPTIONS"],
        "allow_headers": ["Content-Type", "Authorization", "X-Requested-With"]
    }
})
```

è¿™ç¡®ä¿äº†å‰ç«¯åº”ç”¨å¯ä»¥å®‰å…¨åœ°è®¿é—®åç«¯APIï¼ŒåŒæ—¶é™åˆ¶äº†å…è®¸çš„æºã€æ–¹æ³•å’Œå¤´éƒ¨ï¼Œæé«˜äº†å®‰å…¨æ€§ã€‚

## 3. å‰ç«¯æ¶æ„è¯¦è§£

### 3.1 Reactåº”ç”¨ç»“æ„

å‰ç«¯é‡‡ç”¨React 18.2.0æ„å»ºï¼Œé…åˆViteä½œä¸ºæ„å»ºå·¥å…·ï¼Œå®ç°äº†ç°ä»£åŒ–çš„å•é¡µé¢åº”ç”¨(SPA)æ¶æ„ã€‚

#### 3.1.1 åº”ç”¨å…¥å£å’Œä¸»ç»„ä»¶

**ä¸»åº”ç”¨ç»„ä»¶(App.jsx)**
```jsx
function App() {
  // 1. API çŠ¶æ€ç®¡ç†
  const { apiStatus, errorMessage, isLoading, checkApiHealth, setErrorMessage, clearErrorMessage } = useApiStatus();

  // 2. æ–‡ä»¶å¤¹çŠ¶æ€ç®¡ç†
  const { folders, fetchFolders, createFolder, renameFolder, deleteFolder } = useFolders(setErrorMessage);

  // 3. æ–‡ä»¶çŠ¶æ€ç®¡ç†
  const { files, setFiles, activeFileId, setActiveFileId, fetchFiles, createFile } = useFiles(setErrorMessage);

  // 4. ç¬”è®°çŠ¶æ€ç®¡ç†
  const { notes, activeNoteId, setActiveNoteId, fetchNotes, createNote, updateNote, deleteNote } = useNotes(activeFileId, setErrorMessage);

  // 5. æ‹–æ‹½åŠŸèƒ½
  const { handleDragEnd } = useDragAndDrop(notes, setNotes, updateNote);

  return (
    <DragDropContext onDragEnd={handleDragEnd}>
      <Container maxWidth="xl">
        <AppHeader />
        <Box display="flex" height="calc(100vh - 64px)">
          <Sidebar folders={folders} files={files} onFileSelect={setActiveFileId} />
          <NoteList notes={notes} activeFileId={activeFileId} onNoteUpdate={updateNote} />
        </Box>
      </Container>
    </DragDropContext>
  );
}
```

**åº”ç”¨å…¥å£(main.jsx)**
```jsx
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App.jsx';
import './index.css';
import { ThemeProvider, createTheme } from '@mui/material/styles';
import CssBaseline from '@mui/material/CssBaseline';

const theme = createTheme({
  palette: {
    mode: 'light',
    primary: { main: '#1976d2' },
    secondary: { main: '#dc004e' }
  }
});

ReactDOM.createRoot(document.getElementById('root')).render(
  <React.StrictMode>
    <ThemeProvider theme={theme}>
      <CssBaseline />
      <App />
    </ThemeProvider>
  </React.StrictMode>
);
```

#### 3.1.2 Viteæ„å»ºé…ç½®

```javascript
export default defineConfig({
  plugins: [react()],
  server: {
    // å¼€å‘æœåŠ¡å™¨é…ç½®
    port: 5173,
    host: true
  },
  build: {
    // ç”Ÿäº§æ„å»ºä¼˜åŒ–
    outDir: 'dist',
    sourcemap: true
  }
});
```

**Viteçš„ä¼˜åŠ¿**ï¼š
- **æå¿«çš„å¼€å‘æœåŠ¡å™¨**: åŸºäºESæ¨¡å—çš„å³æ—¶çƒ­æ›´æ–°
- **ä¼˜åŒ–çš„ç”Ÿäº§æ„å»º**: åŸºäºRollupçš„é«˜æ•ˆæ‰“åŒ…
- **å¼€ç®±å³ç”¨**: æ— éœ€å¤æ‚é…ç½®å³å¯å¼€å§‹å¼€å‘

### 3.2 ç»„ä»¶è®¾è®¡æ¨¡å¼

é¡¹ç›®é‡‡ç”¨å‡½æ•°ç»„ä»¶é…åˆè‡ªå®šä¹‰Hooksçš„ç°ä»£Reactå¼€å‘æ¨¡å¼ï¼Œå®ç°äº†é«˜åº¦å¯å¤ç”¨å’Œå¯ç»´æŠ¤çš„ç»„ä»¶æ¶æ„ã€‚

#### 3.2.1 ç»„ä»¶å±‚æ¬¡ç»“æ„

```
App (ä¸»åº”ç”¨)
â”œâ”€â”€ AppHeader (åº”ç”¨å¤´éƒ¨)
â”œâ”€â”€ Sidebar (ä¾§è¾¹æ )
â”‚   â”œâ”€â”€ FolderList (æ–‡ä»¶å¤¹åˆ—è¡¨)
â”‚   â””â”€â”€ FileItem (æ–‡ä»¶é¡¹)
â”œâ”€â”€ NoteList (ç¬”è®°åˆ—è¡¨)
â”‚   â”œâ”€â”€ NoteEditor (ç¬”è®°ç¼–è¾‘å™¨)
â”‚   â””â”€â”€ TipTapEditor (å¯Œæ–‡æœ¬ç¼–è¾‘å™¨)
â””â”€â”€ ErrorBoundary (é”™è¯¯è¾¹ç•Œ)
```

#### 3.2.2 æ ¸å¿ƒç»„ä»¶è®¾è®¡

**1. TipTapEditorç»„ä»¶**
```jsx
const TipTapEditor = ({
  note,
  isActive,
  onUpdate,
  onFocus,
  onBlur
}) => {
  // ç¼–è¾‘å™¨æ‰©å±•é…ç½®
  const memoizedExtensions = useMemo(() => tiptapExtensions, []);

  const editor = useEditor({
    extensions: memoizedExtensions,
    content: note?.content || '',
    onFocus: () => { if (onFocus) onFocus(note.id); },
    onBlur: onBlur
  });

  // é˜²æŠ–æ›´æ–°æœºåˆ¶
  const debouncedUpdate = useCallback(debounce((id, content) => {
    if (onUpdate) onUpdate(id, content);
  }, 500), [onUpdate]);

  // ç›‘å¬ç¼–è¾‘å™¨å˜åŒ–
  useEffect(() => {
    if (!editor) return;
    
    const handleUpdate = () => {
      const htmlContent = editor.getHTML();
      if (htmlContent === note?.content) return;
      debouncedUpdate(note.id, { content: htmlContent, format: note.format });
    };
    
    editor.on('update', handleUpdate);
    return () => editor.off('update', handleUpdate);
  }, [editor, note?.id, note?.content, debouncedUpdate]);

  return (
    <Box className="tiptap-editor">
      <EditorContent editor={editor} />
    </Box>
  );
};
```

**2. NoteListç»„ä»¶**
```jsx
const NoteList = ({ notes, activeFileId, onNoteUpdate }) => {
  return (
    <Droppable droppableId="note-list">
      {(provided) => (
        <Box ref={provided.innerRef} {...provided.droppableProps}>
          {notes.map((note, index) => (
            <Draggable key={note.id} draggableId={String(note.id)} index={index}>
              {(provided, snapshot) => (
                <Box
                  ref={provided.innerRef}
                  {...provided.draggableProps}
                  {...provided.dragHandleProps}
                >
                  <NoteEditor 
                    note={note} 
                    onUpdate={onNoteUpdate}
                    isDragging={snapshot.isDragging}
                  />
                </Box>
              )}
            </Draggable>
          ))}
          {provided.placeholder}
        </Box>
      )}
    </Droppable>
  );
};
```

#### 3.2.3 ç»„ä»¶è®¾è®¡åŸåˆ™

**1. å•ä¸€èŒè´£åŸåˆ™**
- æ¯ä¸ªç»„ä»¶åªè´Ÿè´£ç‰¹å®šçš„UIåŠŸèƒ½
- ä¸šåŠ¡é€»è¾‘é€šè¿‡è‡ªå®šä¹‰HooksæŠ½ç¦»

**2. å¯å¤ç”¨æ€§**
- ç»„ä»¶é€šè¿‡propsæ¥æ”¶æ•°æ®å’Œå›è°ƒå‡½æ•°
- é¿å…åœ¨ç»„ä»¶å†…éƒ¨ç›´æ¥è°ƒç”¨API

**3. æ€§èƒ½ä¼˜åŒ–**
- ä½¿ç”¨`useMemo`å’Œ`useCallback`ä¼˜åŒ–æ¸²æŸ“æ€§èƒ½
- åˆç†ä½¿ç”¨`React.memo`é¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“

### 3.3 çŠ¶æ€ç®¡ç†æœºåˆ¶

é¡¹ç›®é‡‡ç”¨è‡ªå®šä¹‰Hooksæ¨¡å¼è¿›è¡ŒçŠ¶æ€ç®¡ç†ï¼Œå®ç°äº†æ¸…æ™°çš„çŠ¶æ€é€»è¾‘åˆ†ç¦»ã€‚

#### 3.3.1 è‡ªå®šä¹‰Hooksæ¶æ„

**1. useNotes Hook**
```javascript
export function useNotes(activeFileId, setErrorMessage) {
  const [notes, setNotes] = useState([]);
  const [activeNoteId, setActiveNoteId] = useState(null);

  // è·å–ç¬”è®°åˆ—è¡¨
  const fetchNotes = useCallback(async () => {
    if (!activeFileId) {
      setNotes([]);
      return;
    }
    try {
      const fetchedNotes = await noteService.getNotes(activeFileId);
      setNotes(fetchedNotes || []);
    } catch (error) {
      setErrorMessage('è·å–ç¬”è®°å¤±è´¥: ' + (error.response?.data?.message || error.message));
      setNotes([]);
    }
  }, [activeFileId, setErrorMessage]);

  // åˆ›å»ºæ–°ç¬”è®°
  const createNote = useCallback(async (afterNoteId, content = '', format = 'text') => {
    if (!activeFileId) {
      setErrorMessage('æ— æ³•åˆ›å»ºç¬”è®°ï¼šæœªé€‰æ‹©æ–‡ä»¶');
      return null;
    }
    try {
      const newNote = await noteService.createNote(activeFileId, content, format, afterNoteId);
      setNotes(prevNotes => {
        const insertIndex = prevNotes.findIndex(note => note.id === afterNoteId);
        const newNotes = [...prevNotes];
        if (insertIndex !== -1) {
          newNotes.splice(insertIndex + 1, 0, newNote);
        } else {
          newNotes.push(newNote);
        }
        return newNotes;
      });
      return newNote.id;
    } catch (error) {
      setErrorMessage('åˆ›å»ºç¬”è®°å¤±è´¥: ' + (error.response?.data?.message || error.message));
      return null;
    }
  }, [activeFileId, setErrorMessage]);

  // æ›´æ–°ç¬”è®°
  const updateNote = useCallback(async (noteId, contentData) => {
    try {
      await noteService.updateNote(noteId, contentData);
      setNotes(prevNotes =>
        prevNotes.map(note =>
          note.id === noteId ? { ...note, ...contentData } : note
        )
      );
    } catch (error) {
      setErrorMessage('æ›´æ–°ç¬”è®°å¤±è´¥: ' + (error.response?.data?.message || error.message));
    }
  }, [setErrorMessage]);

  return {
    notes,
    activeNoteId,
    setActiveNoteId,
    fetchNotes,
    createNote,
    updateNote,
    deleteNote
  };
}
```

**2. useFolders Hook**
```javascript
export function useFolders(setErrorMessage) {
  const [folders, setFolders] = useState([]);

  const fetchFolders = useCallback(async () => {
    try {
      const data = await noteService.getFolders();
      setFolders(data || []);
    } catch (error) {
      setErrorMessage('è·å–æ–‡ä»¶å¤¹å¤±è´¥: ' + (error.response?.data?.message || error.message));
      setFolders([]);
    }
  }, [setErrorMessage]);

  const createFolder = useCallback(async (name) => {
    try {
      const newFolder = await noteService.createFolder(name);
      setFolders(prev => [...prev, newFolder]);
      return newFolder;
    } catch (error) {
      setErrorMessage('åˆ›å»ºæ–‡ä»¶å¤¹å¤±è´¥: ' + (error.response?.data?.message || error.message));
      throw error;
    }
  }, [setErrorMessage]);

  return {
    folders,
    fetchFolders,
    createFolder,
    renameFolder,
    deleteFolder
  };
}
```

#### 3.3.2 çŠ¶æ€ç®¡ç†ä¼˜åŠ¿

**1. é€»è¾‘åˆ†ç¦»**
- æ¯ä¸ªHookè´Ÿè´£ç‰¹å®šé¢†åŸŸçš„çŠ¶æ€ç®¡ç†
- ä¸šåŠ¡é€»è¾‘ä¸UIç»„ä»¶è§£è€¦

**2. å¯å¤ç”¨æ€§**
- Hookå¯ä»¥åœ¨å¤šä¸ªç»„ä»¶ä¸­å¤ç”¨
- çŠ¶æ€é€»è¾‘æ˜“äºæµ‹è¯•å’Œç»´æŠ¤

**3. ç±»å‹å®‰å…¨**
- é€šè¿‡TypeScriptç±»å‹å®šä¹‰ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- ç¼–è¯‘æ—¶é”™è¯¯æ£€æŸ¥

### 3.4 è·¯ç”±ä¸é¡µé¢ç®¡ç†

é¡¹ç›®é‡‡ç”¨å•é¡µé¢åº”ç”¨æ¶æ„ï¼Œé€šè¿‡ç»„ä»¶çŠ¶æ€æ§åˆ¶ä¸åŒè§†å›¾çš„æ˜¾ç¤ºã€‚

#### 3.4.1 è§†å›¾çŠ¶æ€ç®¡ç†

```jsx
function App() {
  const [activeFileId, setActiveFileId] = useState(null);
  const [activeNoteId, setActiveNoteId] = useState(null);

  // è§†å›¾åˆ‡æ¢é€»è¾‘
  const handleFileSelect = useCallback((fileId) => {
    setActiveFileId(fileId);
    setActiveNoteId(null); // é‡ç½®æ´»åŠ¨ç¬”è®°
  }, []);

  const handleNoteSelect = useCallback((noteId) => {
    setActiveNoteId(noteId);
  }, []);

  return (
    <Box display="flex">
      <Sidebar 
        activeFileId={activeFileId}
        onFileSelect={handleFileSelect}
      />
      <NoteList 
        activeFileId={activeFileId}
        activeNoteId={activeNoteId}
        onNoteSelect={handleNoteSelect}
      />
    </Box>
  );
}
```

#### 3.4.2 æ¡ä»¶æ¸²æŸ“ç­–ç•¥

```jsx
const MainContent = ({ activeFileId, notes }) => {
  if (!activeFileId) {
    return (
      <Box display="flex" justifyContent="center" alignItems="center">
        <Typography variant="h6" color="textSecondary">
          è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶å¼€å§‹ç¼–è¾‘
        </Typography>
      </Box>
    );
  }

  if (notes.length === 0) {
    return (
      <Box display="flex" justifyContent="center" alignItems="center">
        <Button onClick={handleCreateFirstNote}>
          åˆ›å»ºç¬¬ä¸€ä¸ªç¬”è®°
        </Button>
      </Box>
    );
  }

  return <NoteList notes={notes} />;
};
```

### 3.5 UIç»„ä»¶åº“é›†æˆ

é¡¹ç›®é›†æˆMaterial-UI (MUI) 5.13.0ä½œä¸ºUIç»„ä»¶åº“ï¼Œæä¾›ä¸€è‡´çš„è®¾è®¡è¯­è¨€å’Œä¸°å¯Œçš„ç»„ä»¶ã€‚

#### 3.5.1 ä¸»é¢˜é…ç½®

```jsx
const theme = createTheme({
  palette: {
    mode: 'light',
    primary: {
      main: '#1976d2',
      light: '#42a5f5',
      dark: '#1565c0'
    },
    secondary: {
      main: '#dc004e',
      light: '#ff5983',
      dark: '#9a0036'
    },
    background: {
      default: '#f5f5f5',
      paper: '#ffffff'
    }
  },
  typography: {
    fontFamily: [
      '-apple-system',
      'BlinkMacSystemFont',
      '"Segoe UI"',
      'Roboto',
      '"Helvetica Neue"',
      'Arial',
      'sans-serif'
    ].join(','),
    h1: {
      fontSize: '2.125rem',
      fontWeight: 500
    },
    body1: {
      fontSize: '0.875rem',
      lineHeight: 1.43
    }
  },
  components: {
    MuiButton: {
      styleOverrides: {
        root: {
          textTransform: 'none',
          borderRadius: 8
        }
      }
    },
    MuiPaper: {
      styleOverrides: {
        root: {
          borderRadius: 12
        }
      }
    }
  }
});
```

#### 3.5.2 å“åº”å¼è®¾è®¡

```jsx
const ResponsiveLayout = () => {
  const theme = useTheme();
  const isMobile = useMediaQuery(theme.breakpoints.down('md'));

  return (
    <Box display="flex" flexDirection={isMobile ? 'column' : 'row'}>
      <Box 
        width={isMobile ? '100%' : '300px'}
        height={isMobile ? 'auto' : '100vh'}
      >
        <Sidebar />
      </Box>
      <Box flex={1}>
        <NoteList />
      </Box>
    </Box>
  );
};
```

#### 3.5.3 è‡ªå®šä¹‰æ ·å¼ç»„ä»¶

```jsx
const StyledNoteCard = styled(Paper)(({ theme, isDragging }) => ({
  padding: theme.spacing(2),
  margin: theme.spacing(1, 0),
  cursor: 'pointer',
  transition: theme.transitions.create(['box-shadow', 'transform'], {
    duration: theme.transitions.duration.short
  }),
  '&:hover': {
    boxShadow: theme.shadows[4],
    transform: 'translateY(-2px)'
  },
  ...(isDragging && {
    transform: 'rotate(5deg)',
    boxShadow: theme.shadows[8]
  })
}));
```

#### 3.5.4 å›¾æ ‡å’Œè§†è§‰å…ƒç´ 

```jsx
import {
  Add as AddIcon,
  Edit as EditIcon,
  Delete as DeleteIcon,
  Folder as FolderIcon,
  Note as NoteIcon,
  DragIndicator as DragIcon
} from '@mui/icons-material';

const ToolbarActions = () => (
  <Box display="flex" gap={1}>
    <IconButton color="primary" onClick={handleAddNote}>
      <AddIcon />
    </IconButton>
    <IconButton color="secondary" onClick={handleDeleteNote}>
      <DeleteIcon />
    </IconButton>
  </Box>
);
```

#### 3.5.5 Material-UIé›†æˆä¼˜åŠ¿

**1. ä¸€è‡´çš„è®¾è®¡è¯­è¨€**
- éµå¾ªGoogle Material Designè§„èŒƒ
- æä¾›å®Œæ•´çš„è§†è§‰è®¾è®¡ç³»ç»Ÿ

**2. ä¸°å¯Œçš„ç»„ä»¶ç”Ÿæ€**
- è¦†ç›–å¸¸è§UIéœ€æ±‚çš„ç»„ä»¶åº“
- æ”¯æŒä¸»é¢˜å®šåˆ¶å’Œå“åº”å¼è®¾è®¡

**3. å¯è®¿é—®æ€§æ”¯æŒ**
- å†…ç½®ARIAå±æ€§å’Œé”®ç›˜å¯¼èˆª
- ç¬¦åˆWebå¯è®¿é—®æ€§æ ‡å‡†

**4. TypeScriptæ”¯æŒ**
- å®Œæ•´çš„ç±»å‹å®šä¹‰
- ä¼˜ç§€çš„å¼€å‘ä½“éªŒå’Œç±»å‹å®‰å…¨

## 4. å‰åç«¯äº¤äº’æœºåˆ¶

å‰åç«¯é€šè¿‡HTTPåè®®è¿›è¡Œé€šä¿¡ï¼Œé‡‡ç”¨RESTful APIæ¶æ„é£æ ¼ï¼Œç¡®ä¿æ•°æ®ä¼ è¾“çš„å¯é æ€§å’Œä¸€è‡´æ€§ã€‚

### 4.1 HTTPé€šä¿¡åè®®

#### 4.1.1 é€šä¿¡æ¶æ„

```
Reactå‰ç«¯ â†â”€â”€HTTP/HTTPSâ”€â”€â†’ Flaskåç«¯ â†â”€â”€SQLAlchemyâ”€â”€â†’ SQLiteæ•°æ®åº“
```

**é€šä¿¡ç‰¹ç‚¹ï¼š**
- **æ— çŠ¶æ€æ€§**: æ¯ä¸ªHTTPè¯·æ±‚éƒ½æ˜¯ç‹¬ç«‹çš„ï¼ŒåŒ…å«å®Œæ•´çš„ä¿¡æ¯
- **è¯·æ±‚-å“åº”æ¨¡å¼**: å‰ç«¯å‘èµ·è¯·æ±‚ï¼Œåç«¯å¤„ç†å¹¶è¿”å›å“åº”
- **æ ‡å‡†åŒ–**: ä½¿ç”¨æ ‡å‡†HTTPæ–¹æ³•å’ŒçŠ¶æ€ç 

#### 4.1.2 æ”¯æŒçš„HTTPæ–¹æ³•

| HTTPæ–¹æ³• | ç”¨é€” | ç¤ºä¾‹ |
|---------|------|------|
| GET | è·å–èµ„æº | è·å–ç¬”è®°åˆ—è¡¨ã€æ–‡ä»¶å¤¹ä¿¡æ¯ |
| POST | åˆ›å»ºèµ„æº | åˆ›å»ºæ–°ç¬”è®°ã€æ–°æ–‡ä»¶å¤¹ |
| PUT | æ›´æ–°èµ„æº | æ›´æ–°ç¬”è®°å†…å®¹ã€é‡å‘½åæ–‡ä»¶å¤¹ |
| DELETE | åˆ é™¤èµ„æº | åˆ é™¤ç¬”è®°ã€åˆ é™¤æ–‡ä»¶å¤¹ |
| PATCH | éƒ¨åˆ†æ›´æ–° | æ›´æ–°ç¬”è®°é¡ºåºã€çŠ¶æ€å­—æ®µ |

#### 4.1.3 è¯·æ±‚å¤´é…ç½®

```javascript
// é»˜è®¤è¯·æ±‚å¤´é…ç½®
const defaultHeaders = {
  'Content-Type': 'application/json',
  'Accept': 'application/json',
  'X-Requested-With': 'XMLHttpRequest'
};
```

### 4.2 RESTful APIè®¾è®¡è§„èŒƒ

#### 4.2.1 URLè®¾è®¡åŸåˆ™

**1. èµ„æºå¯¼å‘è®¾è®¡**
```
/api/folders               # æ–‡ä»¶å¤¹é›†åˆ
/api/folders/{id}          # ç‰¹å®šæ–‡ä»¶å¤¹
/api/folders/{id}/files    # æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶
/api/files/{id}/notes      # æ–‡ä»¶ä¸‹çš„ç¬”è®°
/api/notes/{id}            # ç‰¹å®šç¬”è®°
```

**2. å±‚çº§å…³ç³»è¡¨è¾¾**
```
GET /api/folders/1/files/2/notes    # è·å–ç‰¹å®šæ–‡ä»¶ä¸‹çš„æ‰€æœ‰ç¬”è®°
POST /api/folders/1/files           # åœ¨ç‰¹å®šæ–‡ä»¶å¤¹ä¸‹åˆ›å»ºæ–‡ä»¶
PUT /api/notes/3                    # æ›´æ–°ç‰¹å®šç¬”è®°
```

#### 4.2.2 APIç«¯ç‚¹è¯¦è§£

**æ–‡ä»¶å¤¹æ“ä½œ API**
```javascript
// è·å–æ‰€æœ‰æ–‡ä»¶å¤¹
GET /api/folders
Response: [
  {
    "id": 1,
    "name": "å·¥ä½œç¬”è®°",
    "created_at": "2025-06-02T10:00:00",
    "files": [...]
  }
]

// åˆ›å»ºæ–°æ–‡ä»¶å¤¹
POST /api/folders
Body: {
  "name": "æ–°æ–‡ä»¶å¤¹"
}
Response: {
  "id": 2,
  "name": "æ–°æ–‡ä»¶å¤¹",
  "created_at": "2025-06-02T11:00:00"
}
```

**ç¬”è®°æ–‡ä»¶æ“ä½œ API**
```javascript
// è·å–æ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰æ–‡ä»¶
GET /api/folders/1/files
Response: [
  {
    "id": 1,
    "name": "æ—¥å¸¸ç¬”è®°.md",
    "format": "markdown",
    "created_at": "2025-06-02T10:00:00",
    "notes_count": 5
  }
]

// åœ¨æ–‡ä»¶å¤¹ä¸‹åˆ›å»ºæ–°æ–‡ä»¶
POST /api/folders/1/files
Body: {
  "name": "æ–°ç¬”è®°æ–‡ä»¶",
  "format": "markdown"
}
```

**ç¬”è®°æ“ä½œ API**
```javascript
// è·å–æ–‡ä»¶ä¸‹çš„æ‰€æœ‰ç¬”è®°
GET /api/files/1/notes
Response: [
  {
    "id": 1,
    "content": "ç¬”è®°å†…å®¹",
    "format": "text",
    "order": 1,
    "created_at": "2025-06-02T10:00:00",
    "updated_at": "2025-06-02T10:30:00"
  }
]

// åˆ›å»ºæ–°ç¬”è®°
POST /api/files/1/notes
Body: {
  "content": "æ–°ç¬”è®°å†…å®¹",
  "format": "text",
  "after_note_id": 2  // åœ¨æŒ‡å®šç¬”è®°åæ’å…¥
}

// æ›´æ–°ç¬”è®°
PUT /api/notes/1
Body: {
  "content": "æ›´æ–°åçš„å†…å®¹",
  "format": "markdown"
}

// é‡æ–°æ’åºç¬”è®°
PATCH /api/notes/reorder
Body: {
  "note_ids": [3, 1, 2]  // æ–°çš„æ’åº
}
```

#### 4.2.3 æŸ¥è¯¢å‚æ•°æ”¯æŒ

```javascript
// åˆ†é¡µæŸ¥è¯¢
GET /api/files/1/notes?page=1&limit=20

// æ ¼å¼è¿‡æ»¤
GET /api/files/1/notes?format=markdown

// æ’åºé€‰é¡¹
GET /api/files/1/notes?sort=created_at&order=desc

// æœç´¢åŠŸèƒ½
GET /api/files/1/notes?search=å…³é”®è¯
```

### 4.3 æ•°æ®ä¼ è¾“æ ¼å¼

#### 4.3.1 JSONæ•°æ®æ ¼å¼

é¡¹ç›®ç»Ÿä¸€ä½¿ç”¨JSONæ ¼å¼è¿›è¡Œæ•°æ®ä¼ è¾“ï¼Œç¡®ä¿è·¨å¹³å°å…¼å®¹æ€§ã€‚

**è¯·æ±‚æ•°æ®æ ¼å¼**
```javascript
// åˆ›å»ºç¬”è®°è¯·æ±‚
{
  "content": "ç¬”è®°å†…å®¹",
  "format": "markdown",
  "after_note_id": 5
}

// æ›´æ–°ç¬”è®°è¯·æ±‚
{
  "content": "æ›´æ–°å†…å®¹",
  "format": "text"
}
```

**å“åº”æ•°æ®æ ¼å¼**
```javascript
// æˆåŠŸå“åº”
{
  "id": 1,
  "content": "ç¬”è®°å†…å®¹",
  "format": "markdown",
  "order": 3,
  "created_at": "2025-06-02T10:00:00",
  "updated_at": "2025-06-02T10:30:00",
  "file_id": 1
}

// æ‰¹é‡æ•°æ®å“åº”
{
  "data": [...],
  "total": 50,
  "page": 1,
  "limit": 20
}
```

#### 4.3.2 æ•°æ®éªŒè¯è§„åˆ™

**å‰ç«¯éªŒè¯**
```javascript
// ä½¿ç”¨Yupè¿›è¡Œæ•°æ®éªŒè¯
const noteSchema = yup.object().shape({
  content: yup.string().required('ç¬”è®°å†…å®¹ä¸èƒ½ä¸ºç©º'),
  format: yup.string().oneOf(['text', 'markdown'], 'ä¸æ”¯æŒçš„æ ¼å¼'),
  after_note_id: yup.number().nullable()
});
```

**åç«¯éªŒè¯**
```python
# Flask-WTFè¡¨å•éªŒè¯
class NoteForm(FlaskForm):
    content = StringField('å†…å®¹', validators=[DataRequired()])
    format = SelectField('æ ¼å¼', choices=[('text', 'çº¯æ–‡æœ¬'), ('markdown', 'Markdown')])
    after_note_id = IntegerField('ä½ç½®', validators=[Optional()])
```

#### 4.3.3 æ—¥æœŸæ—¶é—´æ ¼å¼

```javascript
// ç»Ÿä¸€ä½¿ç”¨ISO 8601æ ¼å¼
"created_at": "2025-06-02T10:00:00.000Z"
"updated_at": "2025-06-02T10:30:15.123Z"

// å‰ç«¯æ—¥æœŸå¤„ç†
const formatDate = (dateString) => {
  return new Date(dateString).toLocaleString('zh-CN', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit'
  });
};
```

### 4.4 è·¨åŸŸèµ„æºå…±äº«(CORS)é…ç½®

#### 4.4.1 CORSé…ç½®åŸç†

ç”±äºå‰ç«¯(localhost:3000)å’Œåç«¯(localhost:5000)è¿è¡Œåœ¨ä¸åŒç«¯å£ï¼Œéœ€è¦é…ç½®CORSè§£å†³è·¨åŸŸé—®é¢˜ã€‚

**å¼€å‘ç¯å¢ƒé…ç½®**
```python
# app/__init__.py
from flask_cors import CORS

def create_app():
    app = Flask(__name__)
    
    # å¼€å‘ç¯å¢ƒCORSé…ç½®
    CORS(app, resources={
        r"/api/*": {
            "origins": ["http://localhost:3000"],
            "methods": ["GET", "POST", "PUT", "DELETE", "PATCH"],
            "allow_headers": ["Content-Type", "Authorization"]
        }
    })
    
    return app
```

#### 4.4.2 ç”Ÿäº§ç¯å¢ƒå®‰å…¨é…ç½®

```python
# ç”Ÿäº§ç¯å¢ƒæ›´ä¸¥æ ¼çš„CORSé…ç½®
import os

def configure_cors(app):
    if app.config['ENV'] == 'production':
        CORS(app, resources={
            r"/api/*": {
                "origins": [os.getenv('FRONTEND_URL', 'https://yourdomain.com')],
                "methods": ["GET", "POST", "PUT", "DELETE"],
                "allow_headers": ["Content-Type"],
                "supports_credentials": False
            }
        })
    else:
        # å¼€å‘ç¯å¢ƒå®½æ¾é…ç½®
        CORS(app)
```

#### 4.4.3 é¢„æ£€è¯·æ±‚å¤„ç†

```python
# å¤„ç†OPTIONSé¢„æ£€è¯·æ±‚
@app.before_request
def handle_preflight():
    if request.method == "OPTIONS":
        response = Response()
        response.headers.add("Access-Control-Allow-Origin", "http://localhost:3000")
        response.headers.add('Access-Control-Allow-Headers', "Content-Type,Authorization")
        response.headers.add('Access-Control-Allow-Methods', "GET,PUT,POST,DELETE,PATCH")
        return response
```

### 4.5 é”™è¯¯å¤„ç†ä¸çŠ¶æ€ç 

#### 4.5.1 HTTPçŠ¶æ€ç è§„èŒƒ

| çŠ¶æ€ç  | å«ä¹‰ | ä½¿ç”¨åœºæ™¯ |
|-------|------|---------|
| 200 | æˆåŠŸ | è¯·æ±‚æˆåŠŸå¤„ç† |
| 201 | å·²åˆ›å»º | èµ„æºåˆ›å»ºæˆåŠŸ |
| 204 | æ— å†…å®¹ | åˆ é™¤æ“ä½œæˆåŠŸ |
| 400 | è¯·æ±‚é”™è¯¯ | å‚æ•°éªŒè¯å¤±è´¥ |
| 404 | æœªæ‰¾åˆ° | èµ„æºä¸å­˜åœ¨ |
| 409 | å†²çª | èµ„æºå†²çªï¼ˆå¦‚é‡åï¼‰ |
| 422 | æ— æ³•å¤„ç† | æ•°æ®æ ¼å¼æ­£ç¡®ä½†é€»è¾‘é”™è¯¯ |
| 500 | æœåŠ¡å™¨é”™è¯¯ | å†…éƒ¨æœåŠ¡å™¨é”™è¯¯ |

#### 4.5.2 é”™è¯¯å“åº”æ ¼å¼

**æ ‡å‡†é”™è¯¯å“åº”ç»“æ„**
```javascript
{
  "error": "error_type",
  "message": "ç”¨æˆ·å‹å¥½çš„é”™è¯¯æè¿°",
  "details": {
    "field": "å…·ä½“é”™è¯¯å­—æ®µ",
    "code": "ERROR_CODE",
    "timestamp": "2025-06-02T10:00:00Z"
  }
}
```

**å…·ä½“é”™è¯¯ç¤ºä¾‹**
```javascript
// å‚æ•°éªŒè¯é”™è¯¯ (400)
{
  "error": "validation_error",
  "message": "ç¬”è®°å†…å®¹ä¸èƒ½ä¸ºç©º",
  "details": {
    "field": "content",
    "code": "REQUIRED_FIELD",
    "timestamp": "2025-06-02T10:00:00Z"
  }
}

// èµ„æºæœªæ‰¾åˆ° (404)
{
  "error": "not_found",
  "message": "æŒ‡å®šçš„ç¬”è®°ä¸å­˜åœ¨",
  "details": {
    "resource": "note",
    "id": 123,
    "code": "NOTE_NOT_FOUND"
  }
}

// æœåŠ¡å™¨é”™è¯¯ (500)
{
  "error": "internal_error",
  "message": "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•",
  "details": {
    "code": "DATABASE_ERROR",
    "reference": "error_id_12345"
  }
}
```

#### 4.5.3 å‰ç«¯é”™è¯¯å¤„ç†æœºåˆ¶

**APIæœåŠ¡å±‚é”™è¯¯å¤„ç†**
```javascript
// services/noteService.js
class ApiError extends Error {
  constructor(response, message) {
    super(message);
    this.response = response;
    this.status = response.status;
    this.data = response.data;
  }
}

const handleApiError = (error) => {
  if (error.response) {
    // æœåŠ¡å™¨è¿”å›é”™è¯¯å“åº”
    const { status, data } = error.response;
    switch (status) {
      case 400:
        return new ApiError(error.response, data.message || 'è¯·æ±‚å‚æ•°é”™è¯¯');
      case 404:
        return new ApiError(error.response, data.message || 'èµ„æºæœªæ‰¾åˆ°');
      case 500:
        return new ApiError(error.response, 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
      default:
        return new ApiError(error.response, data.message || 'æœªçŸ¥é”™è¯¯');
    }
  } else if (error.request) {
    // ç½‘ç»œé”™è¯¯
    return new Error('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®');
  } else {
    // å…¶ä»–é”™è¯¯
    return new Error('è¯·æ±‚é…ç½®é”™è¯¯');
  }
};
```

**ç»„ä»¶çº§é”™è¯¯å¤„ç†**
```javascript
// hooks/useErrorHandler.js
const useErrorHandler = () => {
  const [error, setError] = useState(null);
  
  const handleError = useCallback((error) => {
    console.error('API Error:', error);
    
    if (error instanceof ApiError) {
      // æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºä¸åŒæ¶ˆæ¯
      switch (error.status) {
        case 400:
          setError('è¯·æ±‚å‚æ•°æœ‰è¯¯ï¼Œè¯·æ£€æŸ¥è¾“å…¥');
          break;
        case 404:
          setError('è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨');
          break;
        case 409:
          setError('æ“ä½œå†²çªï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
          break;
        default:
          setError(error.message);
      }
    } else {
      setError('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    }
  }, []);
  
  return { error, handleError, clearError: () => setError(null) };
};
```

#### 4.5.4 åç«¯é”™è¯¯å¤„ç†å®ç°

**å…¨å±€é”™è¯¯å¤„ç†å™¨**
```python
# app/error_handlers.py
from flask import jsonify
from datetime import datetime

@app.errorhandler(ValidationError)
def handle_validation_error(error):
    return jsonify({
        'error': 'validation_error',
        'message': str(error),
        'details': {
            'field': getattr(error, 'field', None),
            'code': 'VALIDATION_FAILED',
            'timestamp': datetime.utcnow().isoformat()
        }
    }), 400

@app.errorhandler(404)
def handle_not_found(error):
    return jsonify({
        'error': 'not_found',
        'message': 'è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨',
        'details': {
            'code': 'RESOURCE_NOT_FOUND',
            'timestamp': datetime.utcnow().isoformat()
        }
    }), 404

@app.errorhandler(500)
def handle_internal_error(error):
    db.session.rollback()
    return jsonify({
        'error': 'internal_error',
        'message': 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•',
        'details': {
            'code': 'INTERNAL_SERVER_ERROR',
            'timestamp': datetime.utcnow().isoformat()
        }
    }), 500
```

**ä¸šåŠ¡é€»è¾‘é”™è¯¯å¤„ç†**
```python
# app/api/notes.py
@notes_bp.route('/<int:note_id>', methods=['PUT'])
def update_note(note_id):
    try:
        note = Note.query.get_or_404(note_id)
        data = request.get_json()
        
        # æ•°æ®éªŒè¯
        if not data.get('content'):
            return jsonify({
                'error': 'validation_error',
                'message': 'ç¬”è®°å†…å®¹ä¸èƒ½ä¸ºç©º',
                'details': {
                    'field': 'content',
                    'code': 'REQUIRED_FIELD'
                }
            }), 400
        
        # æ›´æ–°æ“ä½œ
        note.content = data['content']
        note.format = data.get('format', note.format)
        note.updated_at = datetime.utcnow()
        
        db.session.commit()
        
        return jsonify(note.to_dict()), 200
        
    except Exception as e:
        db.session.rollback()
        current_app.logger.error(f"Update note error: {str(e)}")
        return jsonify({
            'error': 'internal_error',
            'message': 'æ›´æ–°ç¬”è®°å¤±è´¥',
            'details': {
                'code': 'UPDATE_FAILED',
                'reference': str(uuid.uuid4())
            }
        }), 500
```

è¿™æ ·çš„å‰åç«¯äº¤äº’æœºåˆ¶ç¡®ä¿äº†ï¼š
- **æ•°æ®ä¼ è¾“çš„å¯é æ€§**ï¼šé€šè¿‡HTTPåè®®å’ŒJSONæ ¼å¼
- **æ¥å£è®¾è®¡çš„ä¸€è‡´æ€§**ï¼šéµå¾ªRESTfulè§„èŒƒ
- **é”™è¯¯å¤„ç†çš„å®Œæ•´æ€§**ï¼šè¦†ç›–å„ç§å¼‚å¸¸æƒ…å†µ
- **è·¨åŸŸè®¿é—®çš„å®‰å…¨æ€§**ï¼šåˆç†çš„CORSé…ç½®
- **å¼€å‘è°ƒè¯•çš„ä¾¿åˆ©æ€§**ï¼šè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’ŒçŠ¶æ€ç 

## 5. æ•°æ®åº“è®¾è®¡ä¸æ“ä½œ

é¡¹ç›®é‡‡ç”¨SQLiteä½œä¸ºæ•°æ®åº“ï¼Œé€šè¿‡SQLAlchemy ORMè¿›è¡Œæ•°æ®ç®¡ç†ï¼Œå®ç°äº†çµæ´»çš„æ•°æ®æ¨¡å‹è®¾è®¡å’Œé«˜æ•ˆçš„æ•°æ®æ“ä½œã€‚

### 5.1 SQLiteæ•°æ®åº“é€‰æ‹©

#### 5.1.1 é€‰æ‹©SQLiteçš„åŸå› 

**1. è½»é‡çº§ç‰¹æ€§**
- **æ— æœåŠ¡å™¨æ¶æ„**ï¼šSQLiteæ˜¯ä¸€ä¸ªåµŒå…¥å¼æ•°æ®åº“ï¼Œä¸éœ€è¦å•ç‹¬çš„æ•°æ®åº“æœåŠ¡å™¨
- **é›¶é…ç½®**ï¼šæ— éœ€å®‰è£…å’Œé…ç½®ï¼Œå¼€ç®±å³ç”¨
- **å•æ–‡ä»¶å­˜å‚¨**ï¼šæ•´ä¸ªæ•°æ®åº“å­˜å‚¨åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œä¾¿äºå¤‡ä»½å’Œè¿ç§»

**2. é€‚ç”¨åœºæ™¯åŒ¹é…**
```python
# é¡¹ç›®ç‰¹ç‚¹ä¸SQLiteçš„åŒ¹é…åº¦
é¡¹ç›®è§„æ¨¡: ä¸­å°å‹ç¬”è®°åº”ç”¨         âœ“ SQLiteé€‚åˆä¸­å°å‹åº”ç”¨
å¹¶å‘éœ€æ±‚: å•ç”¨æˆ·æˆ–å°‘é‡ç”¨æˆ·       âœ“ SQLiteæ”¯æŒè¯»å¹¶å‘ï¼Œå†™æ“ä½œä¸²è¡ŒåŒ–
æ•°æ®é‡: ç›¸å¯¹è¾ƒå°çš„ç¬”è®°æ•°æ®       âœ“ SQLiteåœ¨å‡ GBæ•°æ®å†…æ€§èƒ½ä¼˜ç§€
éƒ¨ç½²ä¾¿åˆ©æ€§: éœ€è¦ç®€å•éƒ¨ç½²        âœ“ SQLiteæ— éœ€é¢å¤–æ•°æ®åº“æœåŠ¡
```

**3. æŠ€æœ¯ä¼˜åŠ¿**
- **ACIDæ”¯æŒ**ï¼šå®Œæ•´çš„äº‹åŠ¡å¤„ç†èƒ½åŠ›
- **æ ‡å‡†SQL**ï¼šæ”¯æŒSQL-92æ ‡å‡†ï¼Œä¾¿äºå¼€å‘
- **è·¨å¹³å°**ï¼šåœ¨Windowsã€Linuxã€macOSä¸Šéƒ½èƒ½è¿è¡Œ
- **Pythoné›†æˆ**ï¼šPythonå†…ç½®sqlite3æ¨¡å—ï¼Œå¤©ç„¶æ”¯æŒ

#### 5.1.2 æ•°æ®åº“é…ç½®

**åŸºç¡€é…ç½®**
```python
# app/config/config.py
import os

basedir = os.path.abspath(os.path.dirname(os.path.dirname(os.path.dirname(__file__))))

class Config:
    # æ•°æ®åº“URIé…ç½®
    SQLALCHEMY_DATABASE_URI = os.environ.get('DATABASE_URL') or \
        'sqlite:///' + os.path.join(basedir, 'notes.db')
    
    # å…³é—­ä¿®æ”¹è·Ÿè¸ªï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
    SQLALCHEMY_TRACK_MODIFICATIONS = False
    
    # æ•°æ®åº“è¿æ¥æ± é…ç½®
    SQLALCHEMY_ENGINE_OPTIONS = {
        'pool_pre_ping': True,           # è¿æ¥é¢„æ£€æŸ¥
        'pool_recycle': 3600,           # è¿æ¥å›æ”¶æ—¶é—´ï¼ˆ1å°æ—¶ï¼‰
        'connect_args': {
            'check_same_thread': False,  # å…è®¸å¤šçº¿ç¨‹è®¿é—®
            'timeout': 20               # è¿æ¥è¶…æ—¶æ—¶é—´
        }
    }
```

**ç¯å¢ƒç‰¹å®šé…ç½®**
```python
class DevelopmentConfig(Config):
    """å¼€å‘ç¯å¢ƒé…ç½®"""
    DEBUG = True
    SQLALCHEMY_DATABASE_URI = 'sqlite:///' + os.path.join(basedir, 'notes_dev.db')

class TestingConfig(Config):
    """æµ‹è¯•ç¯å¢ƒé…ç½®"""
    TESTING = True
    SQLALCHEMY_DATABASE_URI = 'sqlite:///:memory:'  # å†…å­˜æ•°æ®åº“ï¼Œæµ‹è¯•å®Œè‡ªåŠ¨æ¸…ç†

class ProductionConfig(Config):
    """ç”Ÿäº§ç¯å¢ƒé…ç½®"""
    SQLALCHEMY_DATABASE_URI = os.environ.get('DATABASE_URL') or \
        'sqlite:///' + os.path.join(basedir, 'notes_prod.db')
```

#### 5.1.3 æ•°æ®åº“æ–‡ä»¶ç®¡ç†

**æ–‡ä»¶ä½ç½®ç­–ç•¥**
```
NotesApplication/
â”œâ”€â”€ notes.db              # ç”Ÿäº§ç¯å¢ƒæ•°æ®åº“
â”œâ”€â”€ notes_dev.db          # å¼€å‘ç¯å¢ƒæ•°æ®åº“
â””â”€â”€ backups/              # æ•°æ®åº“å¤‡ä»½ç›®å½•
    â”œâ”€â”€ notes_20250602.db
    â””â”€â”€ notes_20250601.db
```

**å¤‡ä»½ç­–ç•¥**
```python
# æ•°æ®åº“å¤‡ä»½å·¥å…·
import shutil
from datetime import datetime

def backup_database():
    """åˆ›å»ºæ•°æ®åº“å¤‡ä»½"""
    source = os.path.join(basedir, 'notes.db')
    timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
    backup_name = f'notes_backup_{timestamp}.db'
    backup_path = os.path.join(basedir, 'backups', backup_name)
    
    if os.path.exists(source):
        os.makedirs(os.path.dirname(backup_path), exist_ok=True)
        shutil.copy2(source, backup_path)
        return backup_path
    return None
```

### 5.2 æ•°æ®è¡¨ç»“æ„è®¾è®¡

#### 5.2.1 è¡¨ç»“æ„æ¦‚è§ˆ

é¡¹ç›®åŒ…å«ä¸‰ä¸ªæ ¸å¿ƒæ•°æ®è¡¨ï¼Œå½¢æˆæ¸…æ™°çš„å±‚æ¬¡ç»“æ„ï¼š

```
folders (æ–‡ä»¶å¤¹è¡¨)
    â†“ 1:N
note_files (ç¬”è®°æ–‡ä»¶è¡¨)
    â†“ 1:N
notes (ç¬”è®°è¡¨)
```

#### 5.2.2 foldersè¡¨è®¾è®¡

**è¡¨ç»“æ„å®šä¹‰**
```sql
CREATE TABLE folders (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(100) NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**å­—æ®µè¯´æ˜**
| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|------|------|------|
| id | INTEGER | ä¸»é”®ï¼Œè‡ªå¢ | æ–‡ä»¶å¤¹å”¯ä¸€æ ‡è¯†ç¬¦ |
| name | VARCHAR(100) | éç©º | æ–‡ä»¶å¤¹åç§°ï¼Œæ”¯æŒä¸­æ–‡ |
| created_at | DATETIME | é»˜è®¤å½“å‰æ—¶é—´ | åˆ›å»ºæ—¶é—´æˆ³ |
| updated_at | DATETIME | è‡ªåŠ¨æ›´æ–° | æœ€åæ›´æ–°æ—¶é—´æˆ³ |

**Pythonæ¨¡å‹å®šä¹‰**
```python
class Folder(db.Model):
    __tablename__ = 'folders'

    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100), nullable=False)
    created_at = db.Column(db.DateTime, default=db.func.current_timestamp())
    updated_at = db.Column(db.DateTime, 
                          default=db.func.current_timestamp(), 
                          onupdate=db.func.current_timestamp())
    
    # å…³è”å…³ç³»
    files = db.relationship('NoteFile', backref='folder', lazy=True)

    def to_dict(self):
        return {
            'id': self.id,
            'name': self.name,
            'created_at': self.created_at.isoformat(),
            'updated_at': self.updated_at.isoformat(),
            'files_count': len(self.files) if self.files else 0
        }
```

#### 5.2.3 note_filesè¡¨è®¾è®¡

**è¡¨ç»“æ„å®šä¹‰**
```sql
CREATE TABLE note_files (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(200) NOT NULL,
    order_index INTEGER DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    folder_id INTEGER,
    FOREIGN KEY (folder_id) REFERENCES folders (id)
);
```

**å­—æ®µè¯´æ˜**
| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|------|------|------|
| id | INTEGER | ä¸»é”®ï¼Œè‡ªå¢ | ç¬”è®°æ–‡ä»¶å”¯ä¸€æ ‡è¯†ç¬¦ |
| name | VARCHAR(200) | éç©º | ç¬”è®°æ–‡ä»¶åç§° |
| order_index | INTEGER | é»˜è®¤0 | æ–‡ä»¶æ˜¾ç¤ºé¡ºåº |
| created_at | DATETIME | é»˜è®¤å½“å‰æ—¶é—´ | åˆ›å»ºæ—¶é—´æˆ³ |
| updated_at | DATETIME | è‡ªåŠ¨æ›´æ–° | æœ€åæ›´æ–°æ—¶é—´æˆ³ |
| folder_id | INTEGER | å¤–é”®ï¼Œå¯ç©º | æ‰€å±æ–‡ä»¶å¤¹ID |

**Pythonæ¨¡å‹å®šä¹‰**
```python
class NoteFile(db.Model):
    __tablename__ = 'note_files'

    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(200), nullable=False)
    order = db.Column(db.Integer, default=0)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    folder_id = db.Column(db.Integer, db.ForeignKey('folders.id'), nullable=True)
    
    # å…³è”å…³ç³»
    notes = db.relationship('Note', backref='note_file', lazy=True, 
                           cascade='all, delete-orphan')

    def to_dict(self):
        return {
            'id': self.id,
            'name': self.name,
            'order': self.order,
            'created_at': self.created_at.isoformat(),
            'updated_at': self.updated_at.isoformat(),
            'folder_id': self.folder_id,
            'notes_count': len(self.notes) if self.notes else 0
        }
```

#### 5.2.4 notesè¡¨è®¾è®¡

**è¡¨ç»“æ„å®šä¹‰**
```sql
CREATE TABLE notes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    content TEXT,
    format VARCHAR(20) DEFAULT 'text',
    order_index INTEGER DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    file_id INTEGER NOT NULL,
    FOREIGN KEY (file_id) REFERENCES note_files (id) ON DELETE CASCADE
);
```

**å­—æ®µè¯´æ˜**
| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|------|------|------|
| id | INTEGER | ä¸»é”®ï¼Œè‡ªå¢ | ç¬”è®°å”¯ä¸€æ ‡è¯†ç¬¦ |
| content | TEXT | å¯ç©º | ç¬”è®°å†…å®¹ï¼Œæ”¯æŒå¤§æ–‡æœ¬ |
| format | VARCHAR(20) | é»˜è®¤'text' | ç¬”è®°æ ¼å¼ç±»å‹ |
| order_index | INTEGER | é»˜è®¤0 | ç¬”è®°åœ¨æ–‡ä»¶ä¸­çš„é¡ºåº |
| created_at | DATETIME | é»˜è®¤å½“å‰æ—¶é—´ | åˆ›å»ºæ—¶é—´æˆ³ |
| updated_at | DATETIME | è‡ªåŠ¨æ›´æ–° | æœ€åæ›´æ–°æ—¶é—´æˆ³ |
| file_id | INTEGER | å¤–é”®ï¼Œéç©ºï¼Œçº§è”åˆ é™¤ | æ‰€å±æ–‡ä»¶ID |

**æ”¯æŒçš„æ ¼å¼ç±»å‹**
```python
# ç¬”è®°æ ¼å¼æšä¸¾
NOTE_FORMATS = {
    'text': 'çº¯æ–‡æœ¬',
    'h1': 'ä¸€çº§æ ‡é¢˜',
    'h2': 'äºŒçº§æ ‡é¢˜', 
    'h3': 'ä¸‰çº§æ ‡é¢˜',
    'h4': 'å››çº§æ ‡é¢˜',
    'h5': 'äº”çº§æ ‡é¢˜',
    'h6': 'å…­çº§æ ‡é¢˜',
    'markdown': 'Markdownæ ¼å¼',
    'code': 'ä»£ç å—',
    'quote': 'å¼•ç”¨å—',
    'list': 'æ— åºåˆ—è¡¨',
    'ordered_list': 'æœ‰åºåˆ—è¡¨'
}
```

**Pythonæ¨¡å‹å®šä¹‰**
```python
class Note(db.Model):
    __tablename__ = 'notes'
    
    id = db.Column(db.Integer, primary_key=True)
    content = db.Column(db.Text)
    format = db.Column(db.String(20), default='text')
    order = db.Column(db.Integer, default=0)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    file_id = db.Column(db.Integer, db.ForeignKey('note_files.id', ondelete='CASCADE'))

    def to_dict(self):
        return {
            'id': self.id,
            'content': self.content,
            'format': self.format,
            'order': self.order,
            'created_at': self.created_at.isoformat(),
            'updated_at': self.updated_at.isoformat(),
            'file_id': self.file_id
        }
```

### 5.3 æ•°æ®æ¨¡å‹å…³ç³»

#### 5.3.1 å…³ç³»è®¾è®¡åŸç†

**å±‚æ¬¡åŒ–ç»“æ„**
```
Folder (æ–‡ä»¶å¤¹) 1 â”€â”€â†’ N NoteFile (ç¬”è®°æ–‡ä»¶) 1 â”€â”€â†’ N Note (ç¬”è®°)
```

è¿™ç§è®¾è®¡æä¾›äº†ï¼š
- **é€»è¾‘æ¸…æ™°**ï¼šç¬¦åˆç”¨æˆ·çš„è®¤çŸ¥æ¨¡å‹
- **æ•°æ®ç»„ç»‡**ï¼šä¾¿äºåˆ†ç±»å’Œç®¡ç†
- **æ‰©å±•æ€§**ï¼šæ˜“äºæ·»åŠ æ–°çš„å±‚çº§æˆ–åŠŸèƒ½

#### 5.3.2 å¤–é”®çº¦æŸè®¾è®¡

**1. Folder â†’ NoteFileå…³ç³»**
```python
# NoteFileæ¨¡å‹ä¸­çš„å¤–é”®å®šä¹‰
folder_id = db.Column(db.Integer, db.ForeignKey('folders.id'), nullable=True)

# Folderæ¨¡å‹ä¸­çš„åå‘å…³ç³»
files = db.relationship('NoteFile', backref='folder', lazy=True)
```

**ç‰¹æ€§ï¼š**
- `nullable=True`ï¼šå…è®¸æ–‡ä»¶ä¸å±äºä»»ä½•æ–‡ä»¶å¤¹ï¼ˆæ ¹çº§æ–‡ä»¶ï¼‰
- `backref='folder'`ï¼šåœ¨NoteFileå¯¹è±¡ä¸Šæä¾›`.folder`å±æ€§
- `lazy=True`ï¼šå»¶è¿ŸåŠ è½½ï¼Œæé«˜æ€§èƒ½

**2. NoteFile â†’ Noteå…³ç³»**
```python
# Noteæ¨¡å‹ä¸­çš„å¤–é”®å®šä¹‰
file_id = db.Column(db.Integer, db.ForeignKey('note_files.id', ondelete='CASCADE'))

# NoteFileæ¨¡å‹ä¸­çš„åå‘å…³ç³»
notes = db.relationship('Note', backref='note_file', lazy=True, 
                       cascade='all, delete-orphan')
```

**ç‰¹æ€§ï¼š**
- `ondelete='CASCADE'`ï¼šåˆ é™¤æ–‡ä»¶æ—¶è‡ªåŠ¨åˆ é™¤æ‰€æœ‰ç¬”è®°
- `cascade='all, delete-orphan'`ï¼šORMçº§åˆ«çš„çº§è”åˆ é™¤
- `nullable=False`ï¼ˆéšå¼ï¼‰ï¼šç¬”è®°å¿…é¡»å±äºæŸä¸ªæ–‡ä»¶

#### 5.3.3 çº§è”æ“ä½œå¤„ç†

**åˆ é™¤çº§è”**
```python
# åˆ é™¤æ–‡ä»¶å¤¹æ—¶çš„å¤„ç†æµç¨‹
def delete_folder_cascade(folder_id):
    folder = Folder.query.get_or_404(folder_id)
    
    # 1. è·å–æ‰€æœ‰ç›¸å…³æ–‡ä»¶
    files = NoteFile.query.filter_by(folder_id=folder_id).all()
    
    # 2. ç»Ÿè®¡å½±å“èŒƒå›´
    total_notes = sum(len(file.notes) for file in files)
    
    # 3. æ‰§è¡Œåˆ é™¤ï¼ˆè‡ªåŠ¨çº§è”ï¼‰
    db.session.delete(folder)
    db.session.commit()
    
    return {
        'deleted_files': len(files),
        'deleted_notes': total_notes
    }
```

**ç§»åŠ¨æ“ä½œ**
```python
# å°†æ–‡ä»¶ç§»åŠ¨åˆ°å…¶ä»–æ–‡ä»¶å¤¹
def move_file_to_folder(file_id, target_folder_id):
    note_file = NoteFile.query.get_or_404(file_id)
    
    # éªŒè¯ç›®æ ‡æ–‡ä»¶å¤¹å­˜åœ¨
    if target_folder_id:
        target_folder = Folder.query.get_or_404(target_folder_id)
    
    # æ›´æ–°æ–‡ä»¶æ‰€å±
    note_file.folder_id = target_folder_id
    note_file.updated_at = datetime.utcnow()
    
    db.session.commit()
    return note_file.to_dict()
```

#### 5.3.4 æŸ¥è¯¢ä¼˜åŒ–è®¾è®¡

**é¢„åŠ è½½å…³ç³»æ•°æ®**
```python
# è·å–æ–‡ä»¶å¤¹åŠå…¶æ‰€æœ‰æ–‡ä»¶å’Œç¬”è®°
def get_folder_with_all_data(folder_id):
    return Folder.query.options(
        db.joinedload(Folder.files).joinedload(NoteFile.notes)
    ).get_or_404(folder_id)

# è·å–æ–‡ä»¶åŠå…¶ç¬”è®°ï¼ˆæŒ‰é¡ºåºï¼‰
def get_file_with_ordered_notes(file_id):
    return NoteFile.query.options(
        db.joinedload(NoteFile.notes.and_(Note.order.asc()))
    ).get_or_404(file_id)
```

**ç»Ÿè®¡æŸ¥è¯¢**
```python
# è·å–æ–‡ä»¶å¤¹ç»Ÿè®¡ä¿¡æ¯
def get_folder_statistics(folder_id):
    result = db.session.query(
        Folder.id,
        Folder.name,
        db.func.count(NoteFile.id).label('files_count'),
        db.func.count(Note.id).label('notes_count')
    ).outerjoin(NoteFile).outerjoin(Note)\
     .filter(Folder.id == folder_id)\
     .group_by(Folder.id, Folder.name)\
     .first()
    
    return {
        'folder_id': result.id,
        'folder_name': result.name,
        'files_count': result.files_count or 0,
        'notes_count': result.notes_count or 0
    }
```

### 5.4 æ•°æ®åº“è¿æ¥ä¸ä¼šè¯ç®¡ç†

#### 5.4.1 SQLAlchemyé…ç½®

**æ‰©å±•åˆå§‹åŒ–**
```python
# app/extensions.py
from flask_sqlalchemy import SQLAlchemy

db = SQLAlchemy()

def init_db(app):
    """åˆå§‹åŒ–æ•°æ®åº“"""
    db.init_app(app)
    
    with app.app_context():
        # åˆ›å»ºæ‰€æœ‰è¡¨
        db.create_all()
```

**åº”ç”¨å·¥å‚é›†æˆ**
```python
# app/__init__.py
from app.extensions import db, init_db

def create_app(config_name='default'):
    app = Flask(__name__)
    app.config.from_object(config[config_name])
    
    # åˆå§‹åŒ–æ‰©å±•
    init_db(app)
    
    return app
```

#### 5.4.2 ä¼šè¯ç®¡ç†æœºåˆ¶

**è‡ªåŠ¨ä¼šè¯ç®¡ç†**
```python
# Flask-SQLAlchemyè‡ªåŠ¨ç®¡ç†ä¼šè¯
@notes_bp.route('/', methods=['POST'])
def create_note():
    try:
        # åˆ›å»ºæ–°ç¬”è®°
        note = Note(content=request.json.get('content'))
        db.session.add(note)
        db.session.commit()  # è‡ªåŠ¨æäº¤äº‹åŠ¡
        
        return jsonify(note.to_dict()), 201
        
    except Exception as e:
        db.session.rollback()  # é”™è¯¯æ—¶å›æ»š
        return jsonify({'error': str(e)}), 500
```

**æ‰‹åŠ¨äº‹åŠ¡æ§åˆ¶**
```python
# å¤æ‚æ“ä½œçš„äº‹åŠ¡ç®¡ç†
def reorder_notes_in_file(file_id, note_ids):
    """é‡æ–°æ’åºæ–‡ä»¶ä¸­çš„ç¬”è®°"""
    try:
        # å¼€å§‹äº‹åŠ¡
        for index, note_id in enumerate(note_ids):
            note = Note.query.filter_by(id=note_id, file_id=file_id).first()
            if note:
                note.order = index
                note.updated_at = datetime.utcnow()
        
        # æäº¤æ‰€æœ‰æ›´æ”¹
        db.session.commit()
        return True
        
    except Exception as e:
        # å‘ç”Ÿé”™è¯¯æ—¶å›æ»š
        db.session.rollback()
        raise e
```

#### 5.4.3 è¿æ¥æ± é…ç½®

**ç”Ÿäº§ç¯å¢ƒè¿æ¥æ± **
```python
# é…ç½®è¿æ¥æ± å‚æ•°
SQLALCHEMY_ENGINE_OPTIONS = {
    'pool_size': 10,                 # è¿æ¥æ± å¤§å°
    'pool_timeout': 20,              # è·å–è¿æ¥è¶…æ—¶æ—¶é—´
    'pool_recycle': 3600,           # è¿æ¥å›æ”¶æ—¶é—´
    'pool_pre_ping': True,          # è¿æ¥é¢„æ£€æŸ¥
    'max_overflow': 20,             # è¶…å‡ºpool_sizeçš„é¢å¤–è¿æ¥æ•°
    'connect_args': {
        'check_same_thread': False,  # SQLiteå¤šçº¿ç¨‹æ”¯æŒ
        'timeout': 20               # æ•°æ®åº“æ“ä½œè¶…æ—¶
    }
}
```

**å¥åº·æ£€æŸ¥**
```python
# æ•°æ®åº“è¿æ¥å¥åº·æ£€æŸ¥
def check_database_health():
    """æ£€æŸ¥æ•°æ®åº“è¿æ¥çŠ¶æ€"""
    try:
        # æ‰§è¡Œç®€å•æŸ¥è¯¢
        db.session.execute('SELECT 1')
        return {'status': 'healthy', 'timestamp': datetime.utcnow()}
    except Exception as e:
        return {'status': 'unhealthy', 'error': str(e), 'timestamp': datetime.utcnow()}
```

### 5.5 æ•°æ®æŒä¹…åŒ–æ“ä½œ

#### 5.5.1 CRUDæ“ä½œå®ç°

**Createï¼ˆåˆ›å»ºï¼‰æ“ä½œ**
```python
# åˆ›å»ºæ–‡ä»¶å¤¹
def create_folder(name):
    """åˆ›å»ºæ–°æ–‡ä»¶å¤¹"""
    folder = Folder(name=name)
    db.session.add(folder)
    db.session.commit()
    return folder

# åˆ›å»ºç¬”è®°æ–‡ä»¶
def create_note_file(name, folder_id=None):
    """åœ¨æŒ‡å®šæ–‡ä»¶å¤¹ä¸­åˆ›å»ºç¬”è®°æ–‡ä»¶"""
    note_file = NoteFile(name=name, folder_id=folder_id)
    db.session.add(note_file)
    db.session.commit()
    return note_file

# åˆ›å»ºç¬”è®°
def create_note(file_id, content='', format='text', after_note_id=None):
    """åœ¨æŒ‡å®šä½ç½®åˆ›å»ºç¬”è®°"""
    # è®¡ç®—æ’å…¥ä½ç½®
    if after_note_id:
        after_note = Note.query.get(after_note_id)
        order = after_note.order + 1 if after_note else 0
        # æ›´æ–°åç»­ç¬”è®°çš„é¡ºåº
        Note.query.filter(Note.file_id == file_id, Note.order >= order)\
                  .update({Note.order: Note.order + 1})
    else:
        # æ’å…¥åˆ°æœ«å°¾
        max_order = db.session.query(db.func.max(Note.order))\
                             .filter(Note.file_id == file_id).scalar() or 0
        order = max_order + 1
    
    note = Note(content=content, format=format, order=order, file_id=file_id)
    db.session.add(note)
    db.session.commit()
    return note
```

**Readï¼ˆè¯»å–ï¼‰æ“ä½œ**
```python
# æŸ¥è¯¢æ–‡ä»¶å¤¹åˆ—è¡¨
def get_folders_with_files():
    """è·å–æ‰€æœ‰æ–‡ä»¶å¤¹åŠå…¶æ–‡ä»¶"""
    return Folder.query.options(
        db.joinedload(Folder.files)
    ).all()

# æŸ¥è¯¢æ–‡ä»¶çš„ç¬”è®°åˆ—è¡¨
def get_notes_by_file(file_id, page=1, per_page=50):
    """åˆ†é¡µè·å–æ–‡ä»¶çš„ç¬”è®°åˆ—è¡¨"""
    return Note.query.filter_by(file_id=file_id)\
                    .order_by(Note.order.asc())\
                    .paginate(page=page, per_page=per_page, error_out=False)

# æœç´¢ç¬”è®°
def search_notes(keyword, file_id=None):
    """æœç´¢åŒ…å«å…³é”®è¯çš„ç¬”è®°"""
    query = Note.query.filter(Note.content.contains(keyword))
    if file_id:
        query = query.filter_by(file_id=file_id)
    return query.order_by(Note.updated_at.desc()).all()
```

**Updateï¼ˆæ›´æ–°ï¼‰æ“ä½œ**
```python
# æ›´æ–°ç¬”è®°å†…å®¹
def update_note(note_id, **kwargs):
    """æ›´æ–°ç¬”è®°ä¿¡æ¯"""
    note = Note.query.get_or_404(note_id)
    
    for key, value in kwargs.items():
        if hasattr(note, key):
            setattr(note, key, value)
    
    note.updated_at = datetime.utcnow()
    db.session.commit()
    return note

# æ‰¹é‡æ›´æ–°ç¬”è®°é¡ºåº
def reorder_notes(note_orders):
    """æ‰¹é‡æ›´æ–°ç¬”è®°é¡ºåº
    Args:
        note_orders: List[dict] - [{'id': 1, 'order': 0}, ...]
    """
    for item in note_orders:
        Note.query.filter_by(id=item['id'])\
                  .update({'order': item['order'], 'updated_at': datetime.utcnow()})
    
    db.session.commit()
```

**Deleteï¼ˆåˆ é™¤ï¼‰æ“ä½œ**
```python
# è½¯åˆ é™¤å®ç°
class SoftDeleteMixin:
    """è½¯åˆ é™¤æ··å…¥ç±»"""
    deleted_at = db.Column(db.DateTime, nullable=True)
    
    def soft_delete(self):
        """æ ‡è®°ä¸ºå·²åˆ é™¤"""
        self.deleted_at = datetime.utcnow()
        db.session.commit()
    
    def restore(self):
        """æ¢å¤åˆ é™¤"""
        self.deleted_at = None
        db.session.commit()
    
    @classmethod
    def active_query(cls):
        """è·å–æœªåˆ é™¤çš„è®°å½•"""
        return cls.query.filter(cls.deleted_at.is_(None))

# ç¡¬åˆ é™¤æ“ä½œ
def delete_note(note_id):
    """æ°¸ä¹…åˆ é™¤ç¬”è®°"""
    note = Note.query.get_or_404(note_id)
    file_id = note.file_id
    order = note.order
    
    # åˆ é™¤ç¬”è®°
    db.session.delete(note)
    
    # è°ƒæ•´åç»­ç¬”è®°çš„é¡ºåº
    Note.query.filter(Note.file_id == file_id, Note.order > order)\
              .update({Note.order: Note.order - 1})
    
    db.session.commit()
    return True
```

#### 5.5.2 æ•°æ®éªŒè¯æœºåˆ¶

**æ¨¡å‹çº§éªŒè¯**
```python
class Note(db.Model):
    # ...å­—æ®µå®šä¹‰...
    
    def validate(self):
        """æ¨¡å‹æ•°æ®éªŒè¯"""
        errors = []
        
        # å†…å®¹é•¿åº¦éªŒè¯
        if self.content and len(self.content) > 100000:  # 100KB
            errors.append('ç¬”è®°å†…å®¹è¿‡é•¿ï¼Œä¸èƒ½è¶…è¿‡100KB')
        
        # æ ¼å¼éªŒè¯
        if self.format not in NOTE_FORMATS:
            errors.append(f'ä¸æ”¯æŒçš„ç¬”è®°æ ¼å¼: {self.format}')
        
        # æ–‡ä»¶å­˜åœ¨æ€§éªŒè¯
        if self.file_id and not NoteFile.query.get(self.file_id):
            errors.append('æŒ‡å®šçš„ç¬”è®°æ–‡ä»¶ä¸å­˜åœ¨')
        
        return errors
    
    def save(self):
        """ä¿å­˜å‰éªŒè¯"""
        errors = self.validate()
        if errors:
            raise ValidationError('; '.join(errors))
        
        db.session.add(self)
        db.session.commit()
        return self
```

**ä¸šåŠ¡çº§éªŒè¯**
```python
def validate_note_data(data):
    """APIçº§åˆ«çš„æ•°æ®éªŒè¯"""
    errors = {}
    
    # å¿…å¡«å­—æ®µæ£€æŸ¥
    if not data.get('content', '').strip():
        errors['content'] = 'ç¬”è®°å†…å®¹ä¸èƒ½ä¸ºç©º'
    
    # æ ¼å¼æ£€æŸ¥
    format_value = data.get('format', 'text')
    if format_value not in NOTE_FORMATS:
        errors['format'] = f'ä¸æ”¯æŒçš„æ ¼å¼: {format_value}'
    
    # æ–‡ä»¶IDæ£€æŸ¥
    file_id = data.get('file_id')
    if file_id and not NoteFile.query.get(file_id):
        errors['file_id'] = 'æŒ‡å®šçš„æ–‡ä»¶ä¸å­˜åœ¨'
    
    return errors
```

#### 5.5.3 æ•°æ®è¿ç§»ç®¡ç†

**ç‰ˆæœ¬æ§åˆ¶è„šæœ¬**
```python
# migrations/versions/001_initial_schema.py
"""åˆå§‹æ•°æ®åº“æ¶æ„

Revision ID: 001
Revises: 
Create Date: 2025-06-02 10:00:00.000000
"""

from alembic import op
import sqlalchemy as sa

def upgrade():
    """å‡çº§æ•°æ®åº“æ¶æ„"""
    # åˆ›å»ºfoldersè¡¨
    op.create_table('folders',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('name', sa.String(100), nullable=False),
        sa.Column('created_at', sa.DateTime(), nullable=True),
        sa.Column('updated_at', sa.DateTime(), nullable=True),
        sa.PrimaryKeyConstraint('id')
    )
    
    # åˆ›å»ºnote_filesè¡¨
    op.create_table('note_files',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('name', sa.String(200), nullable=False),
        sa.Column('order', sa.Integer(), nullable=True),
        sa.Column('created_at', sa.DateTime(), nullable=True),
        sa.Column('updated_at', sa.DateTime(), nullable=True),
        sa.Column('folder_id', sa.Integer(), nullable=True),
        sa.ForeignKeyConstraint(['folder_id'], ['folders.id'], ),
        sa.PrimaryKeyConstraint('id')
    )
    
    # åˆ›å»ºnotesè¡¨
    op.create_table('notes',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('content', sa.Text(), nullable=True),
        sa.Column('format', sa.String(20), nullable=True),
        sa.Column('order', sa.Integer(), nullable=True),
        sa.Column('created_at', sa.DateTime(), nullable=True),
        sa.Column('updated_at', sa.DateTime(), nullable=True),
        sa.Column('file_id', sa.Integer(), nullable=True),
        sa.ForeignKeyConstraint(['file_id'], ['note_files.id'], ondelete='CASCADE'),
        sa.PrimaryKeyConstraint('id')
    )

def downgrade():
    """é™çº§æ•°æ®åº“æ¶æ„"""
    op.drop_table('notes')
    op.drop_table('note_files')
    op.drop_table('folders')
```

**æ•°æ®è¿ç§»å·¥å…·**
```python
# æ•°æ®å¯¼å…¥å¯¼å‡ºå·¥å…·
import json

def export_database_to_json(filename):
    """å¯¼å‡ºæ•°æ®åº“åˆ°JSONæ–‡ä»¶"""
    data = {
        'folders': [folder.to_dict() for folder in Folder.query.all()],
        'note_files': [file.to_dict() for file in NoteFile.query.all()],
        'notes': [note.to_dict() for note in Note.query.all()],
        'export_time': datetime.utcnow().isoformat()
    }
    
    with open(filename, 'w', encoding='utf-8') as f:
        json.dump(data, f, ensure_ascii=False, indent=2)

def import_database_from_json(filename):
    """ä»JSONæ–‡ä»¶å¯¼å…¥æ•°æ®"""
    with open(filename, 'r', encoding='utf-8') as f:
        data = json.load(f)
    
    # æ¸…ç©ºç°æœ‰æ•°æ®
    Note.query.delete()
    NoteFile.query.delete()
    Folder.query.delete()
    
    # å¯¼å…¥æ–‡ä»¶å¤¹
    for folder_data in data['folders']:
        folder = Folder(**{k: v for k, v in folder_data.items() if k != 'id'})
        db.session.add(folder)
    
    db.session.commit()
    
    # å¯¼å…¥æ–‡ä»¶å’Œç¬”è®°...
```

è¿™æ ·çš„æ•°æ®åº“è®¾è®¡ç¡®ä¿äº†ï¼š
- **æ•°æ®å®Œæ•´æ€§**ï¼šé€šè¿‡å¤–é”®çº¦æŸå’Œçº§è”æ“ä½œ
- **æŸ¥è¯¢æ•ˆç‡**ï¼šåˆç†çš„ç´¢å¼•å’Œå…³ç³»è®¾è®¡
- **æ‰©å±•æ€§**ï¼šçµæ´»çš„æ¨¡å‹è®¾è®¡æ”¯æŒåŠŸèƒ½æ‰©å±•
- **ç»´æŠ¤æ€§**ï¼šæ¸…æ™°çš„æ•°æ®æ¨¡å‹å’Œå®Œå–„çš„å·¥å…·æ”¯æŒ

## 6. æ•°æ®æµè½¬æœºåˆ¶

æ•°æ®æµè½¬æ˜¯å‰åç«¯ååŒå·¥ä½œçš„æ ¸å¿ƒï¼Œæ¶‰åŠç”¨æˆ·æ“ä½œè§¦å‘ã€æ•°æ®ä¼ è¾“ã€æŒä¹…åŒ–å­˜å‚¨å’ŒçŠ¶æ€åŒæ­¥çš„å®Œæ•´æµç¨‹ã€‚

### 6.1 ç”¨æˆ·æ“ä½œåˆ°æ•°æ®åº“çš„å®Œæ•´æµç¨‹

#### 6.1.1 æ•°æ®æµè½¬æ¶æ„å›¾

```
ç”¨æˆ·ç•Œé¢äº¤äº’ â†’ Reactç»„ä»¶çŠ¶æ€ â†’ APIæœåŠ¡å±‚ â†’ HTTPè¯·æ±‚ â†’ Flaskè·¯ç”± â†’ ä¸šåŠ¡é€»è¾‘ â†’ SQLAlchemy ORM â†’ SQLiteæ•°æ®åº“
     â†“             â†“           â†“         â†“          â†“          â†“             â†“              â†“
    äº‹ä»¶è§¦å‘    â†’ çŠ¶æ€æ›´æ–°    â†’ è¯·æ±‚å°è£…  â†’ ç½‘ç»œä¼ è¾“  â†’ è·¯ç”±åˆ†å‘  â†’ æ•°æ®å¤„ç†    â†’ ORMæ˜ å°„      â†’ æ•°æ®æŒä¹…åŒ–
     â†‘             â†‘           â†‘         â†‘          â†‘          â†‘             â†‘              â†‘
å“åº”æ›´æ–°UI   â† ç»„ä»¶é‡æ¸²æŸ“   â† å“åº”å¤„ç†  â† æ•°æ®è¿”å›  â† JSONå“åº” â† ç»“æœå°è£…    â† æŸ¥è¯¢ç»“æœ     â† æ•°æ®è¯»å–
```

#### 6.1.2 å…¸å‹æ“ä½œæµç¨‹åˆ†æ

**1. åˆ›å»ºç¬”è®°çš„å®Œæ•´æµç¨‹**

**å‰ç«¯å‘èµ·é˜¶æ®µ**
```javascript
// 1. ç”¨æˆ·ç‚¹å‡»"æ·»åŠ ç¬”è®°"æŒ‰é’®
const handleAddNote = async () => {
  // 2. è°ƒç”¨Hookä¸­çš„åˆ›å»ºæ–¹æ³•
  const newNoteId = await createNote(afterNoteId, '', 'text');
  
  // 3. æœ¬åœ°çŠ¶æ€ç«‹å³æ›´æ–°ï¼ˆä¹è§‚æ›´æ–°ï¼‰
  setNotes(prevNotes => {
    const newNote = { id: newNoteId, content: '', format: 'text' };
    return insertNoteAtPosition(prevNotes, newNote, afterNoteId);
  });
};

// 4. APIæœåŠ¡å±‚å¤„ç†
const createNote = async (fileId, content, format, afterNoteId) => {
  const requestData = {
    content,
    format,
    after_note_id: afterNoteId
  };
  
  // 5. å‘èµ·HTTP POSTè¯·æ±‚
  const response = await axios.post(`${API_URL}/files/${fileId}/notes`, requestData);
  return response.data;
};
```

**åç«¯å¤„ç†é˜¶æ®µ**
```python
# 6. Flaskè·¯ç”±æ¥æ”¶è¯·æ±‚
@notes_bp.route('/files/<int:file_id>/notes', methods=['POST'])
def create_note(file_id):
    # 7. è·å–è¯·æ±‚æ•°æ®
    data = request.get_json()
    after_note_id = data.get('after_note_id')
    content = data.get('content', '')
    format_type = data.get('format', 'text')
    
    # 8. ä¸šåŠ¡é€»è¾‘å¤„ç†
    if after_note_id:
        # æŸ¥æ‰¾æ’å…¥ä½ç½®
        target_note = Note.query.get(after_note_id)
        if target_note and target_note.file_id == file_id:
            # è°ƒæ•´åç»­ç¬”è®°çš„é¡ºåº
            Note.query.filter(
                Note.file_id == file_id, 
                Note.order > target_note.order
            ).update({Note.order: Note.order + 1})
            new_order = target_note.order + 1
        else:
            # æ·»åŠ åˆ°æœ«å°¾
            new_order = get_max_order(file_id) + 1
    else:
        new_order = get_max_order(file_id) + 1
    
    # 9. åˆ›å»ºæ•°æ®æ¨¡å‹
    new_note = Note(
        content=content,
        format=format_type,
        order=new_order,
        file_id=file_id
    )
    
    # 10. æ•°æ®åº“æ“ä½œ
    db.session.add(new_note)
    db.session.commit()
    
    # 11. è¿”å›å“åº”
    return jsonify({
        'message': 'Note created successfully',
        'id': new_note.id,
        'note': new_note.to_dict()
    }), 201
```

**å“åº”å¤„ç†é˜¶æ®µ**
```javascript
// 12. å‰ç«¯æ¥æ”¶å“åº”
const response = await axios.post(url, data);

// 13. æ›´æ–°æœ¬åœ°çŠ¶æ€ï¼ˆå¦‚æœéœ€è¦ï¼‰
if (response.data.note) {
  setNotes(prevNotes => 
    prevNotes.map(note => 
      note.id === response.data.id ? response.data.note : note
    )
  );
}

// 14. UIé‡æ–°æ¸²æŸ“
// Reactè‡ªåŠ¨æ£€æµ‹çŠ¶æ€å˜åŒ–å¹¶é‡æ–°æ¸²æŸ“ç›¸å…³ç»„ä»¶
```

#### 6.1.3 æ‰¹é‡æ“ä½œçš„æ•°æ®æµè½¬

**ç¬”è®°é‡æ–°æ’åºæµç¨‹**
```javascript
// å‰ç«¯ï¼šæ‹–æ‹½æ“ä½œè§¦å‘é‡æ’åº
const handleNotesReorder = async (newNoteIds) => {
  try {
    // 1. ä¹è§‚æ›´æ–°ï¼šç«‹å³æ›´æ–°UI
    const reorderedNotes = newNoteIds.map((id, index) => ({
      ...notes.find(note => note.id === id),
      order: index
    }));
    setNotes(reorderedNotes);
    
    // 2. å‘é€æ‰¹é‡æ›´æ–°è¯·æ±‚
    await noteService.reorderNotes(newNoteIds);
    
  } catch (error) {
    // 3. å¤±è´¥æ—¶å›æ»šçŠ¶æ€
    fetchNotes(); // é‡æ–°è·å–æœåŠ¡å™¨æ•°æ®
    setErrorMessage('é‡æ–°æ’åºå¤±è´¥ï¼š' + error.message);
  }
};
```

```python
# åç«¯ï¼šæ‰¹é‡æ›´æ–°å¤„ç†
@notes_bp.route('/notes/reorder', methods=['PUT'])
def reorder_notes():
    data = request.get_json()
    note_ids = data.get('noteIds', [])
    
    # äº‹åŠ¡å¤„ç†ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
    try:
        for index, note_id in enumerate(note_ids):
            Note.query.filter_by(id=note_id).update({
                'order': index,
                'updated_at': datetime.utcnow()
            })
        
        db.session.commit()
        return jsonify({'message': 'Notes reordered successfully'})
        
    except Exception as e:
        db.session.rollback()
        return jsonify({'error': str(e)}), 500
```

#### 6.1.4 é”™è¯¯å¤„ç†ä¸é‡è¯•æœºåˆ¶

**å‰ç«¯é”™è¯¯å¤„ç†ç­–ç•¥**
```javascript
// APIæœåŠ¡å±‚çš„é”™è¯¯å¤„ç†å’Œé‡è¯•
class ApiService {
  constructor() {
    this.maxRetries = 3;
    this.retryDelay = 1000; // 1ç§’
  }
  
  async makeRequest(url, options, retryCount = 0) {
    try {
      const response = await axios(url, options);
      return response.data;
      
    } catch (error) {
      // ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨é”™è¯¯é‡è¯•
      if (this.shouldRetry(error) && retryCount < this.maxRetries) {
        await this.delay(this.retryDelay * Math.pow(2, retryCount)); // æŒ‡æ•°é€€é¿
        return this.makeRequest(url, options, retryCount + 1);
      }
      
      // è½¬æ¢é”™è¯¯æ ¼å¼
      throw this.transformError(error);
    }
  }
  
  shouldRetry(error) {
    // ç½‘ç»œé”™è¯¯æˆ–5xxæœåŠ¡å™¨é”™è¯¯æ‰é‡è¯•
    return !error.response || error.response.status >= 500;
  }
  
  transformError(error) {
    if (error.response) {
      return new ApiError(error.response.status, error.response.data.message);
    } else if (error.request) {
      return new NetworkError('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®');
    } else {
      return new Error('è¯·æ±‚é…ç½®é”™è¯¯');
    }
  }
}
```

### 6.2 å®æ—¶æ•°æ®åŒæ­¥æœºåˆ¶

#### 6.2.1 ä¹è§‚æ›´æ–°ç­–ç•¥

é¡¹ç›®é‡‡ç”¨ä¹è§‚æ›´æ–°ç­–ç•¥ï¼Œåœ¨å‘é€è¯·æ±‚å‰å…ˆæ›´æ–°æœ¬åœ°çŠ¶æ€ï¼Œæä¾›æµç•…çš„ç”¨æˆ·ä½“éªŒã€‚

**ä¹è§‚æ›´æ–°å®ç°**
```javascript
// useNotes Hookä¸­çš„ä¹è§‚æ›´æ–°
const updateNote = useCallback(async (noteId, contentData) => {
  // 1. ç«‹å³æ›´æ–°æœ¬åœ°çŠ¶æ€
  setNotes(prevNotes =>
    prevNotes.map(note =>
      note.id === noteId 
        ? { ...note, ...contentData, updated_at: new Date().toISOString() }
        : note
    )
  );
  
  try {
    // 2. å‘é€æ›´æ–°è¯·æ±‚
    await noteService.updateNote(noteId, contentData);
    
    // 3. å¯é€‰ï¼šéªŒè¯æœåŠ¡å™¨å“åº”å¹¶åŒæ­¥å·®å¼‚
    
  } catch (error) {
    // 4. å¤±è´¥æ—¶å›æ»šåˆ°æœåŠ¡å™¨çŠ¶æ€
    await fetchNotes();
    setErrorMessage('æ›´æ–°å¤±è´¥ï¼š' + error.message);
  }
}, [fetchNotes, setErrorMessage]);
```

**å†²çªæ£€æµ‹ä¸è§£å†³**
```javascript
// ç‰ˆæœ¬æ§åˆ¶æœºåˆ¶
const updateNoteWithVersionCheck = async (noteId, contentData, expectedVersion) => {
  try {
    const response = await axios.put(`/api/notes/${noteId}`, {
      ...contentData,
      expected_version: expectedVersion
    });
    
    return response.data;
    
  } catch (error) {
    if (error.response?.status === 409) {
      // å†²çªå¤„ç†ï¼šæç¤ºç”¨æˆ·é€‰æ‹©è§£å†³æ–¹æ¡ˆ
      const serverData = error.response.data.current_data;
      const conflictResolution = await showConflictDialog(contentData, serverData);
      
      if (conflictResolution === 'overwrite') {
        // å¼ºåˆ¶è¦†ç›–
        return this.updateNote(noteId, { ...contentData, force: true });
      } else if (conflictResolution === 'merge') {
        // åˆå¹¶å†…å®¹
        const mergedContent = mergeContent(contentData.content, serverData.content);
        return this.updateNote(noteId, { ...contentData, content: mergedContent });
      }
    }
    throw error;
  }
};
```

#### 6.2.2 æ•°æ®åŒæ­¥ç­–ç•¥

**1. å®šæ—¶åŒæ­¥æœºåˆ¶**
```javascript
// å®šæœŸä»æœåŠ¡å™¨åŒæ­¥æ•°æ®
const useSyncManager = (activeFileId) => {
  const [lastSyncTime, setLastSyncTime] = useState(null);
  const syncInterval = 30000; // 30ç§’
  
  useEffect(() => {
    if (!activeFileId) return;
    
    const syncData = async () => {
      try {
        const serverNotes = await noteService.getNotes(activeFileId);
        const localNotes = notes;
        
        // æ¯”è¾ƒå¹¶åˆå¹¶å·®å¼‚
        const mergedNotes = mergeNotesData(localNotes, serverNotes, lastSyncTime);
        
        if (mergedNotes.hasChanges) {
          setNotes(mergedNotes.notes);
          setLastSyncTime(new Date());
        }
        
      } catch (error) {
        console.warn('æ•°æ®åŒæ­¥å¤±è´¥:', error);
      }
    };
    
    // ç«‹å³åŒæ­¥ä¸€æ¬¡
    syncData();
    
    // è®¾ç½®å®šæ—¶åŒæ­¥
    const intervalId = setInterval(syncData, syncInterval);
    
    return () => clearInterval(intervalId);
  }, [activeFileId, notes, lastSyncTime]);
};
```

**2. äº‹ä»¶é©±åŠ¨åŒæ­¥**
```javascript
// åŸºäºç”¨æˆ·æ´»åŠ¨çš„æ™ºèƒ½åŒæ­¥
const useActivityBasedSync = () => {
  const [isActive, setIsActive] = useState(true);
  
  useEffect(() => {
    // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–
    const handleVisibilityChange = () => {
      if (document.visibilityState === 'visible' && !isActive) {
        // é¡µé¢é‡æ–°å¯è§æ—¶åŒæ­¥æ•°æ®
        syncDataFromServer();
        setIsActive(true);
      } else if (document.visibilityState === 'hidden') {
        setIsActive(false);
      }
    };
    
    // ç›‘å¬ç½‘ç»œçŠ¶æ€å˜åŒ–
    const handleOnline = () => {
      if (navigator.onLine) {
        // ç½‘ç»œæ¢å¤æ—¶åŒæ­¥æ•°æ®
        syncPendingChanges();
        syncDataFromServer();
      }
    };
    
    document.addEventListener('visibilitychange', handleVisibilityChange);
    window.addEventListener('online', handleOnline);
    
    return () => {
      document.removeEventListener('visibilitychange', handleVisibilityChange);
      window.removeEventListener('online', handleOnline);
    };
  }, [isActive]);
};
```

#### 6.2.3 ç¦»çº¿æ•°æ®å¤„ç†

**ç¦»çº¿å­˜å‚¨æœºåˆ¶**
```javascript
// ä½¿ç”¨IndexedDBå­˜å‚¨ç¦»çº¿æ•°æ®
class OfflineStorage {
  constructor() {
    this.dbName = 'NotesApp';
    this.version = 1;
    this.db = null;
  }
  
  async init() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(this.dbName, this.version);
      
      request.onerror = () => reject(request.error);
      request.onsuccess = () => {
        this.db = request.result;
        resolve();
      };
      
      request.onupgradeneeded = (event) => {
        const db = event.target.result;
        
        // åˆ›å»ºå¯¹è±¡å­˜å‚¨
        if (!db.objectStoreNames.contains('notes')) {
          const notesStore = db.createObjectStore('notes', { keyPath: 'id' });
          notesStore.createIndex('file_id', 'file_id', { unique: false });
          notesStore.createIndex('updated_at', 'updated_at', { unique: false });
        }
        
        if (!db.objectStoreNames.contains('pending_operations')) {
          db.createObjectStore('pending_operations', { keyPath: 'id', autoIncrement: true });
        }
      };
    });
  }
  
  async saveNotes(fileId, notes) {
    const transaction = this.db.transaction(['notes'], 'readwrite');
    const store = transaction.objectStore('notes');
    
    // æ¸…é™¤è¯¥æ–‡ä»¶çš„æ—§æ•°æ®
    const index = store.index('file_id');
    const oldNotes = await this.getAllFromIndex(index, fileId);
    
    for (const oldNote of oldNotes) {
      await store.delete(oldNote.id);
    }
    
    // ä¿å­˜æ–°æ•°æ®
    for (const note of notes) {
      await store.put({ ...note, file_id: fileId, offline: true });
    }
  }
  
  async getPendingOperations() {
    const transaction = this.db.transaction(['pending_operations'], 'readonly');
    const store = transaction.objectStore('pending_operations');
    return this.getAllFromStore(store);
  }
  
  async savePendingOperation(operation) {
    const transaction = this.db.transaction(['pending_operations'], 'readwrite');
    const store = transaction.objectStore('pending_operations');
    await store.put({
      ...operation,
      timestamp: new Date().toISOString(),
      retries: 0
    });
  }
}
```

**ç¦»çº¿æ“ä½œé˜Ÿåˆ—**
```javascript
// ç¦»çº¿æ“ä½œç®¡ç†
class OfflineOperationManager {
  constructor(offlineStorage, apiService) {
    this.storage = offlineStorage;
    this.api = apiService;
    this.isProcessing = false;
  }
  
  async addOperation(type, data) {
    // æ·»åŠ æ“ä½œåˆ°é˜Ÿåˆ—
    await this.storage.savePendingOperation({
      type, // 'create', 'update', 'delete', 'reorder'
      data,
      id: `${type}_${Date.now()}_${Math.random()}`
    });
    
    // å¦‚æœåœ¨çº¿ï¼Œå°è¯•ç«‹å³å¤„ç†
    if (navigator.onLine && !this.isProcessing) {
      this.processQueue();
    }
  }
  
  async processQueue() {
    if (this.isProcessing) return;
    this.isProcessing = true;
    
    try {
      const operations = await this.storage.getPendingOperations();
      
      for (const operation of operations) {
        try {
          await this.executeOperation(operation);
          await this.storage.deletePendingOperation(operation.id);
          
        } catch (error) {
          // å¢åŠ é‡è¯•æ¬¡æ•°
          operation.retries = (operation.retries || 0) + 1;
          
          if (operation.retries >= 3) {
            // è¶…è¿‡é‡è¯•æ¬¡æ•°ï¼Œæ ‡è®°ä¸ºå¤±è´¥
            await this.storage.markOperationFailed(operation.id, error.message);
          } else {
            // æ›´æ–°é‡è¯•æ¬¡æ•°
            await this.storage.updateOperation(operation);
          }
        }
      }
      
    } finally {
      this.isProcessing = false;
    }
  }
  
  async executeOperation(operation) {
    switch (operation.type) {
      case 'create':
        return await this.api.createNote(operation.data.fileId, operation.data.content);
      case 'update':
        return await this.api.updateNote(operation.data.noteId, operation.data.changes);
      case 'delete':
        return await this.api.deleteNote(operation.data.noteId);
      case 'reorder':
        return await this.api.reorderNotes(operation.data.noteIds);
      default:
        throw new Error(`Unknown operation type: ${operation.type}`);
    }
  }
}
```

### 6.3 æ•°æ®ç¼“å­˜ç­–ç•¥

#### 6.3.1 å¤šå±‚ç¼“å­˜æ¶æ„

```
å‰ç«¯ç¼“å­˜å±‚æ¬¡ï¼š
Reactç»„ä»¶çŠ¶æ€ (å†…å­˜) â†’ React Queryç¼“å­˜ (å†…å­˜) â†’ IndexedDB (æŒä¹…åŒ–) â†’ æœåŠ¡å™¨ (è¿œç¨‹)
     â†‘                    â†‘                     â†‘                  â†‘
   å®æ—¶è®¿é—®              æ™ºèƒ½ç¼“å­˜              ç¦»çº¿å­˜å‚¨            æ•°æ®æº
```

#### 6.3.2 React Queryé›†æˆ

**é…ç½®React Query**
```javascript
// queryClienté…ç½®
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';

const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 5 * 60 * 1000,    // 5åˆ†é’Ÿå†…æ•°æ®ä¸è¿‡æœŸ
      cacheTime: 10 * 60 * 1000,   // ç¼“å­˜ä¿ç•™10åˆ†é’Ÿ
      retry: (failureCount, error) => {
        // 4xxé”™è¯¯ä¸é‡è¯•ï¼Œ5xxé”™è¯¯æœ€å¤šé‡è¯•2æ¬¡
        if (error.response?.status >= 400 && error.response?.status < 500) {
          return false;
        }
        return failureCount < 2;
      },
      refetchOnWindowFocus: false,  // çª—å£èšç„¦æ—¶ä¸è‡ªåŠ¨åˆ·æ–°
      refetchOnReconnect: true,     // ç½‘ç»œé‡è¿æ—¶åˆ·æ–°
    },
    mutations: {
      retry: 1,
    },
  },
});
```

**ç¼“å­˜é”®ç­–ç•¥**
```javascript
// æŸ¥è¯¢é”®çš„å±‚çº§ç»“æ„
const queryKeys = {
  // æ–‡ä»¶å¤¹ç›¸å…³
  folders: () => ['folders'],
  folder: (id) => [...queryKeys.folders(), id],
  folderFiles: (id) => [...queryKeys.folder(id), 'files'],
  
  // æ–‡ä»¶ç›¸å…³
  files: () => ['files'],
  file: (id) => [...queryKeys.files(), id],
  fileNotes: (id) => [...queryKeys.file(id), 'notes'],
  
  // ç¬”è®°ç›¸å…³
  notes: () => ['notes'],
  note: (id) => [...queryKeys.notes(), id],
};

// ä½¿ç”¨æŸ¥è¯¢é”®
const useNotes = (fileId) => {
  return useQuery({
    queryKey: queryKeys.fileNotes(fileId),
    queryFn: () => noteService.getNotes(fileId),
    enabled: !!fileId,
    staleTime: 2 * 60 * 1000, // ç¬”è®°æ•°æ®2åˆ†é’Ÿè¿‡æœŸ
  });
};
```

**æ™ºèƒ½ç¼“å­˜æ›´æ–°**
```javascript
// ä¹è§‚æ›´æ–°ä¸ç¼“å­˜ç®¡ç†
const useCreateNote = () => {
  const queryClient = useQueryClient();
  
  return useMutation({
    mutationFn: ({ fileId, content, format, afterNoteId }) =>
      noteService.createNote(fileId, content, format, afterNoteId),
    
    onMutate: async ({ fileId, content, format, afterNoteId }) => {
      // å–æ¶ˆç›¸å…³çš„æŸ¥è¯¢ä»¥é¿å…å†²çª
      await queryClient.cancelQueries({ queryKey: queryKeys.fileNotes(fileId) });
      
      // è·å–å½“å‰ç¼“å­˜æ•°æ®
      const previousNotes = queryClient.getQueryData(queryKeys.fileNotes(fileId));
      
      // ä¹è§‚æ›´æ–°ç¼“å­˜
      const optimisticNote = {
        id: `temp_${Date.now()}`,
        content,
        format,
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString(),
        file_id: fileId,
      };
      
      const newNotes = insertNoteAfter(previousNotes || [], optimisticNote, afterNoteId);
      queryClient.setQueryData(queryKeys.fileNotes(fileId), newNotes);
      
      return { previousNotes };
    },
    
    onError: (error, variables, context) => {
      // é”™è¯¯æ—¶å›æ»šç¼“å­˜
      if (context?.previousNotes) {
        queryClient.setQueryData(
          queryKeys.fileNotes(variables.fileId),
          context.previousNotes
        );
      }
    },
    
    onSuccess: (newNote, variables) => {
      // æˆåŠŸæ—¶æ›´æ–°ç¼“å­˜ä¸­çš„ä¸´æ—¶ID
      queryClient.setQueryData(
        queryKeys.fileNotes(variables.fileId),
        (oldNotes) =>
          oldNotes?.map((note) =>
            note.id.toString().startsWith('temp_') ? newNote : note
          ) || []
      );
    },
    
    onSettled: (data, error, variables) => {
      // æ— è®ºæˆåŠŸå¤±è´¥éƒ½é‡æ–°éªŒè¯æ•°æ®
      queryClient.invalidateQueries({
        queryKey: queryKeys.fileNotes(variables.fileId),
      });
    },
  });
};
```

#### 6.3.3 æœ¬åœ°å­˜å‚¨ç¼“å­˜

**ç¼“å­˜é”®ç®¡ç†**
```javascript
// æœ¬åœ°å­˜å‚¨ç®¡ç†å™¨
class LocalStorageCache {
  constructor(prefix = 'notesapp') {
    this.prefix = prefix;
    this.maxAge = 24 * 60 * 60 * 1000; // 24å°æ—¶
  }
  
  set(key, value, maxAge = this.maxAge) {
    const item = {
      value,
      timestamp: Date.now(),
      maxAge,
    };
    
    try {
      localStorage.setItem(`${this.prefix}:${key}`, JSON.stringify(item));
    } catch (error) {
      // å­˜å‚¨ç©ºé—´ä¸è¶³æ—¶æ¸…ç†è¿‡æœŸæ•°æ®
      this.cleanup();
      try {
        localStorage.setItem(`${this.prefix}:${key}`, JSON.stringify(item));
      } catch (retryError) {
        console.warn('æœ¬åœ°å­˜å‚¨ç©ºé—´ä¸è¶³:', retryError);
      }
    }
  }
  
  get(key) {
    try {
      const itemStr = localStorage.getItem(`${this.prefix}:${key}`);
      if (!itemStr) return null;
      
      const item = JSON.parse(itemStr);
      const now = Date.now();
      
      // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
      if (now - item.timestamp > item.maxAge) {
        this.remove(key);
        return null;
      }
      
      return item.value;
    } catch (error) {
      console.warn('è¯»å–æœ¬åœ°å­˜å‚¨å¤±è´¥:', error);
      return null;
    }
  }
  
  remove(key) {
    localStorage.removeItem(`${this.prefix}:${key}`);
  }
  
  cleanup() {
    const keysToRemove = [];
    const now = Date.now();
    
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key?.startsWith(`${this.prefix}:`)) {
        try {
          const item = JSON.parse(localStorage.getItem(key));
          if (now - item.timestamp > item.maxAge) {
            keysToRemove.push(key);
          }
        } catch (error) {
          // æŸåçš„æ•°æ®ä¹Ÿåˆ é™¤
          keysToRemove.push(key);
        }
      }
    }
    
    keysToRemove.forEach((key) => localStorage.removeItem(key));
  }
}
```

### 6.4 æ•°æ®ä¸€è‡´æ€§ä¿è¯

#### 6.4.1 äº‹åŠ¡ç®¡ç†

**æ•°æ®åº“äº‹åŠ¡å¤„ç†**
```python
# å¤æ‚æ“ä½œçš„äº‹åŠ¡ä¿è¯
from sqlalchemy.exc import IntegrityError
from contextlib import contextmanager

@contextmanager
def database_transaction():
    """æ•°æ®åº“äº‹åŠ¡ä¸Šä¸‹æ–‡ç®¡ç†å™¨"""
    try:
        yield db.session
        db.session.commit()
    except Exception as e:
        db.session.rollback()
        raise e

# ä½¿ç”¨äº‹åŠ¡å¤„ç†å¤æ‚æ“ä½œ
def move_note_to_file(note_id, target_file_id, target_position=None):
    """å°†ç¬”è®°ç§»åŠ¨åˆ°å¦ä¸€ä¸ªæ–‡ä»¶"""
    with database_transaction():
        # 1. è·å–æºç¬”è®°
        note = Note.query.get_or_404(note_id)
        original_file_id = note.file_id
        original_order = note.order
        
        # 2. åœ¨åŸæ–‡ä»¶ä¸­è°ƒæ•´é¡ºåº
        Note.query.filter(
            Note.file_id == original_file_id,
            Note.order > original_order
        ).update({Note.order: Note.order - 1})
        
        # 3. åœ¨ç›®æ ‡æ–‡ä»¶ä¸­æ’å…¥
        if target_position is not None:
            # åœ¨æŒ‡å®šä½ç½®æ’å…¥
            Note.query.filter(
                Note.file_id == target_file_id,
                Note.order >= target_position
            ).update({Note.order: Note.order + 1})
            note.order = target_position
        else:
            # æ’å…¥åˆ°æœ«å°¾
            max_order = db.session.query(db.func.max(Note.order))\
                                .filter(Note.file_id == target_file_id)\
                                .scalar() or 0
            note.order = max_order + 1
        
        # 4. æ›´æ–°ç¬”è®°æ‰€å±æ–‡ä»¶
        note.file_id = target_file_id
        note.updated_at = datetime.utcnow()
        
        return note.to_dict()
```

**åˆ†å¸ƒå¼é”æœºåˆ¶**
```python
# ä½¿ç”¨Rediså®ç°åˆ†å¸ƒå¼é”ï¼ˆå¦‚æœéœ€è¦ï¼‰
import redis
import time
import uuid

class DistributedLock:
    def __init__(self, redis_client, key, timeout=10):
        self.redis = redis_client
        self.key = f"lock:{key}"
        self.timeout = timeout
        self.identifier = str(uuid.uuid4())
    
    def acquire(self):
        """è·å–é”"""
        end_time = time.time() + self.timeout
        
        while time.time() < end_time:
            if self.redis.set(self.key, self.identifier, nx=True, ex=self.timeout):
                return True
            time.sleep(0.001)  # 1ms
        
        return False
    
    def release(self):
        """é‡Šæ”¾é”"""
        lua_script = """
        if redis.call("get", KEYS[1]) == ARGV[1] then
            return redis.call("del", KEYS[1])
        else
            return 0
        end
        """
        return self.redis.eval(lua_script, 1, self.key, self.identifier)

# åœ¨éœ€è¦ä¸¥æ ¼ä¸€è‡´æ€§çš„æ“ä½œä¸­ä½¿ç”¨
def reorder_notes_with_lock(file_id, note_ids):
    lock = DistributedLock(redis_client, f"file_reorder:{file_id}")
    
    if lock.acquire():
        try:
            with database_transaction():
                # æ‰§è¡Œé‡æ’åºæ“ä½œ
                for index, note_id in enumerate(note_ids):
                    Note.query.filter_by(id=note_id, file_id=file_id)\
                              .update({'order': index})
                
                return True
        finally:
            lock.release()
    else:
        raise Exception("æ— æ³•è·å–æ–‡ä»¶é”ï¼Œè¯·ç¨åé‡è¯•")
```

#### 6.4.2 å†²çªæ£€æµ‹ä¸è§£å†³

**ç‰ˆæœ¬å·æœºåˆ¶**
```python
# åœ¨æ¨¡å‹ä¸­æ·»åŠ ç‰ˆæœ¬å­—æ®µ
class Note(db.Model):
    # ...å…¶ä»–å­—æ®µ...
    version = db.Column(db.Integer, default=1)
    
    def update_with_version_check(self, data, expected_version):
        """å¸¦ç‰ˆæœ¬æ£€æŸ¥çš„æ›´æ–°"""
        if self.version != expected_version:
            raise ConflictError(
                f"æ•°æ®å·²è¢«ä¿®æ”¹ï¼Œå½“å‰ç‰ˆæœ¬ï¼š{self.version}ï¼ŒæœŸæœ›ç‰ˆæœ¬ï¼š{expected_version}",
                current_data=self.to_dict()
            )
        
        # æ›´æ–°å­—æ®µ
        for key, value in data.items():
            if hasattr(self, key) and key != 'version':
                setattr(self, key, value)
        
        # å¢åŠ ç‰ˆæœ¬å·
        self.version += 1
        self.updated_at = datetime.utcnow()
        
        db.session.commit()
        return self

class ConflictError(Exception):
    def __init__(self, message, current_data=None):
        super().__init__(message)
        self.current_data = current_data
```

**å‰ç«¯å†²çªå¤„ç†**
```javascript
// å†²çªè§£å†³ç»„ä»¶
const ConflictResolutionDialog = ({ localData, serverData, onResolve }) => {
  const [resolution, setResolution] = useState('');
  
  const handleResolve = () => {
    switch (resolution) {
      case 'use_local':
        onResolve({ action: 'overwrite', data: localData });
        break;
      case 'use_server':
        onResolve({ action: 'accept', data: serverData });
        break;
      case 'merge':
        const mergedContent = mergeContent(localData.content, serverData.content);
        onResolve({ action: 'merge', data: { ...localData, content: mergedContent } });
        break;
    }
  };
  
  return (
    <Dialog open={true} onClose={() => {}}>
      <DialogTitle>æ•°æ®å†²çª</DialogTitle>
      <DialogContent>
        <Typography>æ£€æµ‹åˆ°æ•°æ®å†²çªï¼Œè¯·é€‰æ‹©è§£å†³æ–¹æ¡ˆï¼š</Typography>
        
        <FormControl component="fieldset">
          <RadioGroup value={resolution} onChange={(e) => setResolution(e.target.value)}>
            <FormControlLabel 
              value="use_local" 
              control={<Radio />} 
              label="ä½¿ç”¨æœ¬åœ°ç‰ˆæœ¬ï¼ˆè¦†ç›–æœåŠ¡å™¨æ•°æ®ï¼‰" 
            />
            <FormControlLabel 
              value="use_server" 
              control={<Radio />} 
              label="ä½¿ç”¨æœåŠ¡å™¨ç‰ˆæœ¬ï¼ˆä¸¢å¼ƒæœ¬åœ°æ›´æ”¹ï¼‰" 
            />
            <FormControlLabel 
              value="merge" 
              control={<Radio />} 
              label="å°è¯•åˆå¹¶ä¸¤ä¸ªç‰ˆæœ¬" 
            />
          </RadioGroup>
        </FormControl>
        
        <Box mt={2}>
          <Typography variant="h6">æœ¬åœ°ç‰ˆæœ¬ï¼š</Typography>
          <pre>{JSON.stringify(localData, null, 2)}</pre>
          
          <Typography variant="h6">æœåŠ¡å™¨ç‰ˆæœ¬ï¼š</Typography>
          <pre>{JSON.stringify(serverData, null, 2)}</pre>
        </Box>
      </DialogContent>
      
      <DialogActions>
        <Button onClick={handleResolve} disabled={!resolution}>
          ç¡®è®¤
        </Button>
      </DialogActions>
    </Dialog>
  );
};
```

#### 6.4.3 æ•°æ®æ ¡éªŒæœºåˆ¶

**åŒé‡éªŒè¯ç­–ç•¥**
```javascript
// å‰åç«¯æ•°æ®æ ¡éªŒ
class DataValidator {
  static validateNote(data) {
    const errors = {};
    
    // å†…å®¹éªŒè¯
    if (!data.content?.trim()) {
      errors.content = 'ç¬”è®°å†…å®¹ä¸èƒ½ä¸ºç©º';
    } else if (data.content.length > 100000) {
      errors.content = 'ç¬”è®°å†…å®¹ä¸èƒ½è¶…è¿‡100KB';
    }
    
    // æ ¼å¼éªŒè¯
    const validFormats = ['text', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'markdown', 'code'];
    if (!validFormats.includes(data.format)) {
      errors.format = 'æ— æ•ˆçš„ç¬”è®°æ ¼å¼';
    }
    
    // é¡ºåºéªŒè¯
    if (data.order !== undefined && (!Number.isInteger(data.order) || data.order < 0)) {
      errors.order = 'ç¬”è®°é¡ºåºå¿…é¡»æ˜¯éè´Ÿæ•´æ•°';
    }
    
    return {
      isValid: Object.keys(errors).length === 0,
      errors
    };
  }
  
  static validateFile(data) {
    const errors = {};
    
    if (!data.name?.trim()) {
      errors.name = 'æ–‡ä»¶åä¸èƒ½ä¸ºç©º';
    } else if (data.name.length > 200) {
      errors.name = 'æ–‡ä»¶åä¸èƒ½è¶…è¿‡200ä¸ªå­—ç¬¦';
    }
    
    return {
      isValid: Object.keys(errors).length === 0,
      errors
    };
  }
}
```

```python
# åç«¯æ•°æ®æ ¡éªŒ
from marshmallow import Schema, fields, validate, ValidationError

class NoteSchema(Schema):
    content = fields.Str(allow_none=True, validate=validate.Length(max=100000))
    format = fields.Str(validate=validate.OneOf([
        'text', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'markdown', 'code'
    ]))
    order = fields.Int(validate=validate.Range(min=0))
    file_id = fields.Int(required=True)

class NoteFileSchema(Schema):
    name = fields.Str(required=True, validate=validate.Length(min=1, max=200))
    folder_id = fields.Int(allow_none=True)

# åœ¨APIä¸­ä½¿ç”¨
@notes_bp.route('/notes/<int:note_id>', methods=['PUT'])
def update_note(note_id):
    schema = NoteSchema()
    
    try:
        # éªŒè¯è¯·æ±‚æ•°æ®
        validated_data = schema.load(request.get_json())
    except ValidationError as err:
        return jsonify({
            'error': 'validation_error',
            'message': 'æ•°æ®éªŒè¯å¤±è´¥',
            'details': err.messages
        }), 400
    
    # æ‰§è¡Œæ›´æ–°æ“ä½œ
    note = Note.query.get_or_404(note_id)
    
    # æ£€æŸ¥ç‰ˆæœ¬å†²çª
    expected_version = request.get_json().get('expected_version')
    if expected_version and note.version != expected_version:
        return jsonify({
            'error': 'conflict',
            'message': 'æ•°æ®å·²è¢«å…¶ä»–ç”¨æˆ·ä¿®æ”¹',
            'current_data': note.to_dict()
        }), 409
    
    # æ›´æ–°æ•°æ®
    for key, value in validated_data.items():
        if hasattr(note, key):
            setattr(note, key, value)
    
    note.version += 1
    note.updated_at = datetime.utcnow()
    
    db.session.commit()
    return jsonify(note.to_dict())
```

è¿™æ ·å®Œæ•´çš„æ•°æ®æµè½¬æœºåˆ¶ç¡®ä¿äº†ï¼š
- **æµç¨‹æ¸…æ™°**ï¼šä»ç”¨æˆ·æ“ä½œåˆ°æ•°æ®æŒä¹…åŒ–çš„å®Œæ•´é“¾è·¯
- **ä¸€è‡´æ€§ä¿è¯**ï¼šé€šè¿‡äº‹åŠ¡ã€é”æœºåˆ¶å’Œç‰ˆæœ¬æ§åˆ¶
- **æ€§èƒ½ä¼˜åŒ–**ï¼šå¤šå±‚ç¼“å­˜å’Œä¹è§‚æ›´æ–°ç­–ç•¥
- **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„å†²çªæ£€æµ‹å’Œè§£å†³æœºåˆ¶
- **ç”¨æˆ·ä½“éªŒ**ï¼šå®æ—¶åŒæ­¥å’Œç¦»çº¿æ”¯æŒ

## 7. æ ¸å¿ƒåŠŸèƒ½å®ç°

æœ¬èŠ‚è¯¦ç»†ä»‹ç»Notesåº”ç”¨çš„äº”å¤§æ ¸å¿ƒåŠŸèƒ½å®ç°ï¼ŒåŒ…æ‹¬æŠ€æœ¯æ–¹æ¡ˆã€ä»£ç æ¶æ„å’Œå®é™…åº”ç”¨ã€‚

### 7.1 ç¬”è®°CRUDæ“ä½œ

#### 7.1.1 åˆ›å»ºç¬”è®°ï¼ˆCreateï¼‰

**å‰ç«¯å®ç°æ¶æ„**
```javascript
// hooks/useNotes.js - ç¬”è®°åˆ›å»ºHook
const createNote = useCallback(async (afterNoteId, content = '', format = 'text') => {
  if (!activeFileId) {
    setErrorMessage('æ— æ³•åˆ›å»ºç¬”è®°ï¼šæœªé€‰æ‹©æ–‡ä»¶');
    return null;
  }
  
  try {
    // 1. è°ƒç”¨APIæœåŠ¡
    const newNote = await noteService.createNote(activeFileId, content, format, afterNoteId);
    
    // 2. ä¹è§‚æ›´æ–°æœ¬åœ°çŠ¶æ€
    setNotes(prevNotes => {
      const insertIndex = prevNotes.findIndex(note => note.id === afterNoteId);
      const newNotes = [...prevNotes];
      if (insertIndex !== -1) {
        newNotes.splice(insertIndex + 1, 0, newNote);
      } else {
        newNotes.push(newNote);
      }
      return newNotes;
    });
    
    return newNote.id;
    
  } catch (error) {
    setErrorMessage('åˆ›å»ºç¬”è®°å¤±è´¥: ' + (error.response?.data?.message || error.message));
    return null;
  }
}, [activeFileId, setErrorMessage]);
```

**APIæœåŠ¡å±‚å®ç°**
```javascript
// services/noteService.js - åˆ›å»ºç¬”è®°API
createNote: async (fileId, content = '', format = 'text', afterNoteId = null) => {
  try {
    const requestData = {
      content,
      format,
      after_note_id: afterNoteId
    };
    
    const response = await axios.post(`${API_URL}/files/${fileId}/notes`, requestData);
    
    // è¿”å›åˆ›å»ºçš„ç¬”è®°å¯¹è±¡
    return {
      id: response.data.id,
      content,
      format,
      order: response.data.order || 0,
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString(),
      file_id: fileId
    };
    
  } catch (error) {
    console.error('åˆ›å»ºç¬”è®°å¤±è´¥:', error);
    throw error;
  }
}
```

**åç«¯è·¯ç”±å®ç°**
```python
# app/api/notes.py - åˆ›å»ºç¬”è®°è·¯ç”±
@notes_bp.route('/files/<int:file_id>/notes', methods=['POST'])
def create_note(file_id):
    """åœ¨æŒ‡å®šæ–‡ä»¶ä¸­åˆ›å»ºæ–°ç¬”è®°"""
    data = request.get_json()
    after_note_id = data.get('after_note_id')
    content = data.get('content', '')
    format_type = data.get('format', 'text')
    
    # éªŒè¯æ–‡ä»¶å­˜åœ¨æ€§
    note_file = NoteFile.query.get_or_404(file_id)
    
    try:
        # è®¡ç®—æ’å…¥ä½ç½®
        if after_note_id:
            target_note = Note.query.get(after_note_id)
            if target_note and target_note.file_id == file_id:
                # è°ƒæ•´åç»­ç¬”è®°é¡ºåº
                Note.query.filter(
                    Note.file_id == file_id, 
                    Note.order > target_note.order
                ).update({Note.order: Note.order + 1}, synchronize_session=False)
                new_order = target_note.order + 1
            else:
                # æ·»åŠ åˆ°æœ«å°¾
                new_order = get_max_order_for_file(file_id) + 1
        else:
            new_order = get_max_order_for_file(file_id) + 1
        
        # åˆ›å»ºç¬”è®°å¯¹è±¡
        new_note = Note(
            content=content,
            format=format_type,
            order=new_order,
            file_id=file_id
        )
        
        db.session.add(new_note)
        db.session.commit()
        
        return jsonify({
            'message': 'Note created successfully',
            'id': new_note.id,
            'order': new_note.order,
            'note': new_note.to_dict()
        }), 201
        
    except Exception as e:
        db.session.rollback()
        return jsonify({
            'error': 'creation_failed',
            'message': f'åˆ›å»ºç¬”è®°å¤±è´¥: {str(e)}'
        }), 500

def get_max_order_for_file(file_id):
    """è·å–æ–‡ä»¶ä¸­ç¬”è®°çš„æœ€å¤§orderå€¼"""
    max_order = db.session.query(db.func.max(Note.order))\
                         .filter(Note.file_id == file_id)\
                         .scalar()
    return max_order if max_order is not None else 0
```

#### 7.1.2 è¯»å–ç¬”è®°ï¼ˆReadï¼‰

**æ‰¹é‡è¯»å–å®ç°**
```javascript
// è·å–æ–‡ä»¶çš„æ‰€æœ‰ç¬”è®°
const fetchNotes = useCallback(async () => {
  if (!activeFileId) {
    setNotes([]);
    return;
  }
  
  try {
    const fetchedNotes = await noteService.getNotes(activeFileId);
    setNotes(fetchedNotes || []);
  } catch (error) {
    setErrorMessage('è·å–ç¬”è®°å¤±è´¥: ' + (error.response?.data?.message || error.message));
    setNotes([]);
  }
}, [activeFileId, setErrorMessage]);
```

**åç«¯æŸ¥è¯¢ä¼˜åŒ–**
```python
@notes_bp.route('/files/<int:file_id>/notes', methods=['GET'])
def get_notes(file_id):
    """è·å–æŒ‡å®šæ–‡ä»¶ä¸‹çš„æ‰€æœ‰ç¬”è®°"""
    # éªŒè¯æ–‡ä»¶å­˜åœ¨
    note_file = NoteFile.query.get_or_404(file_id)
    
    # æŸ¥è¯¢å‚æ•°
    page = request.args.get('page', 1, type=int)
    per_page = request.args.get('per_page', 100, type=int)
    sort_by = request.args.get('sort', 'order')
    order = request.args.get('order', 'asc')
    
    # æ„å»ºæŸ¥è¯¢
    query = Note.query.filter_by(file_id=file_id)
    
    # æ’åº
    if sort_by == 'order':
        if order == 'desc':
            query = query.order_by(Note.order.desc())
        else:
            query = query.order_by(Note.order.asc())
    elif sort_by == 'created_at':
        if order == 'desc':
            query = query.order_by(Note.created_at.desc())
        else:
            query = query.order_by(Note.created_at.asc())
    
    # åˆ†é¡µæŸ¥è¯¢
    if per_page > 0:
        notes = query.paginate(
            page=page, 
            per_page=per_page, 
            error_out=False
        )
        return jsonify({
            'notes': [note.to_dict() for note in notes.items],
            'total': notes.total,
            'pages': notes.pages,
            'current_page': page
        })
    else:
        # è¿”å›æ‰€æœ‰ç¬”è®°
        notes = query.all()
        return jsonify([note.to_dict() for note in notes])
```

#### 7.1.3 æ›´æ–°ç¬”è®°ï¼ˆUpdateï¼‰

**å®æ—¶æ›´æ–°æœºåˆ¶**
```javascript
// é˜²æŠ–æ›´æ–°å‡½æ•°
const debouncedUpdate = useCallback(
  debounce((noteId, contentData) => {
    updateNote(noteId, contentData);
  }, 500),
  [updateNote]
);

// ç¬”è®°æ›´æ–°å¤„ç†
const updateNote = useCallback(async (noteId, contentData) => {
  try {
    // 1. ç«‹å³æ›´æ–°æœ¬åœ°çŠ¶æ€ï¼ˆä¹è§‚æ›´æ–°ï¼‰
    setNotes(prevNotes =>
      prevNotes.map(note =>
        note.id === noteId 
          ? { ...note, ...contentData, updated_at: new Date().toISOString() }
          : note
      )
    );
    
    // 2. å‘é€æ›´æ–°è¯·æ±‚
    await noteService.updateNote(noteId, contentData);
    
  } catch (error) {
    // 3. å¤±è´¥æ—¶å›æ»šçŠ¶æ€
    await fetchNotes();
    setErrorMessage('æ›´æ–°ç¬”è®°å¤±è´¥: ' + (error.response?.data?.message || error.message));
  }
}, [fetchNotes, setErrorMessage]);
```

**åç«¯æ›´æ–°å¤„ç†**
```python
@notes_bp.route('/notes/<int:note_id>', methods=['PUT'])
def update_note(note_id):
    """æ›´æ–°ç¬”è®°å†…å®¹"""
    note = Note.query.get_or_404(note_id)
    data = request.get_json()
    
    if not data:
        return jsonify({
            'error': 'invalid_request',
            'message': 'No data provided'
        }), 400
    
    try:
        # æ›´æ–°å­—æ®µ
        if 'content' in data:
            note.content = data['content']
        if 'format' in data and isinstance(data['format'], str):
            note.format = data['format']
        if 'order' in data and isinstance(data['order'], (int, float)):
            note.order = int(data['order'])
        
        # æ›´æ–°æ—¶é—´æˆ³
        note.updated_at = datetime.utcnow()
        
        db.session.commit()
        
        return jsonify({
            'message': 'Note updated successfully',
            'note': note.to_dict()
        })
        
    except Exception as e:
        db.session.rollback()
        return jsonify({
            'error': 'update_failed',
            'message': f'æ›´æ–°ç¬”è®°å¤±è´¥: {str(e)}'
        }), 500
```

#### 7.1.4 åˆ é™¤ç¬”è®°ï¼ˆDeleteï¼‰

**å‰ç«¯åˆ é™¤é€»è¾‘**
```javascript
const deleteNote = useCallback(async (noteId) => {
  try {
    // 1. æ‰¾åˆ°è¦åˆ é™¤çš„ç¬”è®°
    const noteToDelete = notes.find(note => note.id === noteId);
    if (!noteToDelete) return false;
    
    // 2. ä¹è§‚æ›´æ–°ï¼šç«‹å³ä»UIä¸­ç§»é™¤
    setNotes(prevNotes => prevNotes.filter(note => note.id !== noteId));
    
    // 3. å‘é€åˆ é™¤è¯·æ±‚
    await noteService.deleteNote(noteId);
    
    return true;
    
  } catch (error) {
    // 4. å¤±è´¥æ—¶æ¢å¤ç¬”è®°
    await fetchNotes();
    setErrorMessage('åˆ é™¤ç¬”è®°å¤±è´¥: ' + (error.response?.data?.message || error.message));
    return false;
  }
}, [notes, fetchNotes, setErrorMessage]);
```

**åç«¯åˆ é™¤å¤„ç†**
```python
@notes_bp.route('/notes/<int:note_id>', methods=['DELETE'])
def delete_note(note_id):
    """åˆ é™¤ç¬”è®°å¹¶è°ƒæ•´å…¶ä»–ç¬”è®°é¡ºåº"""
    note = Note.query.get_or_404(note_id)
    file_id = note.file_id
    deleted_order = note.order
    
    try:
        # 1. åˆ é™¤ç¬”è®°
        db.session.delete(note)
        
        # 2. è°ƒæ•´åç»­ç¬”è®°çš„é¡ºåº
        Note.query.filter(
            Note.file_id == file_id,
            Note.order > deleted_order
        ).update(
            {Note.order: Note.order - 1},
            synchronize_session=False
        )
        
        db.session.commit()
        
        return jsonify({
            'message': 'Note deleted successfully',
            'deleted_id': note_id
        })
        
    except Exception as e:
        db.session.rollback()
        return jsonify({
            'error': 'deletion_failed',
            'message': f'åˆ é™¤ç¬”è®°å¤±è´¥: {str(e)}'
        }), 500
```

### 7.2 æ–‡ä»¶å¤¹ç®¡ç†åŠŸèƒ½

#### 7.2.1 æ–‡ä»¶å¤¹CRUDå®ç°

**æ–‡ä»¶å¤¹åˆ›å»º**
```javascript
// hooks/useFolders.js
const createFolder = useCallback(async (name) => {
  try {
    const newFolder = await noteService.createFolder(name);
    setFolders(prevFolders => [...prevFolders, newFolder]);
    return newFolder;
  } catch (error) {
    setErrorMessage('åˆ›å»ºæ–‡ä»¶å¤¹å¤±è´¥: ' + error.message);
    return null;
  }
}, [setErrorMessage]);
```

**åç«¯æ–‡ä»¶å¤¹ç®¡ç†**
```python
# app/api/folders.py
@folders_bp.route('/folders', methods=['POST'])
def create_folder():
    """åˆ›å»ºæ–°æ–‡ä»¶å¤¹"""
    data = request.get_json()
    name = data.get('name', '').strip()
    
    if not name:
        return jsonify({
            'error': 'validation_error',
            'message': 'æ–‡ä»¶å¤¹åç§°ä¸èƒ½ä¸ºç©º'
        }), 400
    
    # æ£€æŸ¥åç§°æ˜¯å¦é‡å¤
    existing = Folder.query.filter_by(name=name).first()
    if existing:
        return jsonify({
            'error': 'duplicate_name',
            'message': f'æ–‡ä»¶å¤¹åç§° "{name}" å·²å­˜åœ¨'
        }), 409
    
    try:
        folder = Folder(name=name)
        db.session.add(folder)
        db.session.commit()
        
        return jsonify({
            'message': 'Folder created successfully',
            'folder': folder.to_dict()
        }), 201
        
    except Exception as e:
        db.session.rollback()
        return jsonify({
            'error': 'creation_failed',
            'message': f'åˆ›å»ºæ–‡ä»¶å¤¹å¤±è´¥: {str(e)}'
        }), 500

@folders_bp.route('/folders/<int:folder_id>', methods=['DELETE'])
def delete_folder(folder_id):
    """åˆ é™¤æ–‡ä»¶å¤¹åŠå…¶æ‰€æœ‰å†…å®¹"""
    folder = Folder.query.get_or_404(folder_id)
    
    try:
        # ç»Ÿè®¡å°†è¦åˆ é™¤çš„æ•°æ®
        files_count = NoteFile.query.filter_by(folder_id=folder_id).count()
        notes_count = db.session.query(db.func.count(Note.id))\
                               .join(NoteFile)\
                               .filter(NoteFile.folder_id == folder_id)\
                               .scalar()
        
        # åˆ é™¤æ–‡ä»¶å¤¹ï¼ˆçº§è”åˆ é™¤æ–‡ä»¶å’Œç¬”è®°ï¼‰
        db.session.delete(folder)
        db.session.commit()
        
        return jsonify({
            'message': 'Folder deleted successfully',
            'deleted_stats': {
                'folders': 1,
                'files': files_count,
                'notes': notes_count
            }
        })
        
    except Exception as e:
        db.session.rollback()
        return jsonify({
            'error': 'deletion_failed',
            'message': f'åˆ é™¤æ–‡ä»¶å¤¹å¤±è´¥: {str(e)}'
        }), 500
```

#### 7.2.2 æ–‡ä»¶ç»„ç»‡ä¸ç§»åŠ¨

**æ–‡ä»¶ç§»åŠ¨å®ç°**
```javascript
// å°†æ–‡ä»¶ç§»åŠ¨åˆ°æ–‡ä»¶å¤¹
const moveFileToFolder = useCallback(async (fileId, targetFolderId) => {
  try {
    // 1. ä¹è§‚æ›´æ–°UI
    setFiles(prevFiles =>
      prevFiles.map(file =>
        file.id === fileId ? { ...file, folder_id: targetFolderId } : file
      )
    );
    
    // 2. å‘é€æ›´æ–°è¯·æ±‚
    await noteService.updateFileFolder(fileId, targetFolderId);
    
  } catch (error) {
    // 3. å¤±è´¥æ—¶å›æ»š
    await fetchFiles();
    setErrorMessage('ç§»åŠ¨æ–‡ä»¶å¤±è´¥: ' + error.message);
  }
}, [fetchFiles, setErrorMessage]);
```

**åç«¯æ–‡ä»¶ç§»åŠ¨**
```python
@files_bp.route('/files/<int:file_id>/folder', methods=['PUT'])
def update_file_folder(file_id):
    """æ›´æ–°æ–‡ä»¶æ‰€å±æ–‡ä»¶å¤¹"""
    note_file = NoteFile.query.get_or_404(file_id)
    data = request.get_json()
    target_folder_id = data.get('folder_id')
    
    # éªŒè¯ç›®æ ‡æ–‡ä»¶å¤¹å­˜åœ¨ï¼ˆå¦‚æœä¸æ˜¯ç§»åŠ¨åˆ°æ ¹ç›®å½•ï¼‰
    if target_folder_id is not None:
        target_folder = Folder.query.get(target_folder_id)
        if not target_folder:
            return jsonify({
                'error': 'folder_not_found',
                'message': f'ç›®æ ‡æ–‡ä»¶å¤¹ä¸å­˜åœ¨: {target_folder_id}'
            }), 404
    
    try:
        old_folder_id = note_file.folder_id
        note_file.folder_id = target_folder_id
        note_file.updated_at = datetime.utcnow()
        
        db.session.commit()
        
        return jsonify({
            'message': 'File moved successfully',
            'file': note_file.to_dict(),
            'moved_from': old_folder_id,
            'moved_to': target_folder_id
        })
        
    except Exception as e:
        db.session.rollback()
        return jsonify({
            'error': 'move_failed',
            'message': f'ç§»åŠ¨æ–‡ä»¶å¤±è´¥: {str(e)}'
        }), 500
```

### 7.3 æ‹–æ‹½æ’åºå®ç°

#### 7.3.1 React Beautiful DnDé›†æˆ

**æ‹–æ‹½ä¸Šä¸‹æ–‡é…ç½®**
```jsx
// utils/dndWrapper.jsx - DnDç»„ä»¶å°è£…
import React from 'react';
import {
  DragDropContext as OriginalDragDropContext, 
  Droppable as OriginalDroppable,
  Draggable as OriginalDraggable
} from 'react-beautiful-dnd';

// å…¨å±€æ‹–æ‹½ä¸Šä¸‹æ–‡
export const DragDropContext = (props) => {
  return <OriginalDragDropContext {...props} />;
};

// å¯æ‹–æ‹½å®¹å™¨ç»„ä»¶
export const Droppable = ({ 
  droppableId, 
  type = "DEFAULT", 
  direction = "vertical",
  isDropDisabled = false,
  children,
  ...rest
}) => {
  return (
    <OriginalDroppable
      droppableId={droppableId}
      type={type}
      direction={direction}
      isDropDisabled={isDropDisabled}
      {...rest}
    >
      {children}
    </OriginalDroppable>
  );
};

// å¯æ‹–æ‹½é¡¹ç›®ç»„ä»¶
export const Draggable = ({ 
  draggableId, 
  index,
  isDragDisabled = false,
  children,
  ...rest
}) => {
  return (
    <OriginalDraggable
      draggableId={draggableId}
      index={index}
      isDragDisabled={isDragDisabled}
      {...rest}
    >
      {children}
    </OriginalDraggable>
  );
};
```

#### 7.3.2 ç¬”è®°æ‹–æ‹½æ’åº

**ç¬”è®°åˆ—è¡¨æ‹–æ‹½å®ç°**
```jsx
// components/NoteList.jsx
const NoteList = ({ notes, onNotesReorder, activeFileId }) => {
  const handleDragEnd = useCallback((result) => {
    const { destination, source } = result;
    
    // å¦‚æœæ²¡æœ‰æœ‰æ•ˆçš„æ‹–æ‹½ç›®æ ‡ï¼Œä¸åšä»»ä½•æ“ä½œ
    if (!destination) return;
    
    // å¦‚æœä½ç½®æ²¡æœ‰æ”¹å˜ï¼Œä¸åšä»»ä½•æ“ä½œ
    if (destination.index === source.index) return;
    
    // é‡æ–°æ’åˆ—ç¬”è®°
    const newNotes = Array.from(notes);
    const [removed] = newNotes.splice(source.index, 1);
    newNotes.splice(destination.index, 0, removed);
    
    // ç”Ÿæˆæ–°çš„IDé¡ºåº
    const newNoteIds = newNotes.map(note => note.id);
    
    // è°ƒç”¨é‡æ’åºå‡½æ•°
    onNotesReorder(newNoteIds);
  }, [notes, onNotesReorder]);
  
  return (
    <DragDropContext onDragEnd={handleDragEnd}>
      <Droppable droppableId={`notes-list-${activeFileId}`} type="note">
        {(provided, snapshot) => (
          <Box
            ref={provided.innerRef}
            {...provided.droppableProps}
            sx={{
              backgroundColor: snapshot.isDraggingOver ? 'action.hover' : 'transparent',
              minHeight: '100px',
              transition: 'background-color 0.2s ease'
            }}
          >
            {notes.map((note, index) => (
              <Draggable
                key={note.id}
                draggableId={String(note.id)}
                index={index}
              >
                {(provided, snapshot) => (
                  <Box
                    ref={provided.innerRef}
                    {...provided.draggableProps}
                    sx={{
                      transform: snapshot.isDragging 
                        ? `${provided.draggableProps.style?.transform} rotate(2deg)`
                        : provided.draggableProps.style?.transform,
                      opacity: snapshot.isDragging ? 0.8 : 1,
                      transition: 'opacity 0.2s ease'
                    }}
                  >
                    <NoteEditor
                      note={note}
                      dragHandleProps={provided.dragHandleProps}
                      isDragging={snapshot.isDragging}
                    />
                  </Box>
                )}
              </Draggable>
            ))}
            {provided.placeholder}
          </Box>
        )}
      </Droppable>
    </DragDropContext>
  );
};
```

#### 7.3.3 æ‰¹é‡é‡æ’åºå¤„ç†

**å‰ç«¯é‡æ’åºé€»è¾‘**
```javascript
// hooks/useNotes.js
const reorderNotes = useCallback(async (newNoteIds) => {
  try {
    // 1. ç«‹å³æ›´æ–°æœ¬åœ°çŠ¶æ€
    const reorderedNotes = newNoteIds.map((id, index) => {
      const note = notes.find(n => n.id === id);
      return { ...note, order: index };
    });
    setNotes(reorderedNotes);
    
    // 2. å‘é€æ‰¹é‡æ›´æ–°è¯·æ±‚
    await noteService.reorderNotes(newNoteIds);
    
  } catch (error) {
    // 3. å¤±è´¥æ—¶å›æ»šçŠ¶æ€
    await fetchNotes();
    setErrorMessage('é‡æ–°æ’åºå¤±è´¥ï¼š' + error.message);
  }
}, [notes, fetchNotes, setErrorMessage]);
```

**åç«¯æ‰¹é‡æ›´æ–°**
```python
@notes_bp.route('/notes/reorder', methods=['PUT'])
def reorder_notes():
    """æ‰¹é‡é‡æ–°æ’åºç¬”è®°"""
    data = request.get_json()
    note_ids = data.get('noteIds', [])
    
    if not note_ids:
        return jsonify({
            'error': 'validation_error',
            'message': 'noteIdsæ•°ç»„ä¸èƒ½ä¸ºç©º'
        }), 400
    
    try:
        # éªŒè¯æ‰€æœ‰ç¬”è®°éƒ½å­˜åœ¨ä¸”å±äºåŒä¸€æ–‡ä»¶
        notes_data = Note.query.filter(Note.id.in_(note_ids)).all()
        
        if len(notes_data) != len(note_ids):
            return jsonify({
                'error': 'notes_not_found',
                'message': 'éƒ¨åˆ†ç¬”è®°ä¸å­˜åœ¨'
            }), 404
        
        # æ£€æŸ¥æ˜¯å¦å±äºåŒä¸€æ–‡ä»¶
        file_ids = set(note.file_id for note in notes_data)
        if len(file_ids) > 1:
            return jsonify({
                'error': 'invalid_operation',
                'message': 'ä¸èƒ½è·¨æ–‡ä»¶é‡æ–°æ’åºç¬”è®°'
            }), 400
        
        # æ‰¹é‡æ›´æ–°é¡ºåº
        for index, note_id in enumerate(note_ids):
            Note.query.filter_by(id=note_id).update({
                'order': index,
                'updated_at': datetime.utcnow()
            })
        
        db.session.commit()
        
        return jsonify({
            'message': 'Notes reordered successfully',
            'reordered_count': len(note_ids)
        })
        
    except Exception as e:
        db.session.rollback()
        return jsonify({
            'error': 'reorder_failed',
            'message': f'é‡æ–°æ’åºå¤±è´¥: {str(e)}'
        }), 500
```

### 7.4 å¯Œæ–‡æœ¬ç¼–è¾‘å™¨é›†æˆ

#### 7.4.1 TipTapç¼–è¾‘å™¨é…ç½®

**ç¼–è¾‘å™¨æ‰©å±•é…ç½®**
```javascript
// utils/tiptapExtensions.js
import { StarterKit } from '@tiptap/starter-kit';
import { Placeholder } from '@tiptap/extension-placeholder';
import { CharacterCount } from '@tiptap/extension-character-count';
import { Highlight } from '@tiptap/extension-highlight';
import { Typography } from '@tiptap/extension-typography';

export const tiptapExtensions = [
  StarterKit.configure({
    heading: {
      levels: [1, 2, 3, 4, 5, 6], // æ”¯æŒæ‰€æœ‰æ ‡é¢˜çº§åˆ«
    },
    bulletList: {
      keepMarks: true,
      keepAttributes: false,
    },
    orderedList: {
      keepMarks: true,
      keepAttributes: false,
    },
    blockquote: {
      HTMLAttributes: {
        class: 'tiptap-blockquote',
      },
    },
    code: {
      HTMLAttributes: {
        class: 'tiptap-code',
      },
    },
    codeBlock: {
      HTMLAttributes: {
        class: 'tiptap-code-block',
      },
    },
  }),
  
  Placeholder.configure({
    placeholder: ({ node }) => {
      // æ ¹æ®èŠ‚ç‚¹ç±»å‹æ˜¾ç¤ºä¸åŒå ä½ç¬¦
      if (node.type.name === 'heading') {
        return `æ ‡é¢˜ ${node.attrs.level}...`;
      }
      return 'å¼€å§‹è¾“å…¥ç¬”è®°å†…å®¹...';
    },
    showOnlyWhenEditable: true,
    showOnlyCurrent: false,
  }),
  
  CharacterCount.configure({
    limit: 100000, // 100KBå­—ç¬¦é™åˆ¶
  }),
  
  Highlight.configure({
    multicolor: true,
    HTMLAttributes: {
      class: 'tiptap-highlight',
    },
  }),
  
  Typography.configure({
    // å¯ç”¨æ™ºèƒ½æ’ç‰ˆ
    openDoubleQuote: '"',
    closeDoubleQuote: '"',
    openSingleQuote: ''',
    closeSingleQuote: ''',
    emDash: 'â€”',
    enDash: 'â€“',
    ellipsis: 'â€¦',
  }),
];
```

#### 7.4.2 ç¼–è¾‘å™¨ç»„ä»¶å®ç°

**TipTapç¼–è¾‘å™¨ç»„ä»¶**
```jsx
// components/TipTapEditor.jsx
const TipTapEditor = ({
  note,
  isActive,
  onUpdate,
  onFocus,
  onBlur,
}) => {
  // è®°å¿†åŒ–æ‰©å±•é…ç½®ï¼Œé˜²æ­¢é‡å¤åˆ›å»º
  const memoizedExtensions = useMemo(() => tiptapExtensions, []);
  
  const editor = useEditor({
    extensions: memoizedExtensions,
    content: note?.content || '',
    onFocus: () => {
      if (onFocus) onFocus(note.id);
    },
    onBlur: onBlur,
    editorProps: {
      attributes: {
        class: 'tiptap-editor-content',
        'data-note-id': note?.id,
      },
      handleKeyDown: (view, event) => {
        return handleKeyboardShortcuts(view, event, note, onUpdate);
      },
    },
  });
  
  // é˜²æŠ–æ›´æ–°å‡½æ•°
  const debouncedUpdate = useCallback(
    debounce((id, content) => {
      if (onUpdate) {
        onUpdate(id, content);
      }
    }, 500),
    [onUpdate]
  );
  
  // ç›‘å¬ç¼–è¾‘å™¨å†…å®¹å˜åŒ–
  useEffect(() => {
    if (!editor) return;
    
    const updateHandler = () => {
      const content = editor.getHTML();
      debouncedUpdate(note.id, content);
    };
    
    editor.on('update', updateHandler);
    
    return () => {
      editor.off('update', updateHandler);
    };
  }, [editor, note.id, debouncedUpdate]);
  
  // åŒæ­¥å¤–éƒ¨å†…å®¹åˆ°ç¼–è¾‘å™¨
  useEffect(() => {
    if (editor && note?.content !== editor.getHTML()) {
      editor.commands.setContent(note.content || '', false);
    }
  }, [editor, note?.content]);
  
  // ç¼–è¾‘å™¨ç„¦ç‚¹ç®¡ç†
  useEffect(() => {
    if (editor && isActive) {
      editor.commands.focus();
    }
  }, [editor, isActive]);
  
  // å­˜å‚¨ç¼–è¾‘å™¨å®ä¾‹ä¾›å…¨å±€è®¿é—®
  useEffect(() => {
    if (editor && note?.id) {
      window.tiptapEditors = window.tiptapEditors || {};
      window.tiptapEditors[note.id] = editor;
      
      return () => {
        if (window.tiptapEditors) {
          delete window.tiptapEditors[note.id];
        }
      };
    }
  }, [editor, note?.id]);
  
  if (!editor) return null;
  
  return (
    <Box
      className="tiptap-editor"
      sx={{
        '& .ProseMirror': {
          outline: 'none',
          padding: '8px 12px',
          minHeight: '24px',
          lineHeight: 1.5,
          '&:focus': {
            backgroundColor: 'action.hover',
          },
        },
        '& .tiptap-highlight': {
          backgroundColor: 'warning.light',
          color: 'warning.contrastText',
          padding: '2px 4px',
          borderRadius: '4px',
        },
        '& .tiptap-blockquote': {
          borderLeft: '4px solid',
          borderColor: 'primary.main',
          paddingLeft: '16px',
          margin: '16px 0',
          fontStyle: 'italic',
        },
        '& .tiptap-code': {
          backgroundColor: 'grey.100',
          color: 'error.main',
          padding: '2px 4px',
          borderRadius: '4px',
          fontFamily: 'monospace',
        },
        '& .tiptap-code-block': {
          backgroundColor: 'grey.900',
          color: 'common.white',
          padding: '16px',
          borderRadius: '8px',
          fontFamily: 'monospace',
          margin: '16px 0',
          overflow: 'auto',
        },
      }}
    >
      <EditorContent editor={editor} />
    </Box>
  );
};
```

#### 7.4.3 é”®ç›˜å¿«æ·é”®å¤„ç†

**ç¼–è¾‘å™¨å¿«æ·é”®å®ç°**
```javascript
// utils/editorUtils.js
export const handleKeyboardShortcuts = (view, event, note, onUpdate) => {
  const { state, dispatch } = view;
  
  // Enteré”®å¤„ç†ï¼šåœ¨ç‰¹å®šæƒ…å†µä¸‹åˆ†å‰²ç¬”è®°
  if (event.key === 'Enter' && !event.shiftKey) {
    const { selection } = state;
    const { $from } = selection;
    
    // å¦‚æœåœ¨æ ‡é¢˜ä¸­æŒ‰Enterï¼Œåˆ›å»ºæ–°çš„æ–‡æœ¬ç¬”è®°
    if ($from.parent.type.name === 'heading') {
      event.preventDefault();
      
      const currentContent = view.dom.innerHTML;
      const cursorPos = selection.anchor;
      
      // åˆ†å‰²å†…å®¹
      const beforeContent = state.doc.cut(0, cursorPos).toJSON();
      const afterContent = state.doc.cut(cursorPos).toJSON();
      
      // æ›´æ–°å½“å‰ç¬”è®°
      if (onUpdate && beforeContent) {
        onUpdate(note.id, beforeContent);
      }
      
      // åˆ›å»ºæ–°ç¬”è®°
      if (afterContent && window.createNoteAfter) {
        window.createNoteAfter(note.id, afterContent, 'text');
      }
      
      return true;
    }
  }
  
  // Ctrl/Cmd + Enterï¼šåˆ›å»ºæ–°ç¬”è®°
  if (event.key === 'Enter' && (event.ctrlKey || event.metaKey)) {
    event.preventDefault();
    if (window.createNoteAfter) {
      window.createNoteAfter(note.id, '', 'text');
    }
    return true;
  }
  
  // Tabé”®å¤„ç†ï¼šç¼©è¿›/å–æ¶ˆç¼©è¿›
  if (event.key === 'Tab') {
    event.preventDefault();
    
    if (event.shiftKey) {
      // Shift+Tabï¼šå‡å°‘ç¼©è¿›
      return view.state.tr.setSelection(view.state.selection).scrollIntoView();
    } else {
      // Tabï¼šå¢åŠ ç¼©è¿›
      const indent = state.schema.text('    '); // 4ä¸ªç©ºæ ¼ç¼©è¿›
      dispatch(state.tr.insertText('    ', selection.from, selection.to));
      return true;
    }
  }
  
  // æ–¹å‘é”®å¯¼èˆª
  if (event.key === 'ArrowUp' && event.ctrlKey) {
    event.preventDefault();
    navigateToPreviousNote(note.id);
    return true;
  }
  
  if (event.key === 'ArrowDown' && event.ctrlKey) {
    event.preventDefault();
    navigateToNextNote(note.id);
    return true;
  }
  
  return false;
};

// ç¬”è®°é—´å¯¼èˆª
export const navigateToPreviousNote = (currentNoteId) => {
  const notes = window.currentNotes || [];
  const currentIndex = notes.findIndex(note => note.id === currentNoteId);
  
  if (currentIndex > 0) {
    const previousNote = notes[currentIndex - 1];
    focusNote(previousNote.id);
  }
};

export const navigateToNextNote = (currentNoteId) => {
  const notes = window.currentNotes || [];
  const currentIndex = notes.findIndex(note => note.id === currentNoteId);
  
  if (currentIndex < notes.length - 1) {
    const nextNote = notes[currentIndex + 1];
    focusNote(nextNote.id);
  }
};

export const focusNote = (noteId) => {
  const editor = window.tiptapEditors?.[noteId];
  if (editor) {
    editor.commands.focus('end'); // ç„¦ç‚¹å®šä½åˆ°æœ«å°¾
  }
};

// é˜²æŠ–å‡½æ•°
export const debounce = (func, wait) => {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
};
```

### 7.5 è‡ªåŠ¨ä¿å­˜æœºåˆ¶

#### 7.5.1 è‡ªåŠ¨ä¿å­˜ç­–ç•¥

**å¤šå±‚ä¿å­˜æœºåˆ¶**
```javascript
// hooks/useAutoSave.js
const useAutoSave = (data, saveFunction, delay = 1000) => {
  const [isDirty, setIsDirty] = useState(false);
  const [isLoading, setIsLoading] = useState(false);
  const [lastSaved, setLastSaved] = useState(null);
  const saveTimeoutRef = useRef(null);
  const pendingDataRef = useRef(null);
  
  // é˜²æŠ–ä¿å­˜å‡½æ•°
  const debouncedSave = useCallback(
    debounce(async (dataToSave) => {
      setIsLoading(true);
      try {
        await saveFunction(dataToSave);
        setIsDirty(false);
        setLastSaved(new Date());
        pendingDataRef.current = null;
      } catch (error) {
        console.error('è‡ªåŠ¨ä¿å­˜å¤±è´¥:', error);
        // ä¿å­˜å¤±è´¥æ—¶ä¿ç•™æ•°æ®ï¼Œç­‰å¾…ä¸‹æ¬¡é‡è¯•
        pendingDataRef.current = dataToSave;
      } finally {
        setIsLoading(false);
      }
    }, delay),
    [saveFunction, delay]
  );
  
  // ç›‘å¬æ•°æ®å˜åŒ–
  useEffect(() => {
    if (data && JSON.stringify(data) !== JSON.stringify(pendingDataRef.current)) {
      setIsDirty(true);
      pendingDataRef.current = data;
      debouncedSave(data);
    }
  }, [data, debouncedSave]);
  
  // é¡µé¢å¸è½½å‰ä¿å­˜
  useEffect(() => {
    const handleBeforeUnload = (event) => {
      if (isDirty && pendingDataRef.current) {
        // åŒæ­¥ä¿å­˜ï¼ˆå¯èƒ½ä¼šè¢«é˜»æ­¢ï¼‰
        try {
          saveFunction(pendingDataRef.current);
        } catch (error) {
          console.error('é¡µé¢å¸è½½å‰ä¿å­˜å¤±è´¥:', error);
        }
        
        // æç¤ºç”¨æˆ·æœ‰æœªä¿å­˜çš„æ›´æ”¹
        event.preventDefault();
        event.returnValue = 'æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
        return event.returnValue;
      }
    };
    
    window.addEventListener('beforeunload', handleBeforeUnload);
    
    return () => {
      window.removeEventListener('beforeunload', handleBeforeUnload);
    };
  }, [isDirty, saveFunction]);
  
  // å®šæœŸé‡è¯•å¤±è´¥çš„ä¿å­˜
  useEffect(() => {
    const retryInterval = setInterval(() => {
      if (pendingDataRef.current && !isLoading) {
        debouncedSave(pendingDataRef.current);
      }
    }, 30000); // 30ç§’é‡è¯•ä¸€æ¬¡
    
    return () => clearInterval(retryInterval);
  }, [debouncedSave, isLoading]);
  
  return {
    isDirty,
    isLoading,
    lastSaved,
    forceSave: () => {
      if (pendingDataRef.current) {
        debouncedSave(pendingDataRef.current);
      }
    }
  };
};
```

#### 7.5.2 ç¦»çº¿ä¿å­˜æ”¯æŒ

**æœ¬åœ°å­˜å‚¨å¤‡ä»½**
```javascript
// utils/offlineStorage.js
class OfflineStorage {
  constructor() {
    this.dbName = 'NotesAppOffline';
    this.version = 1;
    this.db = null;
  }
  
  async init() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(this.dbName, this.version);
      
      request.onerror = () => reject(request.error);
      request.onsuccess = () => {
        this.db = request.result;
        resolve();
      };
      
      request.onupgradeneeded = (event) => {
        const db = event.target.result;
        
        // åˆ›å»ºç¬”è®°å­˜å‚¨
        if (!db.objectStoreNames.contains('notes')) {
          const notesStore = db.createObjectStore('notes', { keyPath: 'id' });
          notesStore.createIndex('updated_at', 'updated_at', { unique: false });
        }
        
        // åˆ›å»ºå¾…åŒæ­¥é˜Ÿåˆ—
        if (!db.objectStoreNames.contains('pending_saves')) {
          db.createObjectStore('pending_saves', { keyPath: 'id', autoIncrement: true });
        }
      };
    });
  }
  
  async saveNote(note) {
    if (!this.db) await this.init();
    
    const transaction = this.db.transaction(['notes'], 'readwrite');
    const store = transaction.objectStore('notes');
    
    const noteWithTimestamp = {
      ...note,
      offline_updated_at: new Date().toISOString(),
      needs_sync: true
    };
    
    return store.put(noteWithTimestamp);
  }
  
  async getNote(noteId) {
    if (!this.db) await this.init();
    
    const transaction = this.db.transaction(['notes'], 'readonly');
    const store = transaction.objectStore('notes');
    
    return new Promise((resolve, reject) => {
      const request = store.get(noteId);
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  }
  
  async getPendingSaves() {
    if (!this.db) await this.init();
    
    const transaction = this.db.transaction(['notes'], 'readonly');
    const store = transaction.objectStore('notes');
    
    return new Promise((resolve, reject) => {
      const request = store.getAll();
      request.onsuccess = () => {
        const notes = request.result.filter(note => note.needs_sync);
        resolve(notes);
      };
      request.onerror = () => reject(request.error);
    });
  }
  
  async markAsSynced(noteId) {
    if (!this.db) await this.init();
    
    const transaction = this.db.transaction(['notes'], 'readwrite');
    const store = transaction.objectStore('notes');
    
    const note = await this.getNote(noteId);
    if (note) {
      note.needs_sync = false;
      note.last_synced = new Date().toISOString();
      return store.put(note);
    }
  }
}

// ä½¿ç”¨ç¦»çº¿å­˜å‚¨çš„è‡ªåŠ¨ä¿å­˜
const useOfflineAutoSave = (noteId, content, format) => {
  const offlineStorage = useMemo(() => new OfflineStorage(), []);
  const [syncStatus, setSyncStatus] = useState('synced');
  
  const saveToOffline = useCallback(async (data) => {
    try {
      await offlineStorage.saveNote({
        id: noteId,
        content: data.content,
        format: data.format,
        file_id: data.file_id
      });
      setSyncStatus('offline_saved');
    } catch (error) {
      console.error('ç¦»çº¿ä¿å­˜å¤±è´¥:', error);
      setSyncStatus('error');
    }
  }, [offlineStorage, noteId]);
  
  const syncToServer = useCallback(async () => {
    if (!navigator.onLine) return;
    
    try {
      setSyncStatus('syncing');
      const pendingNotes = await offlineStorage.getPendingSaves();
      
      for (const note of pendingNotes) {
        await noteService.updateNote(note.id, {
          content: note.content,
          format: note.format
        });
        await offlineStorage.markAsSynced(note.id);
      }
      
      setSyncStatus('synced');
    } catch (error) {
      console.error('åŒæ­¥åˆ°æœåŠ¡å™¨å¤±è´¥:', error);
      setSyncStatus('error');
    }
  }, [offlineStorage]);
  
  // ç½‘ç»œçŠ¶æ€å˜åŒ–æ—¶è‡ªåŠ¨åŒæ­¥
  useEffect(() => {
    const handleOnline = () => {
      syncToServer();
    };
    
    window.addEventListener('online', handleOnline);
    return () => window.removeEventListener('online', handleOnline);
  }, [syncToServer]);
  
  return {
    saveToOffline,
    syncToServer,
    syncStatus
  };
};
```

#### 7.5.3 ä¿å­˜çŠ¶æ€æŒ‡ç¤ºå™¨

**ä¿å­˜çŠ¶æ€UIç»„ä»¶**
```jsx
// components/SaveIndicator.jsx
const SaveIndicator = ({ isDirty, isLoading, lastSaved, syncStatus }) => {
  const getStatusIcon = () => {
    if (isLoading) {
      return <CircularProgress size={16} />;
    }
    
    switch (syncStatus) {
      case 'synced':
        return <CheckCircleIcon color="success" fontSize="small" />;
      case 'offline_saved':
        return <CloudOffIcon color="warning" fontSize="small" />;
      case 'error':
        return <ErrorIcon color="error" fontSize="small" />;
      case 'syncing':
        return <SyncIcon color="primary" fontSize="small" />;
      default:
        return <SaveIcon color="action" fontSize="small" />;
    }
  };
  
  const getStatusText = () => {
    if (isLoading) return 'ä¿å­˜ä¸­...';
    if (isDirty) return 'æœ‰æœªä¿å­˜çš„æ›´æ”¹';
    
    switch (syncStatus) {
      case 'synced':
        return lastSaved ? `å·²ä¿å­˜ ${formatRelativeTime(lastSaved)}` : 'å·²ä¿å­˜';
      case 'offline_saved':
        return 'ç¦»çº¿å·²ä¿å­˜ï¼Œç­‰å¾…åŒæ­¥';
      case 'error':
        return 'ä¿å­˜å¤±è´¥ï¼Œå°†è‡ªåŠ¨é‡è¯•';
      case 'syncing':
        return 'åŒæ­¥ä¸­...';
      default:
        return 'ç­‰å¾…ä¿å­˜';
    }
  };
  
  return (
    <Box
      display="flex"
      alignItems="center"
      gap={1}
      sx={{
        padding: '4px 8px',
        borderRadius: '4px',
        backgroundColor: 'background.paper',
        border: '1px solid',
        borderColor: syncStatus === 'error' ? 'error.main' : 'divider',
        fontSize: '0.75rem',
        color: 'text.secondary'
      }}
    >
      {getStatusIcon()}
      <Typography variant="caption">
        {getStatusText()}
      </Typography>
    </Box>
  );
};

// ç›¸å¯¹æ—¶é—´æ ¼å¼åŒ–
const formatRelativeTime = (date) => {
  const now = new Date();
  const diff = now - new Date(date);
  const seconds = Math.floor(diff / 1000);
  const minutes = Math.floor(seconds / 60);
  const hours = Math.floor(minutes / 60);
  
  if (seconds < 60) return 'åˆšåˆš';
  if (minutes < 60) return `${minutes}åˆ†é’Ÿå‰`;
  if (hours < 24) return `${hours}å°æ—¶å‰`;
  return new Date(date).toLocaleDateString();
};
```

è¿™æ ·å®Œæ•´çš„æ ¸å¿ƒåŠŸèƒ½å®ç°æ¶µç›–äº†ï¼š
- **CRUDæ“ä½œ**ï¼šå®Œæ•´çš„ç¬”è®°å’Œæ–‡ä»¶å¤¹ç®¡ç†åŠŸèƒ½
- **æ‹–æ‹½æ’åº**ï¼šç›´è§‚çš„ç”¨æˆ·äº¤äº’å’Œæ‰¹é‡æ•°æ®æ›´æ–°
- **å¯Œæ–‡æœ¬ç¼–è¾‘**ï¼šå¼ºå¤§çš„TipTapç¼–è¾‘å™¨é›†æˆ
- **è‡ªåŠ¨ä¿å­˜**ï¼šå¤šå±‚ä¿å­˜æœºåˆ¶å’Œç¦»çº¿æ”¯æŒ
- **ç”¨æˆ·ä½“éªŒ**ï¼šå®æ—¶åé¦ˆå’ŒçŠ¶æ€æŒ‡ç¤ºå™¨

æ¯ä¸ªåŠŸèƒ½éƒ½æä¾›äº†è¯¦ç»†çš„å‰åç«¯å®ç°ä»£ç å’Œé…ç½®ç¤ºä¾‹ï¼Œä¸ºå¼€å‘è€…æä¾›äº†å®Œæ•´çš„æŠ€æœ¯å‚è€ƒã€‚

## 8. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 8.1 å‰ç«¯æ€§èƒ½ä¼˜åŒ–

#### 8.1.1 Reactç»„ä»¶ä¼˜åŒ–

**ç»„ä»¶æ‡’åŠ è½½**
```javascript
// ä½¿ç”¨React.lazyè¿›è¡Œç»„ä»¶æ‡’åŠ è½½
const NoteEditor = React.lazy(() => import('./components/NoteEditor'));
const FolderTree = React.lazy(() => import('./components/FolderTree'));

// åœ¨è·¯ç”±ä¸­ä½¿ç”¨Suspense
function App() {
  return (
    <Router>
      <Routes>
        <Route 
          path="/editor/:id" 
          element={
            <Suspense fallback={<div>åŠ è½½ä¸­...</div>}>
              <NoteEditor />
            </Suspense>
          } 
        />
      </Routes>
    </Router>
  );
}
```

**React.memoä¼˜åŒ–**
```javascript
// ä½¿ç”¨React.memoå‡å°‘ä¸å¿…è¦çš„é‡æ¸²æŸ“
const NoteItem = React.memo(({ note, onUpdate }) => {
  return (
    <div className="note-item">
      <h3>{note.title}</h3>
      <p>{note.content}</p>
    </div>
  );
}, (prevProps, nextProps) => {
  // è‡ªå®šä¹‰æ¯”è¾ƒå‡½æ•°
  return prevProps.note.id === nextProps.note.id &&
         prevProps.note.updated_at === nextProps.note.updated_at;
});

// ä½¿ç”¨useMemoç¼“å­˜è®¡ç®—ç»“æœ
const NoteList = ({ notes, searchTerm }) => {
  const filteredNotes = useMemo(() => {
    return notes.filter(note => 
      note.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
      note.content.toLowerCase().includes(searchTerm.toLowerCase())
    );
  }, [notes, searchTerm]);

  return (
    <div>
      {filteredNotes.map(note => (
        <NoteItem key={note.id} note={note} />
      ))}
    </div>
  );
};
```

**è™šæ‹Ÿæ»šåŠ¨ä¼˜åŒ–**
```javascript
// ä½¿ç”¨react-windowå®ç°è™šæ‹Ÿæ»šåŠ¨
import { FixedSizeList as List } from 'react-window';

const VirtualizedNoteList = ({ notes }) => {
  const Row = ({ index, style }) => (
    <div style={style}>
      <NoteItem note={notes[index]} />
    </div>
  );

  return (
    <List
      height={600}
      itemCount={notes.length}
      itemSize={100}
      width="100%"
    >
      {Row}
    </List>
  );
};
```

#### 8.1.2 çŠ¶æ€ç®¡ç†ä¼˜åŒ–

**React Queryç¼“å­˜é…ç½®**
```javascript
// ä¼˜åŒ–React Queryé…ç½®
const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 5 * 60 * 1000, // 5åˆ†é’Ÿ
      cacheTime: 10 * 60 * 1000, // 10åˆ†é’Ÿ
      retry: 3,
      retryDelay: attemptIndex => Math.min(1000 * 2 ** attemptIndex, 30000),
      refetchOnWindowFocus: false,
      refetchOnReconnect: 'always',
    },
  },
});

// æ™ºèƒ½é¢„å–
const useNotesList = () => {
  const queryClient = useQueryClient();
  
  const { data: notes } = useQuery({
    queryKey: ['notes'],
    queryFn: fetchNotes,
    onSuccess: (data) => {
      // é¢„å–çƒ­é—¨ç¬”è®°è¯¦æƒ…
      data.forEach(note => {
        if (note.view_count > 10) {
          queryClient.prefetchQuery({
            queryKey: ['note', note.id],
            queryFn: () => fetchNoteById(note.id),
          });
        }
      });
    },
  });

  return { notes };
};
```

**Contextä¼˜åŒ–**
```javascript
// åˆ†ç¦»Contextå‡å°‘é‡æ¸²æŸ“
const NotesStateContext = createContext();
const NotesDispatchContext = createContext();

const NotesProvider = ({ children }) => {
  const [state, dispatch] = useReducer(notesReducer, initialState);
  
  // åˆ†ç¦»stateå’Œdispatch context
  return (
    <NotesStateContext.Provider value={state}>
      <NotesDispatchContext.Provider value={dispatch}>
        {children}
      </NotesDispatchContext.Provider>
    </NotesStateContext.Provider>
  );
};

// ä½¿ç”¨ç»†ç²’åº¦çš„selector
const useNoteById = (id) => {
  const notes = useContext(NotesStateContext);
  return useMemo(() => notes.find(note => note.id === id), [notes, id]);
};
```

#### 8.1.3 èµ„æºåŠ è½½ä¼˜åŒ–

**å›¾ç‰‡æ‡’åŠ è½½**
```javascript
// ä½¿ç”¨Intersection Observerå®ç°å›¾ç‰‡æ‡’åŠ è½½
const LazyImage = ({ src, alt, ...props }) => {
  const [imageSrc, setImageSrc] = useState(null);
  const [imageRef, setImageRef] = useState();

  useEffect(() => {
    let observer;
    
    if (imageRef && imageSrc !== src) {
      observer = new IntersectionObserver(
        entries => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              setImageSrc(src);
              observer.unobserve(imageRef);
            }
          });
        },
        { threshold: 0.1 }
      );
      observer.observe(imageRef);
    }
    
    return () => {
      if (observer && observer.unobserve) {
        observer.unobserve(imageRef);
      }
    };
  }, [imageRef, imageSrc, src]);

  return (
    <img
      {...props}
      ref={setImageRef}
      src={imageSrc}
      alt={alt}
      loading="lazy"
    />
  );
};
```

**Bundleåˆ†å‰²ä¼˜åŒ–**
```javascript
// webpack.config.js
module.exports = {
  optimization: {
    splitChunks: {
      chunks: 'all',
      cacheGroups: {
        vendor: {
          test: /[\\/]node_modules[\\/]/,
          name: 'vendors',
          chunks: 'all',
        },
        editor: {
          test: /[\\/]node_modules[\\/](@tiptap|prosemirror)/,
          name: 'editor',
          chunks: 'all',
        },
      },
    },
  },
};
```

### 8.2 åç«¯æ€§èƒ½ä¼˜åŒ–

#### 8.2.1 APIå“åº”ä¼˜åŒ–

**åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–**
```python
# app/api/notes.py
from typing import Optional
from fastapi import Query

@router.get("/notes")
async def get_notes(
    db: Session = Depends(get_db),
    page: int = Query(1, ge=1),
    limit: int = Query(20, ge=1, le=100),
    folder_id: Optional[int] = None,
    search: Optional[str] = None
):
    offset = (page - 1) * limit
    
    query = db.query(Note)
    
    if folder_id:
        query = query.filter(Note.folder_id == folder_id)
    
    if search:
        query = query.filter(
            or_(
                Note.title.contains(search),
                Note.content.contains(search)
            )
        )
    
    # ä¼˜åŒ–æŸ¥è¯¢ï¼šåªè·å–å¿…è¦å­—æ®µ
    notes = query.with_entities(
        Note.id,
        Note.title,
        Note.updated_at,
        Note.folder_id
    ).offset(offset).limit(limit).all()
    
    total = query.count()
    
    return {
        "notes": notes,
        "pagination": {
            "page": page,
            "limit": limit,
            "total": total,
            "pages": (total + limit - 1) // limit
        }
    }
```

**å“åº”å‹ç¼©**
```python
# app/main.py
from fastapi.middleware.gzip import GZipMiddleware

app = FastAPI()
app.add_middleware(GZipMiddleware, minimum_size=1000)

# è‡ªå®šä¹‰å‹ç¼©ä¸­é—´ä»¶
import gzip
from starlette.middleware.base import BaseHTTPMiddleware

class CompressionMiddleware(BaseHTTPMiddleware):
    async def dispatch(self, request, call_next):
        response = await call_next(request)
        
        # æ£€æŸ¥Accept-Encoding
        if "gzip" in request.headers.get("accept-encoding", ""):
            # å‹ç¼©å“åº”
            if response.headers.get("content-type", "").startswith("application/json"):
                content = await response.body()
                compressed = gzip.compress(content)
                
                response.headers["content-encoding"] = "gzip"
                response.headers["content-length"] = str(len(compressed))
                
        return response
```

**ç¼“å­˜ç­–ç•¥**
```python
# app/core/cache.py
import redis
import json
from typing import Any, Optional
from functools import wraps

redis_client = redis.Redis(host='localhost', port=6379, db=0)

def cache_result(expire_time: int = 300):
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            # ç”Ÿæˆç¼“å­˜é”®
            cache_key = f"{func.__name__}:{hash(str(args) + str(kwargs))}"
            
            # å°è¯•ä»ç¼“å­˜è·å–
            cached = redis_client.get(cache_key)
            if cached:
                return json.loads(cached)
            
            # æ‰§è¡Œå‡½æ•°å¹¶ç¼“å­˜ç»“æœ
            result = await func(*args, **kwargs)
            redis_client.setex(
                cache_key, 
                expire_time, 
                json.dumps(result, default=str)
            )
            
            return result
        return wrapper
    return decorator

# ä½¿ç”¨ç¼“å­˜è£…é¥°å™¨
@cache_result(expire_time=600)  # 10åˆ†é’Ÿç¼“å­˜
async def get_popular_notes(db: Session):
    return db.query(Note).filter(Note.view_count > 100).all()
```

#### 8.2.2 æ•°æ®åº“è¿æ¥ä¼˜åŒ–

**è¿æ¥æ± é…ç½®**
```python
# app/database.py
from sqlalchemy import create_engine
from sqlalchemy.pool import QueuePool

# ä¼˜åŒ–è¿æ¥æ± é…ç½®
engine = create_engine(
    DATABASE_URL,
    poolclass=QueuePool,
    pool_size=20,          # è¿æ¥æ± å¤§å°
    max_overflow=30,       # æœ€å¤§æº¢å‡ºè¿æ¥
    pool_pre_ping=True,    # è¿æ¥å‰pingæ£€æŸ¥
    pool_recycle=3600,     # è¿æ¥å›æ”¶æ—¶é—´ï¼ˆç§’ï¼‰
    echo=False             # ç”Ÿäº§ç¯å¢ƒå…³é—­SQLæ—¥å¿—
)

# å¼‚æ­¥è¿æ¥æ± ï¼ˆå¦‚æœä½¿ç”¨å¼‚æ­¥ï¼‰
from sqlalchemy.ext.asyncio import create_async_engine

async_engine = create_async_engine(
    ASYNC_DATABASE_URL,
    pool_size=20,
    max_overflow=30,
    pool_pre_ping=True,
)
```

### 8.3 æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

#### 8.3.1 ç´¢å¼•ä¼˜åŒ–

**åˆ›å»ºåˆé€‚çš„ç´¢å¼•**
```sql
-- ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µåˆ›å»ºç´¢å¼•
CREATE INDEX idx_notes_folder_id ON notes(folder_id);
CREATE INDEX idx_notes_updated_at ON notes(updated_at DESC);
CREATE INDEX idx_notes_title ON notes(title);

-- å¤åˆç´¢å¼•
CREATE INDEX idx_notes_folder_updated ON notes(folder_id, updated_at DESC);

-- å…¨æ–‡æœç´¢ç´¢å¼•
CREATE VIRTUAL TABLE notes_fts USING fts5(
    title, 
    content, 
    content_data=notes, 
    content_rowid=id
);

-- è§¦å‘å™¨ç»´æŠ¤FTSç´¢å¼•
CREATE TRIGGER notes_fts_insert AFTER INSERT ON notes BEGIN
    INSERT INTO notes_fts(rowid, title, content) 
    VALUES (new.id, new.title, new.content);
END;

CREATE TRIGGER notes_fts_update AFTER UPDATE ON notes BEGIN
    UPDATE notes_fts SET title = new.title, content = new.content 
    WHERE rowid = new.id;
END;

CREATE TRIGGER notes_fts_delete AFTER DELETE ON notes BEGIN
    DELETE FROM notes_fts WHERE rowid = old.id;
END;
```

#### 8.3.2 æŸ¥è¯¢ä¼˜åŒ–

**N+1æŸ¥è¯¢é—®é¢˜è§£å†³**
```python
# ä½¿ç”¨joinedloadé¿å…N+1æŸ¥è¯¢
from sqlalchemy.orm import joinedload

def get_notes_with_folder(db: Session):
    return db.query(Note).options(
        joinedload(Note.folder)
    ).all()

# ä½¿ç”¨selectinloadä¼˜åŒ–ä¸€å¯¹å¤šå…³ç³»
from sqlalchemy.orm import selectinload

def get_folders_with_notes(db: Session):
    return db.query(Folder).options(
        selectinload(Folder.notes)
    ).all()
```

**æŸ¥è¯¢ç»“æœç¼“å­˜**
```python
# app/services/note_service.py
from functools import lru_cache
from typing import List, Optional

class NoteService:
    def __init__(self, db: Session):
        self.db = db
    
    @lru_cache(maxsize=100)
    def get_popular_tags(self) -> List[str]:
        """è·å–çƒ­é—¨æ ‡ç­¾ï¼ˆç¼“å­˜ç»“æœï¼‰"""
        result = self.db.execute(
            text("""
            SELECT tag, COUNT(*) as count 
            FROM note_tags 
            GROUP BY tag 
            ORDER BY count DESC 
            LIMIT 20
            """)
        )
        return [row.tag for row in result]
    
    def search_notes_optimized(
        self, 
        query: str, 
        limit: int = 20
    ) -> List[Note]:
        """ä¼˜åŒ–çš„å…¨æ–‡æœç´¢"""
        if len(query) < 3:
            return []
        
        # ä½¿ç”¨FTS5è¿›è¡Œå…¨æ–‡æœç´¢
        result = self.db.execute(
            text("""
            SELECT n.* FROM notes n
            JOIN notes_fts fts ON n.id = fts.rowid
            WHERE notes_fts MATCH :query
            ORDER BY bm25(notes_fts) 
            LIMIT :limit
            """),
            {"query": query, "limit": limit}
        )
        
        return [Note(**row._asdict()) for row in result]
```

### 8.4 ç½‘ç»œè¯·æ±‚ä¼˜åŒ–

#### 8.4.1 HTTPç¼“å­˜ç­–ç•¥

**ç¼“å­˜å¤´é…ç½®**
```python
# app/api/notes.py
from fastapi import Response
from datetime import datetime, timedelta

@router.get("/notes/{note_id}")
async def get_note(
    note_id: int, 
    response: Response,
    db: Session = Depends(get_db)
):
    note = db.query(Note).filter(Note.id == note_id).first()
    
    if not note:
        raise HTTPException(status_code=404)
    
    # è®¾ç½®ç¼“å­˜å¤´
    response.headers["Cache-Control"] = "public, max-age=300"  # 5åˆ†é’Ÿ
    response.headers["ETag"] = f'"{note.updated_at.timestamp()}"'
    response.headers["Last-Modified"] = note.updated_at.strftime(
        "%a, %d %b %Y %H:%M:%S GMT"
    )
    
    return note

# é™æ€èµ„æºç¼“å­˜
@router.get("/static/{file_path:path}")
async def get_static_file(file_path: str, response: Response):
    # é•¿æœŸç¼“å­˜é™æ€èµ„æº
    response.headers["Cache-Control"] = "public, max-age=31536000"  # 1å¹´
    return FileResponse(f"static/{file_path}")
```

#### 8.4.2 è¯·æ±‚åˆå¹¶ä¸æ‰¹å¤„ç†

**æ‰¹é‡æ“ä½œAPI**
```python
# æ‰¹é‡æ›´æ–°ç¬”è®°
@router.put("/notes/batch")
async def batch_update_notes(
    updates: List[NoteUpdate],
    db: Session = Depends(get_db)
):
    updated_notes = []
    
    for update in updates:
        note = db.query(Note).filter(Note.id == update.id).first()
        if note:
            for field, value in update.dict(exclude_unset=True).items():
                setattr(note, field, value)
            updated_notes.append(note)
    
    db.commit()
    return updated_notes

# æ‰¹é‡åˆ é™¤
@router.delete("/notes/batch")
async def batch_delete_notes(
    note_ids: List[int],
    db: Session = Depends(get_db)
):
    deleted_count = db.query(Note).filter(
        Note.id.in_(note_ids)
    ).delete(synchronize_session=False)
    
    db.commit()
    return {"deleted_count": deleted_count}
```

**å‰ç«¯è¯·æ±‚åˆå¹¶**
```javascript
// è¯·æ±‚åˆå¹¶å·¥å…·
class RequestBatcher {
  constructor(batchSize = 10, delay = 100) {
    this.batchSize = batchSize;
    this.delay = delay;
    this.queue = [];
    this.timer = null;
  }

  add(request) {
    return new Promise((resolve, reject) => {
      this.queue.push({ request, resolve, reject });
      
      if (this.queue.length >= this.batchSize) {
        this.flush();
      } else if (!this.timer) {
        this.timer = setTimeout(() => this.flush(), this.delay);
      }
    });
  }

  async flush() {
    if (this.timer) {
      clearTimeout(this.timer);
      this.timer = null;
    }

    const batch = this.queue.splice(0, this.batchSize);
    if (batch.length === 0) return;

    try {
      const requests = batch.map(item => item.request);
      const responses = await this.executeBatch(requests);
      
      batch.forEach((item, index) => {
        item.resolve(responses[index]);
      });
    } catch (error) {
      batch.forEach(item => {
        item.reject(error);
      });
    }
  }

  async executeBatch(requests) {
    // æ ¹æ®è¯·æ±‚ç±»å‹åˆ†ç»„æ‰¹å¤„ç†
    const updateRequests = requests.filter(r => r.type === 'update');
    
    if (updateRequests.length > 0) {
      return await noteService.batchUpdate(updateRequests);
    }
  }
}

// ä½¿ç”¨è¯·æ±‚åˆå¹¶å™¨
const noteBatcher = new RequestBatcher();

const updateNoteOptimized = async (noteData) => {
  return noteBatcher.add({
    type: 'update',
    data: noteData
  });
};
```

#### 8.4.3 Service Workerç¼“å­˜

```javascript
// public/sw.js - Service Workerç¼“å­˜ç­–ç•¥
const CACHE_NAME = 'notes-app-v1';
const API_CACHE_NAME = 'notes-api-v1';

// å®‰è£…äº‹ä»¶
self.addEventListener('install', event => {
  event.waitUntil(
    caches.open(CACHE_NAME).then(cache => {
      return cache.addAll([
        '/',
        '/static/css/main.css',
        '/static/js/main.js',
        '/manifest.json'
      ]);
    })
  );
});

// æ‹¦æˆªç½‘ç»œè¯·æ±‚
self.addEventListener('fetch', event => {
  const { request } = event;
  
  if (request.url.includes('/api/')) {
    // APIè¯·æ±‚ä½¿ç”¨ç½‘ç»œä¼˜å…ˆç­–ç•¥
    event.respondWith(
      fetch(request)
        .then(response => {
          const responseClone = response.clone();
          caches.open(API_CACHE_NAME).then(cache => {
            cache.put(request, responseClone);
          });
          return response;
        })
        .catch(() => {
          return caches.match(request);
        })
    );
  } else {
    // é™æ€èµ„æºä½¿ç”¨ç¼“å­˜ä¼˜å…ˆç­–ç•¥
    event.respondWith(
      caches.match(request).then(response => {
        return response || fetch(request);
      })
    );
  }
});
```

é€šè¿‡è¿™äº›æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ï¼ŒNotes Applicationå¯ä»¥åœ¨å„ä¸ªå±‚é¢æå‡æ€§èƒ½ï¼š

- **å‰ç«¯ä¼˜åŒ–**ï¼šå‡å°‘é‡æ¸²æŸ“ã€å®ç°è™šæ‹Ÿæ»šåŠ¨ã€ä¼˜åŒ–èµ„æºåŠ è½½
- **åç«¯ä¼˜åŒ–**ï¼šå“åº”å‹ç¼©ã€ç»“æœç¼“å­˜ã€è¿æ¥æ± ä¼˜åŒ–
- **æ•°æ®åº“ä¼˜åŒ–**ï¼šåˆç†ç´¢å¼•ã€æŸ¥è¯¢ä¼˜åŒ–ã€ç»“æœç¼“å­˜
- **ç½‘ç»œä¼˜åŒ–**ï¼šHTTPç¼“å­˜ã€è¯·æ±‚åˆå¹¶ã€Service Workerç¦»çº¿æ”¯æŒ

è¿™äº›ä¼˜åŒ–æªæ–½èƒ½å¤Ÿæ˜¾è‘—æå‡åº”ç”¨çš„å“åº”é€Ÿåº¦å’Œç”¨æˆ·ä½“éªŒã€‚

## 9. å®‰å…¨æ€§è€ƒè™‘

### 9.1 è¾“å…¥éªŒè¯ä¸è¿‡æ»¤

#### 9.1.1 åç«¯è¾“å…¥éªŒè¯

**Pydanticæ¨¡å‹éªŒè¯**
```python
# app/schemas/note.py
from pydantic import BaseModel, Field, validator
from typing import Optional
import re
import bleach

class NoteCreate(BaseModel):
    title: str = Field(..., min_length=1, max_length=200)
    content: str = Field(..., max_length=50000)
    folder_id: Optional[int] = Field(None, ge=1)
    tags: Optional[List[str]] = Field(default=[], max_items=10)
    
    @validator('title')
    def validate_title(cls, v):
        # ç§»é™¤HTMLæ ‡ç­¾
        cleaned = bleach.clean(v, tags=[], strip=True)
        if not cleaned.strip():
            raise ValueError('æ ‡é¢˜ä¸èƒ½ä¸ºç©º')
        return cleaned.strip()
    
    @validator('content')
    def validate_content(cls, v):
        # å…è®¸çš„HTMLæ ‡ç­¾å’Œå±æ€§
        allowed_tags = [
            'p', 'br', 'strong', 'em', 'u', 's', 'h1', 'h2', 'h3', 
            'ul', 'ol', 'li', 'blockquote', 'a', 'img', 'code', 'pre'
        ]
        allowed_attributes = {
            'a': ['href', 'title'],
            'img': ['src', 'alt', 'title', 'width', 'height'],
            '*': ['class']
        }
        
        # æ¸…ç†HTMLå†…å®¹
        cleaned = bleach.clean(
            v, 
            tags=allowed_tags, 
            attributes=allowed_attributes,
            strip=True
        )
        return cleaned
    
    @validator('tags')
    def validate_tags(cls, v):
        if not v:
            return []
        
        cleaned_tags = []
        for tag in v:
            # ç§»é™¤ç‰¹æ®Šå­—ç¬¦ï¼Œåªä¿ç•™å­—æ¯æ•°å­—å’Œä¸­æ–‡
            clean_tag = re.sub(r'[^\w\u4e00-\u9fff]', '', tag)
            if clean_tag and len(clean_tag) <= 20:
                cleaned_tags.append(clean_tag)
        
        return list(set(cleaned_tags))  # å»é‡

class NoteUpdate(BaseModel):
    title: Optional[str] = Field(None, min_length=1, max_length=200)
    content: Optional[str] = Field(None, max_length=50000)
    folder_id: Optional[int] = Field(None, ge=1)
    tags: Optional[List[str]] = Field(None, max_items=10)
    
    # å¤ç”¨ç›¸åŒçš„éªŒè¯å™¨
    _validate_title = validator('title', allow_reuse=True)(NoteCreate.validate_title)
    _validate_content = validator('content', allow_reuse=True)(NoteCreate.validate_content)
    _validate_tags = validator('tags', allow_reuse=True)(NoteCreate.validate_tags)
```

**APIå±‚é¢éªŒè¯**
```python
# app/api/notes.py
from fastapi import HTTPException, Depends
from app.core.security import validate_user_permission

@router.post("/notes", response_model=Note)
async def create_note(
    note_data: NoteCreate,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    # éªŒè¯æ–‡ä»¶å¤¹æƒé™
    if note_data.folder_id:
        folder = db.query(Folder).filter(
            Folder.id == note_data.folder_id,
            Folder.user_id == current_user.id
        ).first()
        if not folder:
            raise HTTPException(
                status_code=403, 
                detail="æ— æƒé™è®¿é—®æŒ‡å®šæ–‡ä»¶å¤¹"
            )
    
    # éªŒè¯å†…å®¹é•¿åº¦
    if len(note_data.content.encode('utf-8')) > 100000:  # 100KBé™åˆ¶
        raise HTTPException(
            status_code=413, 
            detail="ç¬”è®°å†…å®¹è¿‡å¤§"
        )
    
    # åˆ›å»ºç¬”è®°
    note = Note(
        **note_data.dict(),
        user_id=current_user.id,
        created_at=datetime.utcnow(),
        updated_at=datetime.utcnow()
    )
    
    db.add(note)
    db.commit()
    db.refresh(note)
    
    return note
```

#### 9.1.2 å‰ç«¯è¾“å…¥è¿‡æ»¤

**å¯Œæ–‡æœ¬ç¼–è¾‘å™¨å®‰å…¨é…ç½®**
```javascript
// frontend/src/components/TipTapEditor.jsx
import { Editor } from '@tiptap/react';
import DOMPurify from 'dompurify';

const TipTapEditor = ({ content, onChange }) => {
  const editor = useEditor({
    extensions: [
      StarterKit.configure({
        // ç¦ç”¨å±é™©çš„HTMLå…ƒç´ 
        codeBlock: false,
        hardBreak: false,
      }),
      Link.configure({
        // é“¾æ¥å®‰å…¨é…ç½®
        openOnClick: false,
        linkOnPaste: false,
        validate: href => {
          // åªå…è®¸HTTP(S)å’Œmailtoé“¾æ¥
          return /^https?:\/\//.test(href) || /^mailto:/.test(href);
        },
      }),
      Image.configure({
        // å›¾ç‰‡å®‰å…¨é…ç½®
        allowBase64: false,
        inline: true,
      }),
    ],
    content: sanitizeContent(content),
    onUpdate: ({ editor }) => {
      const html = editor.getHTML();
      const sanitized = sanitizeContent(html);
      onChange(sanitized);
    },
  });

  // å†…å®¹å‡€åŒ–å‡½æ•°
  const sanitizeContent = (html) => {
    return DOMPurify.sanitize(html, {
      ALLOWED_TAGS: [
        'p', 'br', 'strong', 'em', 'u', 's', 'h1', 'h2', 'h3',
        'ul', 'ol', 'li', 'blockquote', 'a', 'img', 'code', 'pre'
      ],
      ALLOWED_ATTR: [
        'href', 'src', 'alt', 'title', 'class', 'width', 'height'
      ],
      ALLOW_DATA_ATTR: false,
      ALLOW_UNKNOWN_PROTOCOLS: false,
      ALLOWED_URI_REGEXP: /^(?:(?:https?|mailto):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i,
    });
  };

  return <EditorContent editor={editor} />;
};
```

**è¡¨å•éªŒè¯ç»„ä»¶**
```javascript
// frontend/src/components/ValidatedInput.jsx
import { useState, useEffect } from 'react';

const ValidatedInput = ({ 
  value, 
  onChange, 
  validation, 
  placeholder,
  maxLength = 200 
}) => {
  const [error, setError] = useState('');
  const [isValid, setIsValid] = useState(true);

  const validateInput = (inputValue) => {
    // åŸºæœ¬é•¿åº¦éªŒè¯
    if (inputValue.length > maxLength) {
      return `è¾“å…¥å†…å®¹ä¸èƒ½è¶…è¿‡${maxLength}ä¸ªå­—ç¬¦`;
    }

    // XSSæ”»å‡»æ£€æµ‹
    const scriptRegex = /<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi;
    if (scriptRegex.test(inputValue)) {
      return 'è¾“å…¥å†…å®¹åŒ…å«ä¸å®‰å…¨çš„è„šæœ¬';
    }

    // è‡ªå®šä¹‰éªŒè¯è§„åˆ™
    if (validation && typeof validation === 'function') {
      const validationError = validation(inputValue);
      if (validationError) {
        return validationError;
      }
    }

    return '';
  };

  const handleChange = (e) => {
    const newValue = e.target.value;
    const validationError = validateInput(newValue);
    
    setError(validationError);
    setIsValid(!validationError);
    
    // åªåœ¨éªŒè¯é€šè¿‡æ—¶è°ƒç”¨onChange
    if (!validationError) {
      onChange(newValue);
    }
  };

  return (
    <div className="validated-input">
      <input
        type="text"
        value={value}
        onChange={handleChange}
        placeholder={placeholder}
        className={`form-input ${!isValid ? 'error' : ''}`}
        maxLength={maxLength}
      />
      {error && <span className="error-message">{error}</span>}
      <span className="char-count">
        {value.length}/{maxLength}
      </span>
    </div>
  );
};
```

### 9.2 SQLæ³¨å…¥é˜²æŠ¤

#### 9.2.1 ORMå®‰å…¨å®è·µ

**å‚æ•°åŒ–æŸ¥è¯¢**
```python
# æ­£ç¡®çš„æŸ¥è¯¢æ–¹å¼ - ä½¿ç”¨ORM
def search_notes_safe(db: Session, user_id: int, search_term: str):
    return db.query(Note).filter(
        Note.user_id == user_id,
        or_(
            Note.title.ilike(f"%{search_term}%"),
            Note.content.ilike(f"%{search_term}%")
        )
    ).all()

# å¦‚æœå¿…é¡»ä½¿ç”¨åŸç”ŸSQLï¼Œä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
from sqlalchemy import text

def search_notes_with_sql(db: Session, user_id: int, search_term: str):
    query = text("""
        SELECT * FROM notes 
        WHERE user_id = :user_id 
        AND (title ILIKE :search_term OR content ILIKE :search_term)
        ORDER BY updated_at DESC
    """)
    
    return db.execute(
        query, 
        {
            "user_id": user_id, 
            "search_term": f"%{search_term}%"
        }
    ).fetchall()

# é”™è¯¯ç¤ºä¾‹ - æ°¸è¿œä¸è¦è¿™æ ·åš
def search_notes_unsafe(db: Session, search_term: str):
    # è¿™æ˜¯å±é™©çš„ï¼å®¹æ˜“å—åˆ°SQLæ³¨å…¥æ”»å‡»
    query = f"SELECT * FROM notes WHERE title LIKE '%{search_term}%'"
    return db.execute(query).fetchall()
```

#### 9.2.2 æ•°æ®åº“æƒé™æ§åˆ¶

**æ•°æ®åº“ç”¨æˆ·æƒé™é…ç½®**
```sql
-- åˆ›å»ºä¸“ç”¨æ•°æ®åº“ç”¨æˆ·
CREATE USER 'notes_app'@'localhost' IDENTIFIED BY 'secure_password';

-- åªæˆäºˆå¿…è¦çš„æƒé™
GRANT SELECT, INSERT, UPDATE, DELETE ON notes_db.notes TO 'notes_app'@'localhost';
GRANT SELECT, INSERT, UPDATE, DELETE ON notes_db.folders TO 'notes_app'@'localhost';
GRANT SELECT, INSERT, UPDATE, DELETE ON notes_db.note_files TO 'notes_app'@'localhost';

-- ä¸æˆäºˆCREATE, DROP, ALTERç­‰å±é™©æƒé™
-- ä¸æˆäºˆå¯¹ç³»ç»Ÿè¡¨çš„è®¿é—®æƒé™

FLUSH PRIVILEGES;
```

**è¿æ¥å­—ç¬¦ä¸²å®‰å…¨é…ç½®**
```python
# app/core/config.py
import os
from urllib.parse import quote_plus

class Settings:
    # æ•°æ®åº“è¿æ¥å®‰å…¨é…ç½®
    DATABASE_USER = os.getenv("DB_USER", "notes_app")
    DATABASE_PASSWORD = os.getenv("DB_PASSWORD")
    DATABASE_HOST = os.getenv("DB_HOST", "localhost")
    DATABASE_PORT = os.getenv("DB_PORT", "3306")
    DATABASE_NAME = os.getenv("DB_NAME", "notes_db")
    
    @property
    def DATABASE_URL(self) -> str:
        if not self.DATABASE_PASSWORD:
            raise ValueError("æ•°æ®åº“å¯†ç æœªè®¾ç½®")
        
        # URLç¼–ç å¯†ç ä»¥å¤„ç†ç‰¹æ®Šå­—ç¬¦
        encoded_password = quote_plus(self.DATABASE_PASSWORD)
        
        return (
            f"mysql+pymysql://{self.DATABASE_USER}:{encoded_password}"
            f"@{self.DATABASE_HOST}:{self.DATABASE_PORT}/{self.DATABASE_NAME}"
            f"?charset=utf8mb4&autocommit=true"
        )

settings = Settings()
```

### 9.3 XSSæ”»å‡»é˜²æŠ¤

#### 9.3.1 å†…å®¹å®‰å…¨ç­–ç•¥(CSP)

**CSPå¤´é…ç½®**
```python
# app/middleware/security.py
from fastapi import Request, Response
from starlette.middleware.base import BaseHTTPMiddleware

class SecurityHeadersMiddleware(BaseHTTPMiddleware):
    async def dispatch(self, request: Request, call_next):
        response = await call_next(request)
        
        # Content Security Policy
        csp_directives = [
            "default-src 'self'",
            "script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net",
            "style-src 'self' 'unsafe-inline' https://fonts.googleapis.com",
            "font-src 'self' https://fonts.gstatic.com",
            "img-src 'self' data: https:",
            "connect-src 'self' ws: wss:",
            "frame-ancestors 'none'",
            "form-action 'self'",
            "base-uri 'self'"
        ]
        
        response.headers["Content-Security-Policy"] = "; ".join(csp_directives)
        
        # å…¶ä»–å®‰å…¨å¤´
        response.headers["X-Content-Type-Options"] = "nosniff"
        response.headers["X-Frame-Options"] = "DENY"
        response.headers["X-XSS-Protection"] = "1; mode=block"
        response.headers["Referrer-Policy"] = "strict-origin-when-cross-origin"
        response.headers["Permissions-Policy"] = "geolocation=(), microphone=(), camera=()"
        
        return response

# åœ¨ä¸»åº”ç”¨ä¸­æ·»åŠ ä¸­é—´ä»¶
app.add_middleware(SecurityHeadersMiddleware)
```

#### 9.3.2 è¾“å‡ºç¼–ç 

**æ¨¡æ¿å®‰å…¨æ¸²æŸ“**
```javascript
// frontend/src/utils/sanitizer.js
import DOMPurify from 'dompurify';

export const sanitizeHtml = (dirty) => {
  return DOMPurify.sanitize(dirty, {
    ALLOWED_TAGS: [
      'p', 'br', 'strong', 'em', 'u', 's', 'h1', 'h2', 'h3',
      'ul', 'ol', 'li', 'blockquote', 'a', 'code', 'pre'
    ],
    ALLOWED_ATTR: ['href', 'class'],
    ALLOW_DATA_ATTR: false,
  });
};

export const escapeHtml = (text) => {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
};

// åœ¨ç»„ä»¶ä¸­ä½¿ç”¨
const NoteDisplay = ({ note }) => {
  return (
    <div className="note-content">
      <h2>{escapeHtml(note.title)}</h2>
      <div 
        dangerouslySetInnerHTML={{
          __html: sanitizeHtml(note.content)
        }}
      />
    </div>
  );
};
```

**JSONå“åº”å®‰å…¨**
```python
# app/api/responses.py
import json
from typing import Any

def safe_json_response(data: Any) -> str:
    """å®‰å…¨çš„JSONåºåˆ—åŒ–ï¼Œé˜²æ­¢XSS"""
    json_str = json.dumps(data, ensure_ascii=True, separators=(',', ':'))
    
    # è½¬ä¹‰å¯èƒ½å±é™©çš„å­—ç¬¦
    json_str = json_str.replace('<', '\\u003c')
    json_str = json_str.replace('>', '\\u003e')
    json_str = json_str.replace('&', '\\u0026')
    json_str = json_str.replace("'", '\\u0027')
    
    return json_str
```

### 9.4 CSRFé˜²æŠ¤æœºåˆ¶

#### 9.4.1 CSRFä»¤ç‰Œå®ç°

**åç«¯CSRFä¿æŠ¤**
```python
# app/core/csrf.py
import secrets
import hmac
import hashlib
from typing import Optional
from fastapi import HTTPException, Request
from datetime import datetime, timedelta

class CSRFProtection:
    def __init__(self, secret_key: str):
        self.secret_key = secret_key.encode()
        self.token_lifetime = timedelta(hours=8)
    
    def generate_token(self, session_id: str) -> str:
        """ç”ŸæˆCSRFä»¤ç‰Œ"""
        timestamp = int(datetime.utcnow().timestamp())
        random_part = secrets.token_hex(16)
        
        # åˆ›å»ºç­¾å
        message = f"{session_id}:{timestamp}:{random_part}"
        signature = hmac.new(
            self.secret_key,
            message.encode(),
            hashlib.sha256
        ).hexdigest()
        
        return f"{timestamp}:{random_part}:{signature}"
    
    def validate_token(self, token: str, session_id: str) -> bool:
        """éªŒè¯CSRFä»¤ç‰Œ"""
        try:
            timestamp_str, random_part, signature = token.split(':', 2)
            timestamp = int(timestamp_str)
            
            # æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦è¿‡æœŸ
            token_time = datetime.fromtimestamp(timestamp)
            if datetime.utcnow() - token_time > self.token_lifetime:
                return False
            
            # éªŒè¯ç­¾å
            message = f"{session_id}:{timestamp}:{random_part}"
            expected_signature = hmac.new(
                self.secret_key,
                message.encode(),
                hashlib.sha256
            ).hexdigest()
            
            return hmac.compare_digest(signature, expected_signature)
            
        except (ValueError, TypeError):
            return False

# åœ¨APIä¸­ä½¿ç”¨CSRFä¿æŠ¤
csrf_protection = CSRFProtection(settings.SECRET_KEY)

async def verify_csrf_token(request: Request):
    """CSRFä»¤ç‰ŒéªŒè¯ä¾èµ–"""
    if request.method in ['GET', 'HEAD', 'OPTIONS']:
        return  # è¯»æ“ä½œä¸éœ€è¦CSRFä¿æŠ¤
    
    csrf_token = request.headers.get('X-CSRF-Token')
    if not csrf_token:
        raise HTTPException(status_code=403, detail="ç¼ºå°‘CSRFä»¤ç‰Œ")
    
    session_id = request.session.get('session_id')
    if not session_id:
        raise HTTPException(status_code=403, detail="æ— æ•ˆä¼šè¯")
    
    if not csrf_protection.validate_token(csrf_token, session_id):
        raise HTTPException(status_code=403, detail="æ— æ•ˆCSRFä»¤ç‰Œ")

# åœ¨éœ€è¦ä¿æŠ¤çš„ç«¯ç‚¹ä¸Šåº”ç”¨
@router.post("/notes", dependencies=[Depends(verify_csrf_token)])
async def create_note(note_data: NoteCreate):
    # åˆ›å»ºç¬”è®°çš„é€»è¾‘
    pass
```

#### 9.4.2 å‰ç«¯CSRFä»¤ç‰Œå¤„ç†

**Axiosè¯·æ±‚æ‹¦æˆªå™¨**
```javascript
// frontend/src/services/api.js
import axios from 'axios';

// åˆ›å»ºaxioså®ä¾‹
const api = axios.create({
  baseURL: process.env.REACT_APP_API_URL,
  withCredentials: true, // å‘é€cookies
});

// è·å–CSRFä»¤ç‰Œ
const getCSRFToken = async () => {
  try {
    const response = await api.get('/auth/csrf-token');
    return response.data.csrf_token;
  } catch (error) {
    console.error('è·å–CSRFä»¤ç‰Œå¤±è´¥:', error);
    throw error;
  }
};

// è¯·æ±‚æ‹¦æˆªå™¨ - æ·»åŠ CSRFä»¤ç‰Œ
api.interceptors.request.use(
  async (config) => {
    // å¯¹äºéGETè¯·æ±‚ï¼Œæ·»åŠ CSRFä»¤ç‰Œ
    if (!['get', 'head', 'options'].includes(config.method?.toLowerCase())) {
      try {
        const csrfToken = await getCSRFToken();
        config.headers['X-CSRF-Token'] = csrfToken;
      } catch (error) {
        console.error('æ·»åŠ CSRFä»¤ç‰Œå¤±è´¥:', error);
        throw error;
      }
    }
    
    return config;
  },
  (error) => {
    return Promise.reject(error);
  }
);

// å“åº”æ‹¦æˆªå™¨ - å¤„ç†CSRFé”™è¯¯
api.interceptors.response.use(
  (response) => response,
  async (error) => {
    if (error.response?.status === 403 && 
        error.response?.data?.detail?.includes('CSRF')) {
      // CSRFä»¤ç‰Œå¤±æ•ˆï¼Œé‡æ–°è·å–å¹¶é‡è¯•
      try {
        const csrfToken = await getCSRFToken();
        error.config.headers['X-CSRF-Token'] = csrfToken;
        return api.request(error.config);
      } catch (retryError) {
        console.error('é‡è¯•è¯·æ±‚å¤±è´¥:', retryError);
        // å¯ä»¥åœ¨è¿™é‡Œè§¦å‘ç”¨æˆ·é‡æ–°ç™»å½•
        window.location.href = '/login';
      }
    }
    
    return Promise.reject(error);
  }
);

export default api;
```

**è¡¨å•CSRFä¿æŠ¤ç»„ä»¶**
```javascript
// frontend/src/components/CSRFProtectedForm.jsx
import { useState, useEffect } from 'react';
import { getCSRFToken } from '../services/auth';

const CSRFProtectedForm = ({ onSubmit, children, ...props }) => {
  const [csrfToken, setCSRFToken] = useState('');

  useEffect(() => {
    const fetchCSRFToken = async () => {
      try {
        const token = await getCSRFToken();
        setCSRFToken(token);
      } catch (error) {
        console.error('è·å–CSRFä»¤ç‰Œå¤±è´¥:', error);
      }
    };

    fetchCSRFToken();
  }, []);

  const handleSubmit = async (e) => {
    e.preventDefault();
    
    if (!csrfToken) {
      console.error('CSRFä»¤ç‰Œæœªå°±ç»ª');
      return;
    }

    // å°†CSRFä»¤ç‰Œæ·»åŠ åˆ°è¡¨å•æ•°æ®ä¸­
    const formData = new FormData(e.target);
    formData.append('csrf_token', csrfToken);

    await onSubmit(formData);
  };

  return (
    <form onSubmit={handleSubmit} {...props}>
      <input type="hidden" name="csrf_token" value={csrfToken} />
      {children}
    </form>
  );
};

export default CSRFProtectedForm;
```

#### 9.4.3 SameSite Cookieé…ç½®

```python
# app/core/session.py
from fastapi import FastAPI
from starlette.middleware.sessions import SessionMiddleware

def configure_session_security(app: FastAPI):
    app.add_middleware(
        SessionMiddleware, 
        secret_key=settings.SECRET_KEY,
        session_cookie="notes_session",
        max_age=8 * 60 * 60,  # 8å°æ—¶
        same_site="strict",   # ä¸¥æ ¼çš„SameSiteç­–ç•¥
        https_only=settings.ENVIRONMENT == "production",  # ç”Ÿäº§ç¯å¢ƒå¼ºåˆ¶HTTPS
        httponly=True,        # é˜²æ­¢JavaScriptè®¿é—®
    )
```

é€šè¿‡è¿™äº›å…¨é¢çš„å®‰å…¨æªæ–½ï¼ŒNotes Applicationèƒ½å¤Ÿæœ‰æ•ˆé˜²æŠ¤å¸¸è§çš„Webå®‰å…¨å¨èƒï¼š

- **è¾“å…¥éªŒè¯**ï¼šå¤šå±‚éªŒè¯ç¡®ä¿æ•°æ®å®‰å…¨æ€§
- **SQLæ³¨å…¥é˜²æŠ¤**ï¼šä½¿ç”¨ORMå’Œå‚æ•°åŒ–æŸ¥è¯¢
- **XSSé˜²æŠ¤**ï¼šå†…å®¹å‡€åŒ–å’ŒCSPç­–ç•¥
- **CSRFé˜²æŠ¤**ï¼šä»¤ç‰ŒéªŒè¯å’ŒSameSite cookies

è¿™äº›å®‰å…¨å®è·µä¸ºåº”ç”¨æä¾›äº†å¼ºæœ‰åŠ›çš„å®‰å…¨ä¿éšœã€‚

## 10. éƒ¨ç½²ä¸è¿ç»´

### 10.1 å¼€å‘ç¯å¢ƒé…ç½®

#### 10.1.1 ç¯å¢ƒè¦æ±‚

**ç³»ç»Ÿè¦æ±‚**
```bash
# å¼€å‘ç¯å¢ƒä¾èµ–
- Python 3.9+
- Node.js 16+
- npm 8+ æˆ– yarn 1.22+
- SQLite 3.35+
- Git 2.30+

# æ¨èå¼€å‘å·¥å…·
- VS Code + Python Extension
- Chrome DevTools
- Postman æˆ– Insomnia (APIæµ‹è¯•)
```

**è™šæ‹Ÿç¯å¢ƒè®¾ç½®**
```bash
# 1. å…‹éš†é¡¹ç›®
git clone https://github.com/your-username/notes-application.git
cd notes-application

# 2. åˆ›å»ºPythonè™šæ‹Ÿç¯å¢ƒ
python -m venv venv

# 3. æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
# Windows
venv\Scripts\activate
# macOS/Linux
source venv/bin/activate

# 4. å®‰è£…Pythonä¾èµ–
pip install -r requirements.txt

# 5. å®‰è£…å‰ç«¯ä¾èµ–
cd frontend
npm install
cd ..
```

**ç¯å¢ƒå˜é‡é…ç½®**
```bash
# .env.development
DATABASE_URL=sqlite:///./notes_dev.db
SECRET_KEY=development-secret-key-change-in-production
ENVIRONMENT=development
DEBUG=true
CORS_ORIGINS=["http://localhost:3000"]
LOG_LEVEL=debug

# å‰ç«¯ç¯å¢ƒå˜é‡
# frontend/.env.development
REACT_APP_API_URL=http://localhost:8000
REACT_APP_ENVIRONMENT=development
REACT_APP_LOG_LEVEL=debug
```

#### 10.1.2 å¼€å‘æœåŠ¡å™¨å¯åŠ¨

**åç«¯å¯åŠ¨è„šæœ¬**
```bash
#!/bin/bash
# scripts/start-backend.sh

echo "å¯åŠ¨åç«¯å¼€å‘æœåŠ¡å™¨..."

# æ£€æŸ¥è™šæ‹Ÿç¯å¢ƒ
if [[ "$VIRTUAL_ENV" == "" ]]; then
    echo "é”™è¯¯: è¯·å…ˆæ¿€æ´»Pythonè™šæ‹Ÿç¯å¢ƒ"
    exit 1
fi

# æ•°æ®åº“è¿ç§»
alembic upgrade head

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**å‰ç«¯å¯åŠ¨è„šæœ¬**
```bash
#!/bin/bash
# scripts/start-frontend.sh

echo "å¯åŠ¨å‰ç«¯å¼€å‘æœåŠ¡å™¨..."

cd frontend

# æ£€æŸ¥ä¾èµ–
if [ ! -d "node_modules" ]; then
    echo "å®‰è£…å‰ç«¯ä¾èµ–..."
    npm install
fi

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm start
```

**ä¸€é”®å¯åŠ¨è„šæœ¬**
```bash
#!/bin/bash
# scripts/dev-start.sh

# å¹¶è¡Œå¯åŠ¨å‰åç«¯æœåŠ¡
echo "å¯åŠ¨Notes Applicationå¼€å‘ç¯å¢ƒ..."

# å¯åŠ¨åç«¯ï¼ˆåå°è¿è¡Œï¼‰
(cd .. && source venv/bin/activate && uvicorn app.main:app --reload --port 8000) &
BACKEND_PID=$!

# å¯åŠ¨å‰ç«¯
(cd frontend && npm start) &
FRONTEND_PID=$!

echo "åç«¯æœåŠ¡PID: $BACKEND_PID"
echo "å‰ç«¯æœåŠ¡PID: $FRONTEND_PID"

# ç­‰å¾…ç”¨æˆ·ä¸­æ–­
echo "æŒ‰ Ctrl+C åœæ­¢æ‰€æœ‰æœåŠ¡"
wait

# æ¸…ç†è¿›ç¨‹
kill $BACKEND_PID $FRONTEND_PID 2>/dev/null
```

### 10.2 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

#### 10.2.1 ç”Ÿäº§ç¯å¢ƒé…ç½®

**ç”Ÿäº§ç¯å¢ƒè¦æ±‚**
```bash
# æœåŠ¡å™¨è¦æ±‚
- Ubuntu 20.04+ æˆ– CentOS 8+
- 2GB+ RAM
- 20GB+ å­˜å‚¨ç©ºé—´
- Python 3.9+
- Nginx 1.18+
- SSLè¯ä¹¦

# æ¨èé…ç½®
- 4GB RAM
- 50GB SSD
- CDNæœåŠ¡
- æ•°æ®åº“å¤‡ä»½ç­–ç•¥
```

**ç”Ÿäº§ç¯å¢ƒå˜é‡**
```bash
# .env.production
DATABASE_URL=postgresql://user:password@localhost:5432/notes_prod
SECRET_KEY=super-secure-random-key-256-bits
ENVIRONMENT=production
DEBUG=false
CORS_ORIGINS=["https://yourdomain.com"]
LOG_LEVEL=info
SSL_ENABLED=true

# é‚®ä»¶é…ç½® (ç”¨äºé”™è¯¯é€šçŸ¥)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASSWORD=your-app-password
ADMIN_EMAIL=admin@yourdomain.com
```

#### 10.2.2 Nginxé…ç½®

**Nginxç«™ç‚¹é…ç½®**
```nginx
# /etc/nginx/sites-available/notes-app
server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com;
    
    # é‡å®šå‘åˆ°HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name yourdomain.com www.yourdomain.com;
    
    # SSLé…ç½®
    ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # å®‰å…¨å¤´
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # Gzipå‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;
    
    # é™æ€æ–‡ä»¶æœåŠ¡
    location /static/ {
        alias /var/www/notes-app/frontend/build/static/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # APIä»£ç†
    location /api/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocketæ”¯æŒ
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # è¶…æ—¶é…ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # å‰ç«¯åº”ç”¨
    location / {
        root /var/www/notes-app/frontend/build;
        try_files $uri $uri/ /index.html;
        
        # ç¼“å­˜ç­–ç•¥
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
    
    # å¥åº·æ£€æŸ¥
    location /health {
        proxy_pass http://127.0.0.1:8000/health;
        access_log off;
    }
}
```

#### 10.2.3 SystemdæœåŠ¡é…ç½®

**åç«¯æœåŠ¡é…ç½®**
```ini
# /etc/systemd/system/notes-backend.service
[Unit]
Description=Notes Application Backend
After=network.target

[Service]
Type=exec
User=www-data
Group=www-data
WorkingDirectory=/var/www/notes-app
Environment=PATH=/var/www/notes-app/venv/bin
EnvironmentFile=/var/www/notes-app/.env.production
ExecStart=/var/www/notes-app/venv/bin/gunicorn app.main:app -c gunicorn.conf.py
ExecReload=/bin/kill -s HUP $MAINPID
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
```

**Gunicorné…ç½®**
```python
# gunicorn.conf.py
import multiprocessing
import os

# æœåŠ¡å™¨é…ç½®
bind = "127.0.0.1:8000"
workers = multiprocessing.cpu_count() * 2 + 1
worker_class = "uvicorn.workers.UvicornWorker"
worker_connections = 1000
max_requests = 1000
max_requests_jitter = 100

# æ—¥å¿—é…ç½®
accesslog = "/var/log/notes-app/access.log"
errorlog = "/var/log/notes-app/error.log"
loglevel = "info"
access_log_format = '%(h)s %(l)s %(u)s %(t)s "%(r)s" %(s)s %(b)s "%(f)s" "%(a)s" %(D)s'

# è¿›ç¨‹é…ç½®
user = "www-data"
group = "www-data"
tmp_upload_dir = None
secure_scheme_headers = {
    'X-FORWARDED-PROTOCOL': 'ssl',
    'X-FORWARDED-PROTO': 'https',
    'X-FORWARDED-SSL': 'on'
}

# æ€§èƒ½ä¼˜åŒ–
preload_app = True
keepalive = 5
timeout = 120
graceful_timeout = 30
```

#### 10.2.4 éƒ¨ç½²è„šæœ¬

**è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬**
```bash
#!/bin/bash
# scripts/deploy.sh

set -e

PROJECT_DIR="/var/www/notes-app"
BACKUP_DIR="/var/backups/notes-app"
BRANCH=${1:-main}

echo "å¼€å§‹éƒ¨ç½² Notes Application..."

# 1. åˆ›å»ºå¤‡ä»½
echo "åˆ›å»ºå¤‡ä»½..."
mkdir -p $BACKUP_DIR
timestamp=$(date +%Y%m%d_%H%M%S)
cp -r $PROJECT_DIR $BACKUP_DIR/backup_$timestamp

# 2. æ›´æ–°ä»£ç 
echo "æ›´æ–°ä»£ç ..."
cd $PROJECT_DIR
git fetch origin
git checkout $BRANCH
git pull origin $BRANCH

# 3. æ›´æ–°åç«¯ä¾èµ–
echo "æ›´æ–°Pythonä¾èµ–..."
source venv/bin/activate
pip install -r requirements.txt

# 4. æ•°æ®åº“è¿ç§»
echo "æ‰§è¡Œæ•°æ®åº“è¿ç§»..."
alembic upgrade head

# 5. æ„å»ºå‰ç«¯
echo "æ„å»ºå‰ç«¯..."
cd frontend
npm ci --production
npm run build
cd ..

# 6. é‡å¯æœåŠ¡
echo "é‡å¯æœåŠ¡..."
sudo systemctl restart notes-backend
sudo systemctl reload nginx

# 7. å¥åº·æ£€æŸ¥
echo "æ‰§è¡Œå¥åº·æ£€æŸ¥..."
sleep 5
if curl -f http://localhost:8000/health; then
    echo "éƒ¨ç½²æˆåŠŸï¼"
else
    echo "éƒ¨ç½²å¤±è´¥ï¼Œå›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬..."
    sudo systemctl stop notes-backend
    rm -rf $PROJECT_DIR
    mv $BACKUP_DIR/backup_$timestamp $PROJECT_DIR
    sudo systemctl start notes-backend
    exit 1
fi

# 8. æ¸…ç†æ—§å¤‡ä»½
find $BACKUP_DIR -name "backup_*" -mtime +7 -exec rm -rf {} \;

echo "éƒ¨ç½²å®Œæˆï¼"
```

### 10.3 Dockerå®¹å™¨åŒ–éƒ¨ç½²

#### 10.3.1 Dockerfileé…ç½®

**åç«¯Dockerfile**
```dockerfile
# Dockerfile.backend
FROM python:3.11-slim

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    gcc \
    && rm -rf /var/lib/apt/lists/*

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY requirements.txt .

# å®‰è£…Pythonä¾èµ–
RUN pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY . .

# åˆ›å»ºérootç”¨æˆ·
RUN adduser --disabled-password --gecos '' appuser
RUN chown -R appuser:appuser /app
USER appuser

# æš´éœ²ç«¯å£
EXPOSE 8000

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

# å¯åŠ¨å‘½ä»¤
CMD ["gunicorn", "app.main:app", "-c", "gunicorn.conf.py"]
```

**å‰ç«¯Dockerfile**
```dockerfile
# Dockerfile.frontend
# æ„å»ºé˜¶æ®µ
FROM node:18-alpine AS builder

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

# ç”Ÿäº§é˜¶æ®µ
FROM nginx:alpine

# å¤åˆ¶æ„å»ºäº§ç‰©
COPY --from=builder /app/build /usr/share/nginx/html

# å¤åˆ¶Nginxé…ç½®
COPY nginx.conf /etc/nginx/nginx.conf

# æš´éœ²ç«¯å£
EXPOSE 80

# å¯åŠ¨Nginx
CMD ["nginx", "-g", "daemon off;"]
```

#### 10.3.2 Docker Composeé…ç½®

**å¼€å‘ç¯å¢ƒCompose**
```yaml
# docker-compose.dev.yml
version: '3.8'

services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=sqlite:///./notes_dev.db
      - ENVIRONMENT=development
      - DEBUG=true
    volumes:
      - .:/app
      - /app/venv
    command: uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    ports:
      - "3000:3000"
    environment:
      - REACT_APP_API_URL=http://localhost:8000
    volumes:
      - ./frontend:/app
      - /app/node_modules
    command: npm start

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data

volumes:
  redis_data:
```

**ç”Ÿäº§ç¯å¢ƒCompose**
```yaml
# docker-compose.prod.yml
version: '3.8'

services:
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
      - static_files:/var/www/static
    depends_on:
      - backend
      - frontend
    restart: unless-stopped

  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    environment:
      - DATABASE_URL=postgresql://user:password@db:5432/notes_prod
      - ENVIRONMENT=production
      - DEBUG=false
    volumes:
      - static_files:/app/static
    depends_on:
      - db
      - redis
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.frontend
    volumes:
      - static_files:/usr/share/nginx/html
    restart: unless-stopped

  db:
    image: postgres:15
    environment:
      - POSTGRES_DB=notes_prod
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./db/init.sql:/docker-entrypoint-initdb.d/init.sql
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
  static_files:
```

#### 10.3.3 Kuberneteséƒ¨ç½²

**Backend Deployment**
```yaml
# k8s/backend-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: notes-backend
  labels:
    app: notes-backend
spec:
  replicas: 3
  selector:
    matchLabels:
      app: notes-backend
  template:
    metadata:
      labels:
        app: notes-backend
    spec:
      containers:
      - name: backend
        image: notes-app/backend:latest
        ports:
        - containerPort: 8000
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: notes-secrets
              key: database-url
        - name: SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: notes-secrets
              key: secret-key
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 5
          periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: notes-backend-service
spec:
  selector:
    app: notes-backend
  ports:
  - protocol: TCP
    port: 80
    targetPort: 8000
  type: ClusterIP
```

**Frontend Deployment**
```yaml
# k8s/frontend-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: notes-frontend
  labels:
    app: notes-frontend
spec:
  replicas: 2
  selector:
    matchLabels:
      app: notes-frontend
  template:
    metadata:
      labels:
        app: notes-frontend
    spec:
      containers:
      - name: frontend
        image: notes-app/frontend:latest
        ports:
        - containerPort: 80
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"

---
apiVersion: v1
kind: Service
metadata:
  name: notes-frontend-service
spec:
  selector:
    app: notes-frontend
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
  type: ClusterIP
```

### 10.4 ç›‘æ§ä¸æ—¥å¿—ç®¡ç†

#### 10.4.1 åº”ç”¨ç›‘æ§

**å¥åº·æ£€æŸ¥ç«¯ç‚¹**
```python
# app/api/health.py
from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session
from app.database import get_db
from app.core.cache import redis_client
import psutil
from datetime import datetime

router = APIRouter()

@router.get("/health")
async def health_check(db: Session = Depends(get_db)):
    """ç³»ç»Ÿå¥åº·æ£€æŸ¥"""
    health_status = {
        "status": "healthy",
        "timestamp": datetime.utcnow().isoformat(),
        "services": {}
    }
    
    # æ•°æ®åº“è¿æ¥æ£€æŸ¥
    try:
        db.execute("SELECT 1")
        health_status["services"]["database"] = {"status": "healthy"}
    except Exception as e:
        health_status["services"]["database"] = {
            "status": "unhealthy",
            "error": str(e)
        }
        health_status["status"] = "unhealthy"
    
    # Redisè¿æ¥æ£€æŸ¥
    try:
        redis_client.ping()
        health_status["services"]["redis"] = {"status": "healthy"}
    except Exception as e:
        health_status["services"]["redis"] = {
            "status": "unhealthy", 
            "error": str(e)
        }
    
    # ç³»ç»Ÿèµ„æºæ£€æŸ¥
    memory_usage = psutil.virtual_memory().percent
    cpu_usage = psutil.cpu_percent(interval=1)
    disk_usage = psutil.disk_usage('/').percent
    
    health_status["system"] = {
        "memory_usage": memory_usage,
        "cpu_usage": cpu_usage,
        "disk_usage": disk_usage
    }
    
    # èµ„æºä½¿ç”¨ç‡è¿‡é«˜æ—¶æ ‡è®°ä¸ºä¸å¥åº·
    if memory_usage > 90 or cpu_usage > 90 or disk_usage > 90:
        health_status["status"] = "degraded"
    
    return health_status

@router.get("/metrics")
async def get_metrics():
    """Prometheusç›‘æ§æŒ‡æ ‡"""
    # è¿™é‡Œå¯ä»¥é›†æˆprometheus_clientç”ŸæˆæŒ‡æ ‡
    pass
```

**Prometheusé…ç½®**
```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'notes-app'
    static_configs:
      - targets: ['localhost:8000']
    metrics_path: '/metrics'
    scrape_interval: 30s
    
  - job_name: 'nginx'
    static_configs:
      - targets: ['localhost:9113']
```

#### 10.4.2 æ—¥å¿—ç®¡ç†

**ç»“æ„åŒ–æ—¥å¿—é…ç½®**
```python
# app/core/logging.py
import logging
import sys
from datetime import datetime
from typing import Any, Dict
import json

class JSONFormatter(logging.Formatter):
    def format(self, record: logging.LogRecord) -> str:
        log_entry = {
            "timestamp": datetime.utcnow().isoformat(),
            "level": record.levelname,
            "logger": record.name,
            "message": record.getMessage(),
            "module": record.module,
            "function": record.funcName,
            "line": record.lineno,
        }
        
        # æ·»åŠ å¼‚å¸¸ä¿¡æ¯
        if record.exc_info:
            log_entry["exception"] = self.formatException(record.exc_info)
        
        # æ·»åŠ è‡ªå®šä¹‰å­—æ®µ
        if hasattr(record, 'user_id'):
            log_entry["user_id"] = record.user_id
        if hasattr(record, 'request_id'):
            log_entry["request_id"] = record.request_id
        
        return json.dumps(log_entry, ensure_ascii=False)

def setup_logging():
    """é…ç½®åº”ç”¨æ—¥å¿—"""
    # æ ¹æ—¥å¿—å™¨
    root_logger = logging.getLogger()
    root_logger.setLevel(logging.INFO)
    
    # æ§åˆ¶å°å¤„ç†å™¨
    console_handler = logging.StreamHandler(sys.stdout)
    console_handler.setFormatter(JSONFormatter())
    root_logger.addHandler(console_handler)
    
    # æ–‡ä»¶å¤„ç†å™¨
    from logging.handlers import RotatingFileHandler
    file_handler = RotatingFileHandler(
        "logs/app.log",
        maxBytes=10*1024*1024,  # 10MB
        backupCount=5
    )
    file_handler.setFormatter(JSONFormatter())
    root_logger.addHandler(file_handler)
    
    # è®¾ç½®ç¬¬ä¸‰æ–¹åº“æ—¥å¿—çº§åˆ«
    logging.getLogger("uvicorn").setLevel(logging.WARNING)
    logging.getLogger("sqlalchemy.engine").setLevel(logging.WARNING)
```

**è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶**
```python
# app/middleware/logging.py
import time
import uuid
from fastapi import Request, Response
from starlette.middleware.base import BaseHTTPMiddleware
import logging

logger = logging.getLogger(__name__)

class RequestLoggingMiddleware(BaseHTTPMiddleware):
    async def dispatch(self, request: Request, call_next):
        # ç”Ÿæˆè¯·æ±‚ID
        request_id = str(uuid.uuid4())
        request.state.request_id = request_id
        
        # è®°å½•è¯·æ±‚å¼€å§‹
        start_time = time.time()
        
        logger.info(
            "Request started",
            extra={
                "request_id": request_id,
                "method": request.method,
                "url": str(request.url),
                "client_ip": request.client.host,
                "user_agent": request.headers.get("user-agent"),
            }
        )
        
        # å¤„ç†è¯·æ±‚
        try:
            response = await call_next(request)
            
            # è®°å½•è¯·æ±‚å®Œæˆ
            process_time = time.time() - start_time
            logger.info(
                "Request completed",
                extra={
                    "request_id": request_id,
                    "status_code": response.status_code,
                    "process_time": process_time,
                }
            )
            
            response.headers["X-Request-ID"] = request_id
            return response
            
        except Exception as e:
            # è®°å½•è¯·æ±‚é”™è¯¯
            process_time = time.time() - start_time
            logger.error(
                f"Request failed: {str(e)}",
                extra={
                    "request_id": request_id,
                    "process_time": process_time,
                    "error": str(e),
                },
                exc_info=True
            )
            raise
```

**æ—¥å¿—èšåˆé…ç½®**
```yaml
# filebeat.yml
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/notes-app/*.log
  json.keys_under_root: true
  json.add_error_key: true
  fields:
    service: notes-app
    environment: production

output.elasticsearch:
  hosts: ["elasticsearch:9200"]
  index: "notes-app-%{+yyyy.MM.dd}"

setup.template.name: "notes-app"
setup.template.pattern: "notes-app-*"
```

#### 10.4.3 é”™è¯¯è¿½è¸ª

**Sentryé›†æˆ**
```python
# app/core/error_tracking.py
import sentry_sdk
from sentry_sdk.integrations.fastapi import FastApiIntegration
from sentry_sdk.integrations.sqlalchemy import SqlalchemyIntegration
from app.core.config import settings

def setup_sentry():
    if settings.SENTRY_DSN:
        sentry_sdk.init(
            dsn=settings.SENTRY_DSN,
            environment=settings.ENVIRONMENT,
            integrations=[
                FastApiIntegration(auto_enabling_integrations=False),
                SqlalchemyIntegration(),
            ],
            traces_sample_rate=0.1,
            send_default_pii=True,
        )

# è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†
from fastapi import HTTPException
from fastapi.responses import JSONResponse

async def global_exception_handler(request: Request, exc: Exception):
    """å…¨å±€å¼‚å¸¸å¤„ç†å™¨"""
    request_id = getattr(request.state, 'request_id', 'unknown')
    
    if isinstance(exc, HTTPException):
        return JSONResponse(
            status_code=exc.status_code,
            content={
                "error": exc.detail,
                "request_id": request_id,
                "timestamp": datetime.utcnow().isoformat(),
            }
        )
    
    # è®°å½•æœªå¤„ç†çš„å¼‚å¸¸
    logger.error(
        f"Unhandled exception: {str(exc)}",
        extra={"request_id": request_id},
        exc_info=True
    )
    
    # å‘é€åˆ°Sentry
    sentry_sdk.capture_exception(exc)
    
    return JSONResponse(
        status_code=500,
        content={
            "error": "Internal server error",
            "request_id": request_id,
            "timestamp": datetime.utcnow().isoformat(),
        }
    )
```

#### 10.4.4 æ€§èƒ½ç›‘æ§

**APMé›†æˆ**
```python
# app/core/apm.py
from elasticapm.contrib.starlette import ElasticAPM
from app.core.config import settings

def setup_apm(app):
    if settings.ELASTIC_APM_SERVICE_NAME:
        apm_config = {
            'SERVICE_NAME': settings.ELASTIC_APM_SERVICE_NAME,
            'SERVER_URL': settings.ELASTIC_APM_SERVER_URL,
            'ENVIRONMENT': settings.ENVIRONMENT,
            'DEBUG': settings.DEBUG,
        }
        
        ElasticAPM(app, config=apm_config)
```

**æ•°æ®åº“æŸ¥è¯¢ç›‘æ§**
```python
# app/core/db_monitoring.py
import time
from sqlalchemy import event
from sqlalchemy.engine import Engine
import logging

logger = logging.getLogger(__name__)

@event.listens_for(Engine, "before_cursor_execute")
def receive_before_cursor_execute(conn, cursor, statement, parameters, context, executemany):
    context._query_start_time = time.time()

@event.listens_for(Engine, "after_cursor_execute")
def receive_after_cursor_execute(conn, cursor, statement, parameters, context, executemany):
    total = time.time() - context._query_start_time
    
    # è®°å½•æ…¢æŸ¥è¯¢ (è¶…è¿‡100ms)
    if total > 0.1:
        logger.warning(
            f"Slow query detected: {total:.3f}s",
            extra={
                "query": statement,
                "execution_time": total,
                "parameters": parameters,
            }
        )
```

é€šè¿‡è¿™äº›å…¨é¢çš„éƒ¨ç½²å’Œè¿ç»´æ–¹æ¡ˆï¼ŒNotes Applicationèƒ½å¤Ÿï¼š

- **å¼€å‘æ•ˆç‡**ï¼šä¾¿æ·çš„å¼€å‘ç¯å¢ƒé…ç½®å’Œå¯åŠ¨è„šæœ¬
- **ç”Ÿäº§ç¨³å®š**ï¼šå®Œå–„çš„ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å’ŒæœåŠ¡é…ç½®
- **å®¹å™¨åŒ–**ï¼šDockerå’ŒKubernetesæ”¯æŒç°ä»£åŒ–éƒ¨ç½²
- **å¯è§‚æµ‹æ€§**ï¼šå®Œæ•´çš„ç›‘æ§ã€æ—¥å¿—å’Œé”™è¯¯è¿½è¸ªä½“ç³»

è¿™äº›é…ç½®ç¡®ä¿äº†åº”ç”¨åœ¨å„ç§ç¯å¢ƒä¸‹çš„ç¨³å®šè¿è¡Œå’Œé«˜æ•ˆè¿ç»´ã€‚

## 11. é¡¹ç›®æ€»ç»“ä¸æŠ€æœ¯æŒ‡æ ‡

### 11.1 æ¶æ„ç‰¹ç‚¹æ€»ç»“

Notes Applicationé€šè¿‡ç²¾å¿ƒè®¾è®¡çš„æŠ€æœ¯æ¶æ„ï¼Œå®ç°äº†ä»¥ä¸‹å…³é”®ç‰¹æ€§ï¼š

#### 11.1.1 æŠ€æœ¯æ¶æ„ä¼˜åŠ¿
- **å‰åç«¯åˆ†ç¦»**: æ¸…æ™°çš„æ¶æ„è¾¹ç•Œï¼Œæ”¯æŒç‹¬ç«‹å¼€å‘ã€æµ‹è¯•å’Œéƒ¨ç½²
- **æ¨¡å—åŒ–è®¾è®¡**: é«˜å†…èšä½è€¦åˆçš„æ¨¡å—ç»„ç»‡ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•
- **æ ‡å‡†åŒ–æ¥å£**: RESTful APIè®¾è®¡ï¼Œç¡®ä¿è‰¯å¥½çš„äº’æ“ä½œæ€§
- **å“åº”å¼æ¶æ„**: æ”¯æŒä¸åŒè®¾å¤‡å’Œå±å¹•å°ºå¯¸çš„è‰¯å¥½é€‚é…
- **å®¹å™¨åŒ–éƒ¨ç½²**: Dockeræ”¯æŒï¼Œç¡®ä¿ç¯å¢ƒä¸€è‡´æ€§å’Œéƒ¨ç½²ä¾¿åˆ©æ€§

#### 11.1.2 æ€§èƒ½ç‰¹ç‚¹
- **å‰ç«¯ä¼˜åŒ–**: Reactç»„ä»¶æ‡’åŠ è½½ã€è™šæ‹Ÿæ»šåŠ¨ã€çŠ¶æ€ç¼“å­˜
- **åç«¯ä¼˜åŒ–**: æ•°æ®åº“è¿æ¥æ± ã€æŸ¥è¯¢ä¼˜åŒ–ã€å“åº”å‹ç¼©
- **ç½‘ç»œä¼˜åŒ–**: HTTPç¼“å­˜ã€è¯·æ±‚åˆå¹¶ã€CDNæ”¯æŒ
- **æ•°æ®åº“ä¼˜åŒ–**: ç´¢å¼•ç­–ç•¥ã€å…¨æ–‡æœç´¢ã€æŸ¥è¯¢ç¼“å­˜

#### 11.1.3 å®‰å…¨ä¿éšœ
- **å¤šå±‚è¾“å…¥éªŒè¯**: å‰ç«¯è¡¨å•éªŒè¯ + åç«¯Pydanticæ¨¡å‹éªŒè¯
- **XSSé˜²æŠ¤**: å†…å®¹å‡€åŒ–ã€CSPç­–ç•¥ã€è¾“å‡ºç¼–ç 
- **CSRFé˜²æŠ¤**: ä»¤ç‰ŒéªŒè¯ã€SameSite cookies
- **SQLæ³¨å…¥é˜²æŠ¤**: ORMå®‰å…¨å®è·µã€å‚æ•°åŒ–æŸ¥è¯¢

### 11.2 æ ¸å¿ƒåŠŸèƒ½å®ç°

#### 11.2.1 ç¬”è®°ç®¡ç†åŠŸèƒ½
```
åŠŸèƒ½æ¨¡å—           å®ç°æ–¹å¼                    æŠ€æœ¯è¦ç‚¹
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
å¯Œæ–‡æœ¬ç¼–è¾‘         TipTap + ProseMirror        æ‰©å±•æ€§å¼ºã€æ€§èƒ½ä¼˜ç§€
æ‹–æ‹½æ’åº          @dnd-kit                   ç°ä»£åŒ–æ‹–æ‹½ä½“éªŒ
æ–‡ä»¶å¤¹ç®¡ç†         æ ‘å½¢ç»“æ„è®¾è®¡                é€’å½’æŸ¥è¯¢ã€å±‚çº§æ˜¾ç¤º
è‡ªåŠ¨ä¿å­˜          é˜²æŠ– + æœ¬åœ°å­˜å‚¨              æ•°æ®å®‰å…¨ä¿éšœ
å®æ—¶åŒæ­¥          React Query                 ç¼“å­˜å’ŒçŠ¶æ€ç®¡ç†
```

#### 11.2.2 æ•°æ®æµæ¶æ„
```
ç”¨æˆ·æ“ä½œ â†’ Reactç»„ä»¶ â†’ çŠ¶æ€ç®¡ç† â†’ APIè°ƒç”¨ â†’ åç«¯å¤„ç† â†’ æ•°æ®åº“æ“ä½œ
   â†‘                                                      â†“
å“åº”æ›´æ–° â† çŠ¶æ€æ›´æ–° â† ç¼“å­˜æ›´æ–° â† HTTPå“åº” â† ä¸šåŠ¡é€»è¾‘ â† æ•°æ®æŸ¥è¯¢
```

### 11.3 æŠ€æœ¯æŒ‡æ ‡ä¸åŸºå‡†

#### 11.3.1 æ€§èƒ½æŒ‡æ ‡
```
æŒ‡æ ‡ç±»å‹           ç›®æ ‡å€¼              å½“å‰è¡¨ç°           ä¼˜åŒ–æ–¹æ¡ˆ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
é¦–å±åŠ è½½æ—¶é—´       < 2ç§’              1.5ç§’             ä»£ç åˆ†å‰²ã€CDN
APIå“åº”æ—¶é—´        < 200ms            150ms             æ•°æ®åº“ä¼˜åŒ–
é¡µé¢åˆ‡æ¢æ—¶é—´       < 500ms            300ms             è·¯ç”±é¢„åŠ è½½
å†…å­˜ä½¿ç”¨ç‡         < 70%              45%               å†…å­˜æ³„æ¼ç›‘æ§
CPUä½¿ç”¨ç‡          < 60%              35%               ç®—æ³•ä¼˜åŒ–
```

#### 11.3.2 å¯ç”¨æ€§æŒ‡æ ‡
```
æŒ‡æ ‡ç±»å‹           ç›®æ ‡å€¼              ç›‘æ§æ–¹å¼           æ”¹è¿›æªæ–½
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ç³»ç»Ÿå¯ç”¨æ€§         99.9%              å¥åº·æ£€æŸ¥          è´Ÿè½½å‡è¡¡
é”™è¯¯ç‡            < 0.1%             é”™è¯¯ç›‘æ§          å¼‚å¸¸å¤„ç†
æ•°æ®ä¸€è‡´æ€§         100%               äº‹åŠ¡ç®¡ç†          æ•°æ®æ ¡éªŒ
å¤‡ä»½æ¢å¤æ—¶é—´       < 1å°æ—¶            å®šæ—¶å¤‡ä»½          è‡ªåŠ¨åŒ–è„šæœ¬
```

#### 11.3.3 å®‰å…¨æŒ‡æ ‡
```
å®‰å…¨ç»´åº¦           é˜²æŠ¤æªæ–½                     å®ç°çŠ¶æ€           é£é™©ç­‰çº§
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
è¾“å…¥éªŒè¯          å¤šå±‚éªŒè¯ã€å†…å®¹å‡€åŒ–            å·²å®ç°             ä½
ä¼šè¯å®‰å…¨          CSRFé˜²æŠ¤ã€å®‰å…¨cookies        å·²å®ç°             ä½
æ•°æ®ä¼ è¾“          HTTPSã€è¯·æ±‚åŠ å¯†              å·²å®ç°             ä½
æƒé™æ§åˆ¶          ç”¨æˆ·èº«ä»½éªŒè¯ã€èµ„æºæˆæƒ        å¾…å®Œå–„             ä¸­
æ—¥å¿—å®¡è®¡          æ“ä½œæ—¥å¿—ã€è®¿é—®è®°å½•            å·²å®ç°             ä½
```

### 11.4 å¼€å‘æ•ˆç‡ä¸ç»´æŠ¤æ€§

#### 11.4.1 ä»£ç è´¨é‡æŒ‡æ ‡
```
è´¨é‡ç»´åº¦           åº¦é‡æ ‡å‡†                    å½“å‰çŠ¶æ€           æ”¹è¿›è®¡åˆ’
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ä»£ç è¦†ç›–ç‡         > 80%                      85%               å•å…ƒæµ‹è¯•
å¾ªç¯å¤æ‚åº¦         < 10                       8.5               ä»£ç é‡æ„
æ–‡æ¡£è¦†ç›–ç‡         > 90%                      95%               æŒç»­æ›´æ–°
æŠ€æœ¯å€ºåŠ¡          ä½                          ä½                å®šæœŸé‡æ„
```

#### 11.4.2 å¼€å‘å·¥ä½œæµ
```
å¼€å‘é˜¶æ®µ           å·¥å…·æ”¯æŒ                    è‡ªåŠ¨åŒ–ç¨‹åº¦          æ•ˆç‡æå‡
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ç¯å¢ƒæ­å»º          Docker Compose             å®Œå…¨è‡ªåŠ¨åŒ–          90%
ä»£ç æ£€æŸ¥          ESLint + Prettier          è‡ªåŠ¨åŒ–             80%
æµ‹è¯•æ‰§è¡Œ          Jest + pytest              è‡ªåŠ¨åŒ–             85%
æ„å»ºéƒ¨ç½²          CI/CD Pipeline             è‡ªåŠ¨åŒ–             95%
ç›‘æ§è¿ç»´          Prometheus + Grafana       åŠè‡ªåŠ¨åŒ–           70%
```

### 11.5 å¯æ‰©å±•æ€§è®¾è®¡

#### 11.5.1 æ°´å¹³æ‰©å±•èƒ½åŠ›
- **æ— çŠ¶æ€è®¾è®¡**: åç«¯APIæœåŠ¡æ”¯æŒå¤šå®ä¾‹éƒ¨ç½²
- **æ•°æ®åº“åˆ†ç¦»**: æ”¯æŒç‹¬ç«‹çš„æ•°æ®åº“æœåŠ¡å™¨
- **ç¼“å­˜ç­–ç•¥**: Redisé›†ç¾¤æ”¯æŒ
- **è´Ÿè½½å‡è¡¡**: Nginxåå‘ä»£ç†æ”¯æŒ

#### 11.5.2 åŠŸèƒ½æ‰©å±•ç‚¹
```
æ‰©å±•æ–¹å‘           æŠ€æœ¯æ–¹æ¡ˆ                    å®ç°éš¾åº¦           é¢„æœŸæ”¶ç›Š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
å¤šç”¨æˆ·æ”¯æŒ         ç”¨æˆ·è®¤è¯ç³»ç»Ÿ                ä¸­ç­‰               é«˜
åä½œç¼–è¾‘          WebSocket + OTç®—æ³•          é«˜                 é«˜
ç§»åŠ¨ç«¯é€‚é…         PWA + å“åº”å¼è®¾è®¡            ä½                 ä¸­
æ–‡ä»¶ä¸Šä¼           å¯¹è±¡å­˜å‚¨é›†æˆ                ä½                 ä¸­
å…¨æ–‡æœç´¢          Elasticsearché›†æˆ           ä¸­ç­‰               é«˜
æ•°æ®åˆ†æ          BIå·¥å…·é›†æˆ                  ä¸­ç­‰               ä¸­
```

### 11.6 æŠ€æœ¯æ ˆæ¼”è¿›è§„åˆ’

#### 11.6.1 çŸ­æœŸä¼˜åŒ–ï¼ˆ3-6ä¸ªæœˆï¼‰
- **æ€§èƒ½ä¼˜åŒ–**: å®ç°æœåŠ¡ç«¯æ¸²æŸ“(SSR)æå‡é¦–å±æ€§èƒ½
- **ç§»åŠ¨ä¼˜åŒ–**: PWAæ”¯æŒï¼Œæä¾›åŸç”Ÿåº”ç”¨ä½“éªŒ
- **æœç´¢å¢å¼º**: å…¨æ–‡æœç´¢åŠŸèƒ½ä¼˜åŒ–
- **ç›‘æ§å®Œå–„**: APMå·¥å…·é›†æˆï¼Œå®Œå–„æ€§èƒ½ç›‘æ§

#### 11.6.2 ä¸­æœŸè§„åˆ’ï¼ˆ6-12ä¸ªæœˆï¼‰
- **å¾®æœåŠ¡æ¶æ„**: æ‹†åˆ†ä¸ºç‹¬ç«‹çš„å¾®æœåŠ¡
- **æ•°æ®åº“å‡çº§**: è¿ç§»åˆ°PostgreSQL
- **ç¼“å­˜å±‚**: Redisé›†ç¾¤éƒ¨ç½²
- **CI/CD**: å®Œå–„è‡ªåŠ¨åŒ–éƒ¨ç½²æµç¨‹

#### 11.6.3 é•¿æœŸæ„¿æ™¯ï¼ˆ1-2å¹´ï¼‰
- **äº‘åŸç”Ÿ**: Kubernetesé›†ç¾¤éƒ¨ç½²
- **å¤šç§Ÿæˆ·**: SaaSæ¨¡å¼æ”¯æŒ
- **AIé›†æˆ**: æ™ºèƒ½æ¨èå’Œå†…å®¹åˆ†æ
- **å›½é™…åŒ–**: å¤šè¯­è¨€æ”¯æŒ

### 11.7 ç»éªŒæ€»ç»“

#### 11.7.1 æŠ€æœ¯é€‰å‹ç»éªŒ
- **é€‰æ‹©æˆç†ŸæŠ€æœ¯**: ä¼˜å…ˆé€‰æ‹©ç¤¾åŒºæ´»è·ƒã€æ–‡æ¡£å®Œå–„çš„æŠ€æœ¯æ ˆ
- **å¹³è¡¡å¤æ‚åº¦**: åœ¨åŠŸèƒ½éœ€æ±‚å’Œå®ç°å¤æ‚åº¦ä¹‹é—´æ‰¾åˆ°å¹³è¡¡ç‚¹
- **è€ƒè™‘æ‰©å±•æ€§**: ä¸ºæœªæ¥çš„åŠŸèƒ½æ‰©å±•é¢„ç•™æ¶æ„ç©ºé—´
- **æ³¨é‡å¼€å‘ä½“éªŒ**: é€‰æ‹©èƒ½æå‡å¼€å‘æ•ˆç‡çš„å·¥å…·å’Œæ¡†æ¶

#### 11.7.2 æ¶æ„è®¾è®¡ç»éªŒ
- **åˆ†å±‚æ¸…æ™°**: æ˜ç¡®çš„åˆ†å±‚æ¶æ„ä¾¿äºä»£ç ç»´æŠ¤
- **æ¥å£æ ‡å‡†**: ç»Ÿä¸€çš„APIè®¾è®¡è§„èŒƒæå‡å¼€å‘æ•ˆç‡
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶æå‡ç”¨æˆ·ä½“éªŒ
- **æ€§èƒ½ä¼˜å…ˆ**: åœ¨è®¾è®¡é˜¶æ®µå°±è€ƒè™‘æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

#### 11.7.3 å¼€å‘å®è·µç»éªŒ
- **æµ‹è¯•å…ˆè¡Œ**: TDD/BDDæå‡ä»£ç è´¨é‡
- **ä»£ç å®¡æŸ¥**: å›¢é˜Ÿåä½œä¸­çš„è´¨é‡ä¿éšœ
- **æ–‡æ¡£é©±åŠ¨**: å®Œå–„çš„æ–‡æ¡£æ˜¯é¡¹ç›®æˆåŠŸçš„å…³é”®
- **æŒç»­é›†æˆ**: è‡ªåŠ¨åŒ–æµç¨‹å‡å°‘äººä¸ºé”™è¯¯

### 11.8 èµ„æºå‚è€ƒ

#### 11.8.1 å®˜æ–¹æ–‡æ¡£
- [React å®˜æ–¹æ–‡æ¡£](https://react.dev/)
- [FastAPI å®˜æ–¹æ–‡æ¡£](https://fastapi.tiangolo.com/)
- [TipTap ç¼–è¾‘å™¨æ–‡æ¡£](https://tiptap.dev/)
- [Material-UI ç»„ä»¶æ–‡æ¡£](https://mui.com/)

#### 11.8.2 æŠ€æœ¯åšå®¢
- [å‰ç«¯æ¶æ„è®¾è®¡æœ€ä½³å®è·µ](https://example.com/frontend-architecture)
- [Python Webå¼€å‘æŒ‡å—](https://example.com/python-web-guide)
- [æ•°æ®åº“è®¾è®¡æ¨¡å¼](https://example.com/database-patterns)
- [å®¹å™¨åŒ–éƒ¨ç½²å®è·µ](https://example.com/docker-deployment)

#### 11.8.3 å¼€æºé¡¹ç›®
- [TipTap Editor Examples](https://github.com/ueberdosis/tiptap/tree/main/demos)
- [React Best Practices](https://github.com/facebook/react/tree/main/packages)
- [FastAPI Examples](https://github.com/tiangolo/fastapi/tree/master/docs_src)

---

**é¡¹ç›®ç»Ÿè®¡ä¿¡æ¯**:
- æ–‡æ¡£æ€»è¡Œæ•°: 7,000+ è¡Œ
- ä»£ç ç¤ºä¾‹: 150+ ä¸ª
- æŠ€æœ¯æ ˆè¦†ç›–: 25+ é¡¹æŠ€æœ¯
- æ¶æ„å›¾è¡¨: 10+ ä¸ª
- é…ç½®ç¤ºä¾‹: 30+ ä¸ª

**ç»´æŠ¤çŠ¶æ€**: æœ¬æ–‡æ¡£ä¿æŒæŒç»­æ›´æ–°ï¼Œåæ˜ é¡¹ç›®æ¶æ„çš„æœ€æ–°å˜åŒ–å’ŒæŠ€æœ¯æ¼”è¿›ã€‚

**è´¡çŒ®æŒ‡å—**: æ¬¢è¿æäº¤Issueæˆ–Pull Requestæ¥å®Œå–„æ–‡æ¡£å†…å®¹ï¼Œå…±åŒæ„å»ºæ›´å¥½çš„æŠ€æœ¯æ–‡æ¡£ã€‚
