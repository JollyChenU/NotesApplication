#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
å®é™…æµ‹è¯•AIä¼˜åŒ–æµç¨‹ï¼Œå¹¶æ£€æŸ¥æ•°æ®åº“ç»“æœ
"""

import requests
import json
import sqlite3

# æµ‹è¯•å†…å®¹ - ä½ æä¾›çš„"AIä¼˜åŒ–é¢„è§ˆå†…å®¹"
test_content = """## CoTï¼ˆChain of Thoughtï¼Œæ€ç»´é“¾ï¼‰æ¦‚è¿°

CoTï¼ˆChain of Thoughtï¼Œæ€ç»´é“¾ï¼‰æ˜¯ä¸€ç§ç”¨äºå¢å¼ºå¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰æ¨ç†èƒ½åŠ›çš„æŠ€æœ¯ï¼Œé€šè¿‡ç”Ÿæˆä¸­é—´é€»è¾‘æ­¥éª¤æ¥æ¨¡æ‹Ÿäººç±»è§£å†³å¤æ‚é—®é¢˜çš„æ€ç»´è¿‡ç¨‹ã€‚å…¶æ ¸å¿ƒåœ¨äºå°†å¤æ‚ä»»åŠ¡åˆ†è§£ä¸ºä¸€ç³»åˆ—è¿è´¯çš„å­æ­¥éª¤ï¼Œæœ€ç»ˆæ¨å¯¼å‡ºç­”æ¡ˆï¼Œä»è€Œæå‡æ¨¡å‹åœ¨æ•°å­¦ã€é€»è¾‘æ¨ç†ç­‰ä»»åŠ¡ä¸­çš„è¡¨ç°ã€‚

### æ ¸å¿ƒç‰¹ç‚¹

- **é€»è¾‘åˆ†è§£**ï¼šè¦æ±‚æ¨¡å‹è¾“å‡ºä»é—®é¢˜åˆ°ç­”æ¡ˆçš„å®Œæ•´æ¨ç†é“¾æ¡ï¼Œè€Œéç›´æ¥ç»™å‡ºç»“æœã€‚ä¾‹å¦‚ï¼Œåœ¨æ•°å­¦é¢˜ä¸­åˆ†æ­¥å±•ç¤ºè®¡ç®—è¿‡ç¨‹ã€‚
- **å¤šåœºæ™¯åº”ç”¨**ï¼šå¹¿æ³›åº”ç”¨äºè‡ªç„¶è¯­è¨€å¤„ç†ï¼ˆNLPï¼‰ã€å…³ç³»æ¨ç†ç­‰é¢†åŸŸï¼Œå°¤å…¶åœ¨éœ€è¦å¤šæ­¥æ¨å¯¼çš„ä»»åŠ¡ä¸­æ•ˆæœæ˜¾è‘—ã€‚
- **æŠ€æœ¯ä¼˜åŠ¿**ï¼šç›¸æ¯”ä¼ ç»Ÿæç¤ºæ–¹æ³•ï¼ŒCoTèƒ½æ›´æ¸…æ™°åœ°æš´éœ²æ¨¡å‹çš„æ¨ç†ç¼ºé™·ï¼Œä¾¿äºè°ƒè¯•ä¼˜åŒ–ï¼ŒåŒæ—¶æå‡ç­”æ¡ˆçš„å¯è§£é‡Šæ€§ã€‚

æ­¤å¤–ï¼ŒCoTåœ¨æ•°å­¦ä¸­ä¹ŸæŒ‡ä»£ä½™åˆ‡å‡½æ•°ï¼ˆcotangentï¼‰ï¼Œä½†åœ¨äººå·¥æ™ºèƒ½é¢†åŸŸæ›´å¸¸ç”¨å…¶ä½œä¸º"æ€ç»´é“¾"çš„ç¼©å†™ã€‚

---

## CoTåœ¨LLMä¸­çš„å®ç°æ–¹å¼

### 1. æç¤ºè®¾è®¡ï¼ˆPromptingï¼‰

- **æ˜¾å¼è¦æ±‚ä¸­é—´æ­¥éª¤**ï¼šåœ¨æç¤ºä¸­æ˜ç¡®è¦æ±‚æ¨¡å‹è¾“å‡ºä»é—®é¢˜åˆ°ç­”æ¡ˆçš„å®Œæ•´æ¨ç†é“¾æ¡ï¼Œè€Œéç›´æ¥ç»™å‡ºç»“æœã€‚ä¾‹å¦‚ï¼Œåœ¨æ•°å­¦é¢˜ä¸­åˆ†æ­¥å±•ç¤ºè®¡ç®—è¿‡ç¨‹ï¼Œæˆ–åœ¨é€»è¾‘æ¨ç†ä¸­é€æ­¥åˆ†ææ¡ä»¶ã€‚
- **ç¤ºä¾‹å¼•å¯¼**ï¼šé€šè¿‡æä¾›å¸¦æœ‰è¯¦ç»†æ¨ç†æ­¥éª¤çš„ç¤ºä¾‹ï¼ˆå¦‚Few-shot Learningï¼‰ï¼Œå¼•å¯¼æ¨¡å‹å­¦ä¹ å¦‚ä½•åˆ†è§£å¤æ‚ä»»åŠ¡ã€‚ä¾‹å¦‚ï¼Œç»™æ¨¡å‹å±•ç¤º"é—®é¢˜â†’åˆ†æ­¥æ¨ç†â†’ç­”æ¡ˆ"çš„æ ·ä¾‹ï¼Œä½¿å…¶æ¨¡ä»¿ç”Ÿæˆç±»ä¼¼çš„æ€ç»´é“¾ã€‚

### 2. è®­ç»ƒç­–ç•¥

- **ç›‘ç£å¾®è°ƒï¼ˆSFTï¼‰**ï¼šä½¿ç”¨åŒ…å«æ¨ç†æ­¥éª¤çš„æ•°æ®é›†å¯¹æ¨¡å‹è¿›è¡Œå¾®è°ƒã€‚ä¾‹å¦‚ï¼Œé€šè¿‡äººå·¥æ ‡æ³¨æˆ–è‡ªåŠ¨ç”Ÿæˆçš„"é—®é¢˜-ä¸­é—´æ­¥éª¤-ç­”æ¡ˆ"ä¸‰å…ƒç»„ï¼Œè®­ç»ƒæ¨¡å‹ç”Ÿæˆè¿è´¯çš„æ¨ç†è·¯å¾„ã€‚
- **å¼ºåŒ–å­¦ä¹ **ï¼šç»“åˆå¥–åŠ±æ¨¡å‹è¯„ä¼°æ¨ç†æ­¥éª¤çš„é€»è¾‘æ€§å’Œæ­£ç¡®æ€§ï¼Œä¼˜åŒ–ç”Ÿæˆç­–ç•¥ã€‚ä¾‹å¦‚ï¼Œå¯¹ç”Ÿæˆçš„æ€ç»´é“¾è´¨é‡ï¼ˆå¦‚æ­¥éª¤åˆç†æ€§ã€æœ€ç»ˆç­”æ¡ˆå‡†ç¡®æ€§ï¼‰è¿›è¡Œæ‰“åˆ†ï¼Œå¹¶åé¦ˆè‡³æ¨¡å‹è®­ç»ƒã€‚

### 3. æ¨¡å‹æ¶æ„æ‰©å±•

- **å¤šæ­¥è§£ç **ï¼šå°†æ¨¡å‹è¾“å‡ºåˆ†ä¸º"æ¨ç†é˜¶æ®µ"å’Œ"ç­”æ¡ˆé˜¶æ®µ"ï¼Œå…ˆç”Ÿæˆä¸­é—´æ­¥éª¤ï¼Œå†åŸºäºæ­¥éª¤æ¨å¯¼ç»“è®ºã€‚ä¾‹å¦‚ï¼Œå…ˆç”Ÿæˆ"å‡è®¾Aâ†’éªŒè¯Bâ†’æ’é™¤C"çš„é€»è¾‘é“¾ï¼Œå†è¾“å‡ºæœ€ç»ˆç­”æ¡ˆã€‚
- **æ€ç»´æ ‘ï¼ˆToTï¼‰ä¸æ€ç»´å›¾ï¼ˆGoTï¼‰**ï¼šæ”¹è¿›CoTçš„å•ä¸€é“¾å¼ç»“æ„ï¼Œå¼•å…¥åˆ†æ”¯å†³ç­–ï¼ˆToTï¼‰æˆ–å¾ªç¯ä¾èµ–ï¼ˆGoTï¼‰ï¼Œæ”¯æŒæ›´å¤æ‚çš„å¤šè·¯å¾„æ¨ç†ã€‚ä¾‹å¦‚ï¼Œåœ¨ä»£ç ç”Ÿæˆä»»åŠ¡ä¸­ï¼Œé€šè¿‡å¤šåˆ†æ”¯å°è¯•ä¸åŒç®—æ³•æ–¹æ¡ˆå¹¶é€‰æ‹©æœ€ä¼˜è§£ã€‚

### 4. ä¼˜åŒ–ä¸éªŒè¯

- **è‡ªæˆ‘ä¸€è‡´æ€§ï¼ˆSelf-consistencyï¼‰**ï¼šç”Ÿæˆå¤šä¸ªç‹¬ç«‹æ¨ç†é“¾ï¼Œé€šè¿‡æŠ•ç¥¨æˆ–äº¤å‰éªŒè¯é€‰æ‹©æœ€ä¸€è‡´çš„ç­”æ¡ˆã€‚ä¾‹å¦‚ï¼Œå¯¹åŒä¸€é—®é¢˜ç”Ÿæˆ3æ¡ä¸åŒçš„è§£æ³•ï¼Œé€‰å–å¤šæ•°ç›¸åŒçš„ç»“è®ºã€‚
- **é•¿é“¾æ¨ç†æŠ€æœ¯ï¼ˆLong CoTï¼‰**ï¼šé’ˆå¯¹éœ€è¦æ·±åº¦æ¨ç†çš„ä»»åŠ¡ï¼ˆå¦‚å¤æ‚æ•°å­¦è¯æ˜ï¼‰ï¼Œä¼˜åŒ–æ¨¡å‹è®°å¿†å’Œæ³¨æ„åŠ›æœºåˆ¶ï¼Œæ”¯æŒæ›´é•¿çš„æ¨ç†æ­¥éª¤ï¼ˆå¦‚æ•°ç™¾æ­¥ï¼‰ã€‚

---

## å®ç°æ•ˆæœä¸æŒ‘æˆ˜

### ä¼˜åŠ¿

- CoTæ˜¾è‘—æå‡LLMåœ¨ç®—æœ¯ã€é€»è¾‘ã€ä»£ç ç”Ÿæˆç­‰ä»»åŠ¡ä¸Šçš„å‡†ç¡®æ€§ï¼Œå¹¶å¢å¼ºç»“æœçš„å¯è§£é‡Šæ€§ã€‚

### å±€é™æ€§

- å¯¹ç®€å•ä»»åŠ¡å¯èƒ½å¼•å…¥å†—ä½™è®¡ç®—ï¼Œä¸”ä¾èµ–é«˜è´¨é‡çš„æ¨ç†é“¾æ•°æ®ã€‚

---

## æ€»ç»“

é€šè¿‡ä¸Šè¿°æ–¹æ³•ï¼ŒCoTä½¿LLMèƒ½å¤Ÿæ¨¡æ‹Ÿäººç±»è§£å†³å¤æ‚é—®é¢˜çš„æ€ç»´è¿‡ç¨‹ï¼Œä»è€Œæå‡å…¶æ¨ç†èƒ½åŠ›å’Œåº”ç”¨èŒƒå›´ã€‚"""

def test_ai_optimization_api():
    """æµ‹è¯•å®é™…çš„AIä¼˜åŒ–APIè°ƒç”¨"""
    
    print("=" * 80)
    print("æµ‹è¯•AIä¼˜åŒ–APIè°ƒç”¨å’Œæ•°æ®åº“å­˜å‚¨")
    print("=" * 80)
    
    # 1. æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
    try:
        health_response = requests.get("http://localhost:5000/api/health")
        print(f"âœ… æœåŠ¡å™¨å¥åº·çŠ¶æ€: {health_response.status_code}")
    except:
        print("âŒ æœåŠ¡å™¨æœªå¯åŠ¨ï¼Œè¯·å…ˆå¯åŠ¨åç«¯æœåŠ¡å™¨")
        return
    
    # 2. è·å–æ–‡ä»¶åˆ—è¡¨
    try:
        files_response = requests.get("http://localhost:5000/api/files")
        files_data = files_response.json()
        print(f"âœ… è·å–æ–‡ä»¶åˆ—è¡¨æˆåŠŸï¼Œå…±{len(files_data)}ä¸ªæ–‡ä»¶")
        
        if not files_data:
            print("âŒ æ²¡æœ‰å¯ç”¨çš„æ–‡ä»¶è¿›è¡Œæµ‹è¯•")
            return
            
        file_id = files_data[0]['id']
        print(f"ğŸ“ ä½¿ç”¨æ–‡ä»¶ID: {file_id}")
        
    except Exception as e:
        print(f"âŒ è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥: {e}")
        return
    
    # 3. è·å–ä¼˜åŒ–å‰çš„ç¬”è®°æ•°é‡
    try:
        notes_response = requests.get(f"http://localhost:5000/api/files/{file_id}/notes")
        original_notes = notes_response.json()
        print(f"ğŸ“ ä¼˜åŒ–å‰ç¬”è®°æ•°é‡: {len(original_notes)}")
        
        # æ˜¾ç¤ºå‰å‡ ä¸ªç¬”è®°çš„å†…å®¹
        for i, note in enumerate(original_notes[:3]):
            print(f"   ç¬”è®°{i+1} (order={note.get('order', 'N/A')}): {note['content'][:50]}...")
            
    except Exception as e:
        print(f"âŒ è·å–åŸå§‹ç¬”è®°å¤±è´¥: {e}")
        return
    
    # 4. è°ƒç”¨AIä¼˜åŒ–API
    print(f"\nğŸ¤– å¼€å§‹è°ƒç”¨AIä¼˜åŒ–API...")
    try:
        apply_response = requests.post(
            f"http://localhost:5000/api/ai/apply-optimization",
            headers={'Content-Type': 'application/json'},
            json={
                'file_id': file_id,
                'optimized_content': test_content,
                'backup_original': True
            }
        )
        
        if apply_response.status_code != 200:
            print(f"âŒ AIä¼˜åŒ–APIè°ƒç”¨å¤±è´¥: {apply_response.status_code}")
            print(f"å“åº”å†…å®¹: {apply_response.text}")
            return
            
        apply_result = apply_response.json()
        print(f"âœ… AIä¼˜åŒ–APIè°ƒç”¨æˆåŠŸ")
        print(f"   åŸå§‹ç¬”è®°æ•°: {apply_result.get('original_notes_count', 'N/A')}")
        print(f"   æ–°ç¬”è®°æ•°: {apply_result.get('new_notes_count', 'N/A')}")
        
    except Exception as e:
        print(f"âŒ AIä¼˜åŒ–APIè°ƒç”¨å¼‚å¸¸: {e}")
        return
    
    # 5. æ£€æŸ¥ä¼˜åŒ–åçš„ç¬”è®°
    try:
        new_notes_response = requests.get(f"http://localhost:5000/api/files/{file_id}/notes")
        new_notes = new_notes_response.json()
        print(f"\nğŸ“ ä¼˜åŒ–åç¬”è®°æ•°é‡: {len(new_notes)}")
        
        # æ£€æŸ¥ç¬¬ä¸€èŠ‚æ˜¯å¦å­˜åœ¨
        first_section_found = False
        for i, note in enumerate(new_notes):
            content = note['content']
            order = note.get('order', 'N/A')
            print(f"   ç¬”è®°{i+1} (order={order}): {content[:50]}...")
            
            if "CoTï¼ˆChain of Thoughtï¼Œæ€ç»´é“¾ï¼‰æ¦‚è¿°" in content:
                first_section_found = True
                print(f"   âœ… æ‰¾åˆ°ç¬¬ä¸€èŠ‚æ ‡é¢˜åœ¨ç¬”è®°{i+1}")
        
        if not first_section_found:
            print("   âŒ ç¬¬ä¸€èŠ‚æ ‡é¢˜ä¸¢å¤±ï¼")
        
    except Exception as e:
        print(f"âŒ è·å–ä¼˜åŒ–åç¬”è®°å¤±è´¥: {e}")
        return
    
    # 6. ç›´æ¥æŸ¥è¯¢æ•°æ®åº“
    print(f"\nğŸ—„ï¸ ç›´æ¥æŸ¥è¯¢æ•°æ®åº“...")
    try:
        conn = sqlite3.connect('notes.db')
        cursor = conn.cursor()
        
        cursor.execute("""
            SELECT id, substr(content, 1, 100), [order] 
            FROM notes 
            WHERE file_id = ? 
            ORDER BY [order]
        """, (file_id,))
        
        db_notes = cursor.fetchall()
        print(f"æ•°æ®åº“ä¸­çš„ç¬”è®°æ•°é‡: {len(db_notes)}")
        
        db_first_section_found = False
        for note_id, content, order in db_notes:
            print(f"   ID={note_id}, order={order}: {content}...")
            if "CoTï¼ˆChain of Thoughtï¼Œæ€ç»´é“¾ï¼‰æ¦‚è¿°" in content:
                db_first_section_found = True
                print(f"   âœ… æ•°æ®åº“ä¸­æ‰¾åˆ°ç¬¬ä¸€èŠ‚æ ‡é¢˜ (ID={note_id}, order={order})")
        
        if not db_first_section_found:
            print("   âŒ æ•°æ®åº“ä¸­ç¬¬ä¸€èŠ‚æ ‡é¢˜ä¸¢å¤±ï¼")
        
        conn.close()
        
    except Exception as e:
        print(f"âŒ æ•°æ®åº“æŸ¥è¯¢å¤±è´¥: {e}")
    
    print("\n" + "=" * 80)

if __name__ == "__main__":
    test_ai_optimization_api()
